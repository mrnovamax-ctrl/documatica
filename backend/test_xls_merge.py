"""
–¢–µ—Å—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞ –£–ü–î –≤ XLS —Å –Ω–∞—Å—Ç–æ—è—â–∏–º–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–º–∏ —è—á–µ–π–∫–∞–º–∏ —á–µ—Ä–µ–∑ xlwt
"""

import sys
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ backend –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π
sys.path.insert(0, str(Path(__file__).parent))

from app.services.excel_export import ExcelExportService
from io import BytesIO

# –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –£–ü–î
test_upd_data = {
    'document_number': '125',
    'document_date': '18.01.2026',
    'status': '1',
    'seller': {
        'name': '–û–û–û "–¢–µ—Å—Ç–æ–≤–∞—è –ö–æ–º–ø–∞–Ω–∏—è"',
        'inn': '7701234567',
        'kpp': '770101001',
        'address': '–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –¢–µ—Å—Ç–æ–≤–∞—è, –¥. 1'
    },
    'buyer': {
        'name': '–û–û–û "–ü–æ–∫—É–ø–∞—Ç–µ–ª—å"',
        'inn': '7709876543',
        'kpp': '770901001',
        'address': '–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –ü–æ–∫—É–ø–∞—Ç–µ–ª—å—Å–∫–∞—è, –¥. 2'
    },
    'items': [
        {
            'product_code': '12345',
            'name': '–£—Å–ª—É–≥–∏ –ø–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è',
            'unit_code': '796',
            'unit_name': '—à—Ç',
            'quantity': 1.0,
            'price': 100000.00,
            'amount_without_vat': 100000.00,
            'vat_rate': '20%',
            'vat_amount': 20000.00,
            'amount_with_vat': 120000.00,
            'country_name': '–†–æ—Å—Å–∏—è',
            'customs_declaration': ''
        },
        {
            'product_code': '67890',
            'name': '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏',
            'unit_code': '796',
            'unit_name': '—à—Ç',
            'quantity': 5.0,
            'price': 5000.00,
            'amount_without_vat': 25000.00,
            'vat_rate': '20%',
            'vat_amount': 5000.00,
            'amount_with_vat': 30000.00,
            'country_name': '–†–æ—Å—Å–∏—è',
            'customs_declaration': ''
        }
    ],
    'total_amount_without_vat': 125000.00,
    'total_vat_amount': 25000.00,
    'total_amount_with_vat': 150000.00,
    'seller_signer': {
        'title': '–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä',
        'name': '–ò–≤–∞–Ω–æ–≤ –ò.–ò.'
    },
    'buyer_signer': {
        'title': '–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä',
        'name': '–ü–µ—Ç—Ä–æ–≤ –ü.–ü.'
    }
}

def test_xls_export():
    """–¢–µ—Å—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞ –£–ü–î –≤ XLS —Å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–º–∏ —è—á–µ–π–∫–∞–º–∏"""
    
    print("=" * 60)
    print("–¢–ï–°–¢ –≠–ö–°–ü–û–†–¢–ê –£–ü–î –í XLS –° –û–ë–™–ï–î–ò–ù–ï–ù–ù–´–ú–ò –Ø–ß–ï–ô–ö–ê–ú–ò (xlwt)")
    print("=" * 60)
    print()
    
    # –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–∏—Å —ç–∫—Å–ø–æ—Ä—Ç–∞
    service = ExcelExportService()
    
    try:
        # –í—ã–∑—ã–≤–∞–µ–º –º–µ—Ç–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è XLS
        print("üìù –°–æ–∑–¥–∞–µ–º XLS —Ñ–∞–π–ª —Å –Ω–∞—Å—Ç–æ—è—â–∏–º–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–º–∏ —è—á–µ–π–∫–∞–º–∏...")
        buffer = service._create_xls_from_upd_data(test_upd_data)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ buffer –Ω–µ –ø—É—Å—Ç–æ–π
        buffer.seek(0, 2)  # –ü–µ—Ä–µ–º–µ—â–∞–µ–º—Å—è –≤ –∫–æ–Ω–µ—Ü
        size = buffer.tell()
        buffer.seek(0)  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –Ω–∞—á–∞–ª–æ
        
        print(f"‚úÖ XLS —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!")
        print(f"üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {size} –±–∞–π—Ç ({size / 1024:.2f} KB)")
        print()
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        output_path = Path(__file__).parent / "test_upd_xlwt_output.xls"
        with open(output_path, 'wb') as f:
            f.write(buffer.read())
        
        print(f"üíæ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {output_path}")
        print()
        print("üîç –ü–†–û–í–ï–†–¨–¢–ï –§–ê–ô–õ –í EXCEL:")
        print("   1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª –≤ Microsoft Excel –∏–ª–∏ LibreOffice Calc")
        print("   2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —è—á–µ–π–∫–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã:")
        print("      - –ó–∞–≥–æ–ª–æ–≤–æ–∫ '–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–¥–∞—Ç–æ—á–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç' (A1:D3)")
        print("      - –ù–æ–º–µ—Ä –∏ –¥–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (E1:N1)")
        print("      - –†–µ–∫–≤–∏–∑–∏—Ç—ã –ø—Ä–æ–¥–∞–≤—Ü–∞ –∏ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è (–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –≤ —Å—Ç—Ä–æ–∫–∞—Ö)")
        print("      - –®–∞–ø–∫–∞ —Ç–∞–±–ª–∏—Ü—ã —Ç–æ–≤–∞—Ä–æ–≤ (–º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è)")
        print("      - –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ '–í—Å–µ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ' (A:G)")
        print("      - –ë–ª–æ–∫–∏ –ø–æ–¥–ø–∏—Å–µ–π (–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è)")
        print()
        print("‚úÖ –ï–°–õ–ò –í–°–ï –Ø–ß–ï–ô–ö–ò –û–ë–™–ï–î–ò–ù–ï–ù–´ - –¢–ï–°–¢ –ü–†–û–®–ï–õ –£–°–ü–ï–®–ù–û!")
        print()
        
        return True
        
    except Exception as e:
        print(f"‚ùå –û–®–ò–ë–ö–ê –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ XLS: {str(e)}")
        import traceback
        traceback.print_exc()
        return False

if __name__ == '__main__':
    success = test_xls_export()
    sys.exit(0 if success else 1)
