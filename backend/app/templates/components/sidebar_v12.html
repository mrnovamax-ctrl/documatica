<!-- Sidebar v12.0 - Professional Engineering Style -->
<aside class="sidebar-v12">
  <!-- Logo -->
  <a href="/dashboard/" class="sidebar-logo-v12" style="text-decoration: none; color: inherit;">
    <div class="sidebar-logo-icon-v12">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <path d="M4 6h16M4 12h16M4 18h10" stroke="#3b82f6" stroke-width="2.5" stroke-linecap="round"/>
        <circle cx="20" cy="18" r="3" fill="#FBBF24"/>
      </svg>
    </div>
    <span class="sidebar-logo-text-v12">
      <span class="logo-bold">docu</span><span class="logo-light">matica</span>
    </span>
  </a>
  
  <!-- Navigation -->
  <nav class="sidebar-nav-v12">
    <!-- Main Section -->
    <div class="sidebar-section-v12">
      <span class="sidebar-section-label-v12">Основное управление</span>
      <ul>
        <li>
          <a href="/dashboard/" class="sidebar-link-v12 {% if active_menu == 'dashboard' %}active{% endif %}">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            <span>Дашборд</span>
          </a>
        </li>
        <li>
          <a href="/dashboard/documents/" class="sidebar-link-v12 {% if active_menu == 'documents' %}active{% endif %}">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
            </svg>
            <span>Документы</span>
          </a>
        </li>
        <li>
          <a href="/dashboard/templates/" class="sidebar-link-v12 {% if active_menu == 'templates' %}active{% endif %}">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="3" y1="9" x2="21" y2="9"></line>
              <line x1="9" y1="21" x2="9" y2="9"></line>
            </svg>
            <span>Шаблоны</span>
          </a>
        </li>
      </ul>
    </div>
    
    <!-- Directory Section -->
    <div class="sidebar-section-v12">
      <span class="sidebar-section-label-v12">Конструкторы</span>
      <ul>
        <li>
          <a href="/dashboard/upd/create/" class="sidebar-link-v12 {% if active_menu == 'upd-create' %}active{% endif %}">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
            </svg>
            <span>УПД</span>
          </a>
        </li>
        <li>
          <a href="/dashboard/invoice/create/" class="sidebar-link-v12 {% if active_menu == 'invoice' %}active{% endif %}">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
              <line x1="7" y1="14" x2="10" y2="14"></line>
              <line x1="14" y1="14" x2="17" y2="14"></line>
              <line x1="7" y1="18" x2="10" y2="18"></line>
              <line x1="14" y1="18" x2="17" y2="18"></line>
            </svg>
            <span>Счёт на оплату</span>
          </a>
        </li>
        <li>
          <a href="/dashboard/akt/create/" class="sidebar-link-v12 {% if active_menu == 'akt-create' %}active{% endif %}">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 11l3 3L22 4"></path>
              <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
            </svg>
            <span>Акт выполненных работ</span>
          </a>
        </li>
      </ul>
    </div>
    
    <!-- Directory Section -->
    <div class="sidebar-section-v12">
      <span class="sidebar-section-label-v12">Справочники</span>
      <ul>
        <li>
          <a href="/dashboard/organizations/" class="sidebar-link-v12 {% if active_menu == 'organizations' %}active{% endif %}">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 21h18"></path>
              <path d="M5 21V7l8-4v18"></path>
              <path d="M19 21V11l-6-3"></path>
              <path d="M9 9v.01"></path>
              <path d="M9 12v.01"></path>
              <path d="M9 15v.01"></path>
              <path d="M9 18v.01"></path>
            </svg>
            <span>Мои компании</span>
          </a>
        </li>
        <li>
          <a href="/dashboard/contractors/" class="sidebar-link-v12 {% if active_menu == 'contractors' %}active{% endif %}">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <span>Контрагенты</span>
          </a>
        </li>
        <li>
          <a href="/dashboard/products/" class="sidebar-link-v12 {% if active_menu == 'products' %}active{% endif %}">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
              <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
              <line x1="12" y1="22.08" x2="12" y2="12"></line>
            </svg>
            <span>Товары / Услуги</span>
          </a>
        </li>
      </ul>
    </div>
    
    <!-- System Section -->
    <div class="sidebar-section-v12">
      <span class="sidebar-section-label-v12">Система</span>
      <ul>
        <li>
          <a href="/dashboard/tariffs/" class="sidebar-link-v12 {% if active_menu == 'tariffs' %}active{% endif %}">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
            </svg>
            <span>Тарифы</span>
          </a>
        </li>
      </ul>
    </div>
  </nav>
  
  <!-- Footer with AI Status and Profile -->
  <div class="sidebar-footer-v12">
    <!-- Tariff Block -->
    <div class="sidebar-tariff-v12" id="sidebar-tariff-block-v12" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(59, 130, 246, 0.03) 100%); border: 1px solid rgba(59, 130, 246, 0.15); border-radius: 1.5rem; padding: 20px; margin: 0 0 20px 0;">
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
        <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="#fff" stroke-width="2.5">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
          </svg>
        </div>
        <div>
          <div style="font-size: 9px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.15em; color: #94a3b8; margin-bottom: 2px;">Тариф</div>
          <div style="font-size: 13px; font-weight: 700; color: #0f172a;" id="sidebar-plan-name-v12">Загрузка...</div>
        </div>
      </div>
      <div style="margin-bottom: 16px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <span style="font-size: 11px; color: #64748b;">Осталось генераций</span>
          <span style="font-size: 13px; font-weight: 800; color: #3b82f6;" id="sidebar-remaining-v12">-</span>
        </div>
        <div style="height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden;">
          <div id="sidebar-progress-v12" style="height: 100%; width: 100%; background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%); border-radius: 3px; transition: all 0.3s ease;"></div>
        </div>
      </div>
      <a href="/dashboard/tariffs/" style="display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 12px 16px; background: #3b82f6; color: #fff; font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.15em; border-radius: 1rem; text-decoration: none; transition: all 0.2s ease;" onmouseover="this.style.background='#2563eb'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='#3b82f6'; this.style.transform='translateY(0)'">
        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Купить документы
      </a>
    </div>
    
    <!-- AI Status -->
    <div class="sidebar-ai-status-v12">
      <span class="ai-status-dot-v12"></span>
      <span class="ai-status-text-v12">AI Core Active</span>
    </div>
    
    <!-- User Profile Card -->
    <div class="sidebar-profile-v12">
      <div class="sidebar-profile-avatar-v12">
        <span id="sidebar-user-initials">{{ user.initials|default('??', true) }}</span>
      </div>
      <div class="sidebar-profile-info-v12">
        <span class="profile-name-v12" id="sidebar-user-name">{{ user.name|default('Гость', true) }}</span>
        <span class="profile-role-v12" id="sidebar-user-email">{{ user.email|default('', true) }}</span>
      </div>
      {% if user.is_authenticated %}
      <a href="/logout/" class="sidebar-profile-logout-v12" title="Выход">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
          <polyline points="16 17 21 12 16 7"></polyline>
          <line x1="21" y1="12" x2="9" y2="12"></line>
        </svg>
      </a>
      {% else %}
      <a href="/login/" class="sidebar-profile-logout-v12" title="Войти" style="color: #3b82f6;">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
          <polyline points="10 17 15 12 10 7"></polyline>
          <line x1="15" y1="12" x2="3" y2="12"></line>
        </svg>
      </a>
      {% endif %}
    </div>
  </div>
</aside>

<script>
// Загрузка лимитов для sidebar v12
(function() {
  function loadSidebarLimitsV12() {
    const token = document.cookie.split('; ').find(row => row.startsWith('access_token='));
    if (!token) return;
    
    fetch('/api/v1/billing/limits', {
      headers: { 'Authorization': 'Bearer ' + token.split('=')[1] }
    })
    .then(r => r.json())
    .then(data => {
      const planNames = {
        'free': 'Бесплатный',
        'subscription': 'Подписка',
        'pay_per_doc': 'Пакет'
      };
      
      const planEl = document.getElementById('sidebar-plan-name-v12');
      if (planEl) planEl.textContent = planNames[data.plan] || 'Бесплатный';
      
      // Вычисляем общий остаток
      let remaining = 0;
      let total = 5;
      
      if (data.subscription_active) {
        remaining = data.subscription_docs_remaining;
        total = data.subscription_docs_limit;
      } else if (data.purchased_docs_remaining > 0) {
        remaining = data.purchased_docs_remaining;
        total = remaining + 10;
      } else {
        remaining = data.free_generations_remaining;
        total = data.free_generations_limit;
      }
      
      const remainingEl = document.getElementById('sidebar-remaining-v12');
      if (remainingEl) remainingEl.textContent = remaining;
      
      const progress = Math.max(0, Math.min(100, (remaining / total) * 100));
      const progressBar = document.getElementById('sidebar-progress-v12');
      if (progressBar) {
        progressBar.style.width = progress + '%';
        if (progress <= 20) {
          progressBar.style.background = 'linear-gradient(90deg, #ef4444 0%, #f87171 100%)';
        } else if (progress <= 50) {
          progressBar.style.background = 'linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%)';
        } else {
          progressBar.style.background = 'linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%)';
        }
      }
    })
    .catch(err => console.log('Sidebar limits error:', err));
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadSidebarLimitsV12);
  } else {
    loadSidebarLimitsV12();
  }
})();
</script>