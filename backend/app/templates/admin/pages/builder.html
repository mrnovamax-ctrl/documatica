{% extends "admin/base_admin.html" %}

{% block title %}{{ page.title }}{% endblock %}
{% block page_title %}Block Builder: {{ page.title }}{% endblock %}

{% block extra_css %}
<style>
/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è Block Builder */
.paragraph-editor-wrap { min-height: 200px; }
.tox-tinymce { border-radius: 0.75rem !important; }
</style>
{% endblock %}

{% block header_actions %}
<div style="display: flex; gap: 0.75rem; align-items: center;">
  <a href="/admin/pages/" class="btn btn-outline">
    <iconify-icon icon="ri:arrow-left-line" width="18"></iconify-icon>
    –ö —Å–ø–∏—Å–∫—É
  </a>
  
  <span class="page-status-badge status-{{ page.status }}">{{ page.status }}</span>
  
  <button onclick="savePage()" class="btn btn-primary" id="saveBtn" style="display: none;">
    <iconify-icon icon="ri:save-line" width="18"></iconify-icon>
    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
  </button>
  
  {% if page.status == 'draft' %}
  <button onclick="publishPage()" class="btn btn-success">
    <iconify-icon icon="ri:check-line" width="18"></iconify-icon>
    –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
  </button>
  {% else %}
  <button onclick="unpublishPage()" class="btn btn-outline">
    <iconify-icon icon="ri:eye-off-line" width="18"></iconify-icon>
    –°–Ω—è—Ç—å —Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
  </button>
  {% endif %}
  
  <a href="/{{ page.slug }}/" target="_blank" class="btn btn-outline">
    <iconify-icon icon="ri:external-link-line" width="18"></iconify-icon>
    –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
  </a>
</div>
{% endblock %}

{% block content %}
<!-- TinyMCE –≥—Ä—É–∑–∏—Ç—Å—è –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞ (—Å–º. loadTinyMCE) -->
<!-- Sortable.js –¥–æ–ª–∂–µ–Ω –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –¥–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ drag-and-drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
/* Block Builder Styles */
.builder-container { display: flex; gap: 2rem; }
.builder-main { flex: 1; min-width: 0; }
.builder-sidebar { width: 320px; flex-shrink: 0; }

/* Page Info Card */
.page-info-card { background: white; border: 1px solid #e2e8f0; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem; }
.form-group { margin-bottom: 1rem; }
.label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin-bottom: 0.5rem; }
.input { width: 100%; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; font-size: 0.9375rem; }
.input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

/* Sections Container */
.sections-container { background: white; border: 1px solid #e2e8f0; border-radius: 1rem; padding: 1.5rem; min-height: 400px; }
.sections-empty { text-align: center; padding: 4rem 2rem; color: #94a3b8; }

/* Section Card */
.section-card { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1rem; cursor: move; transition: all 0.2s; }
.section-card:hover { border-color: #3b82f6; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1); }
.section-card.sortable-ghost { opacity: 0.4; }
.section-card.sortable-drag { box-shadow: 0 8px 24px rgba(59, 130, 246, 0.2); }

.section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #e2e8f0; }
.section-title { font-size: 1rem; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 0.5rem; }
.section-type-badge { padding: 0.25rem 0.75rem; background: #eff6ff; color: #3b82f6; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
.section-actions { display: flex; gap: 0.5rem; }
.section-btn { padding: 0.5rem; background: none; border: none; border-radius: 0.375rem; cursor: pointer; transition: all 0.2s; color: #64748b; }
.section-btn:hover { background: white; color: #3b82f6; }
.section-btn.danger:hover { color: #ef4444; background: #fef2f2; }

.section-settings { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem; }
.section-setting { display: flex; flex-direction: column; gap: 0.25rem; }

/* Blocks */
.blocks-container { display: flex; flex-direction: column; gap: 0.75rem; }
.block-item { background: white; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 1rem; cursor: move; transition: all 0.2s; }
.block-item:hover { border-color: #3b82f6; }
.block-item.sortable-ghost { opacity: 0.4; }

.block-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
.block-drag-handle { cursor: grab; color: #94a3b8; padding: 0.25rem; margin-right: 0.5rem; }
.block-drag-handle:active { cursor: grabbing; }
.block-drag-handle:hover { color: #3b82f6; }
.block-type { font-size: 0.75rem; font-weight: 600; color: #3b82f6; text-transform: uppercase; }
.block-actions { display: flex; gap: 0.25rem; }
.block-btn { padding: 0.25rem; background: none; border: none; border-radius: 0.25rem; cursor: pointer; color: #94a3b8; }
.block-btn:hover { color: #3b82f6; background: #eff6ff; }
.block-btn.danger:hover { color: #ef4444; background: #fef2f2; }

.block-content { font-size: 0.875rem; color: #475569; }
.block-content-preview { max-height: 60px; overflow: hidden; text-overflow: ellipsis; }

.block-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.block-item-complex {
  background: #fffbeb;
  border-color: #fbbf24;
}

.block-badge-complex {
  padding: 0.25rem 0.5rem;
  background: #fbbf24;
  color: #78350f;
  border-radius: 0.375rem;
  font-size: 0.625rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

/* Add Section Panel */
.add-section-panel { background: white; border: 1px solid #e2e8f0; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem; }
.add-section-title { font-size: 0.875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: #334155; margin-bottom: 1rem; }
.section-types-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
.section-type-btn { padding: 1rem; border: 2px dashed #e2e8f0; border-radius: 0.75rem; background: #f8fafc; cursor: pointer; transition: all 0.2s; text-align: center; }
.section-type-btn:hover { border-color: #3b82f6; background: #eff6ff; }
.section-type-btn-icon { font-size: 1.5rem; margin-bottom: 0.5rem; }
.section-type-btn-label { font-size: 0.875rem; font-weight: 600; color: #475569; }

/* Status Badge */
.page-status-badge { padding: 0.375rem 0.875rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
.page-status-badge.status-published { background: #d1fae5; color: #065f46; }
.page-status-badge.status-draft { background: #fef3c7; color: #92400e; }
</style>

<div class="builder-container builder-v12">
  <!-- Main Builder Area -->
  <div class="builder-main">
    
    <!-- Add Section Panel -->
    <div class="add-section-panel">
      <div class="add-section-title">
        <iconify-icon icon="ri:add-circle-line" width="18"></iconify-icon>
        –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é
      </div>
      <div class="section-types-grid">
        <button class="section-type-btn" onclick="addSection('hero')">
          <div class="section-type-btn-icon">üéØ</div>
          <div class="section-type-btn-label">Hero</div>
        </button>
        <button class="section-type-btn" onclick="addSection('features')">
          <div class="section-type-btn-icon">‚≠ê</div>
          <div class="section-type-btn-label">Features</div>
        </button>
        <button class="section-type-btn" onclick="addSection('about')">
          <div class="section-type-btn-icon">‚ÑπÔ∏è</div>
          <div class="section-type-btn-label">–¢–µ–∫—Å—Ç+—Ç–µ–≥</div>
        </button>
        <button class="section-type-btn" onclick="addSection('pricing')">
          <div class="section-type-btn-icon">üí∞</div>
          <div class="section-type-btn-label">Pricing</div>
        </button>
        <button class="section-type-btn" onclick="addSection('cta')">
          <div class="section-type-btn-icon">üì¢</div>
          <div class="section-type-btn-label">CTA</div>
        </button>
        <button class="section-type-btn" onclick="addSection('faq')">
          <div class="section-type-btn-icon">‚ùì</div>
          <div class="section-type-btn-label">FAQ</div>
        </button>
        <button class="section-type-btn" onclick="addSection('document_types')">
          <div class="section-type-btn-icon">üÉè</div>
          <div class="section-type-btn-label">–ö–∞—Ä—Ç–æ—á–∫–∏</div>
        </button>
        <button class="section-type-btn" onclick="addSection('seo_text')">
          <div class="section-type-btn-icon">üìÑ</div>
          <div class="section-type-btn-label">SEO-—Ç–µ–∫—Å—Ç</div>
        </button>
        <button class="section-type-btn" onclick="addSection('form_section')">
          <div class="section-type-btn-icon">üìã</div>
          <div class="section-type-btn-label">–§–æ—Ä–º–∞</div>
        </button>
      </div>
    </div>
    
    <!-- Sections Container -->
    <div class="sections-container" id="sectionsContainer">
      {% set _sections = sections | default(page.sections | default([])) %}
      {% if _sections %}
        {% for section in _sections | sort(attribute='position') %}
        <div class="section-card" data-section-id="{{ section.id }}" data-section-type="{{ section.section_type }}">
          <div class="section-header">
            <div class="section-title" title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∑–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ —Å–µ–∫—Ü–∏–π">
              <iconify-icon icon="ri:drag-move-line" width="20"></iconify-icon>
              <span class="section-type-badge">{% if section.section_type == 'document_types' %}–ö–∞—Ä—Ç–æ—á–∫–∏{% elif section.section_type == 'about' %}–¢–µ–∫—Å—Ç+—Ç–µ–≥{% elif section.section_type == 'seo_text' %}SEO-—Ç–µ–∫—Å—Ç{% elif section.section_type == 'form_section' %}–§–æ—Ä–º–∞{% elif section.section_type == 'articles_preview' %}–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç–∞—Ç—å–∏{% elif section.section_type == 'articles_list' %}–°–ø–∏—Å–æ–∫ —Å—Ç–∞—Ç–µ–π{% else %}{{ section.section_type }}{% endif %}</span>
              <span>–°–µ–∫—Ü–∏—è #{{ section.position + 1 }}</span>
            </div>
            <div class="section-actions">
              <button class="section-btn" onclick="editSection({{ section.id }})" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                <iconify-icon icon="ri:settings-3-line" width="18"></iconify-icon>
              </button>
              <button class="section-btn" onclick="moveSection({{ section.id }}, 'up')" title="–í–≤–µ—Ä—Ö">
                <iconify-icon icon="ri:arrow-up-line" width="18"></iconify-icon>
              </button>
              <button class="section-btn" onclick="moveSection({{ section.id }}, 'down')" title="–í–Ω–∏–∑">
                <iconify-icon icon="ri:arrow-down-line" width="18"></iconify-icon>
              </button>
              <button class="section-btn danger" onclick="deleteSection({{ section.id }})" title="–£–¥–∞–ª–∏—Ç—å">
                <iconify-icon icon="ri:delete-bin-line" width="18"></iconify-icon>
              </button>
            </div>
          </div>
          
          <div class="section-settings">
            <div class="section-setting">
              <label class="label">–§–æ–Ω</label>
              <select class="input" data-section-field="background_style" onchange="markAsChanged()">
                <optgroup label="Solid Backgrounds">
                  <option value="white" {% if section.background_style == 'white' %}selected{% endif %}>‚¨ú White</option>
                  <option value="surface" {% if section.background_style == 'surface' %}selected{% endif %}>‚óªÔ∏è Surface (—Å–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π)</option>
                  <option value="surface_light" {% if section.background_style == 'surface_light' %}selected{% endif %}>‚óªÔ∏è Surface Light</option>
                  <option value="dark" {% if section.background_style == 'dark' %}selected{% endif %}>‚¨õ Dark (—Ç–µ–º–Ω—ã–π)</option>
                  <option value="primary" {% if section.background_style == 'primary' %}selected{% endif %}>üîµ Primary (—Å–∏–Ω–∏–π)</option>
                  <option value="gold" {% if section.background_style == 'gold' %}selected{% endif %}>üü° Gold (–∑–æ–ª–æ—Ç–æ–π)</option>
                </optgroup>
                <optgroup label="Dot Patterns">
                  <option value="pattern_dots_light" {% if section.background_style == 'pattern_dots_light' %}selected{% endif %}>‚Ä¢ Dots Light (—Ç–æ—á–∫–∏ —Å–≤–µ—Ç–ª—ã–µ)</option>
                  <option value="pattern_dots_dark" {% if section.background_style == 'pattern_dots_dark' %}selected{% endif %}>‚Ä¢ Dots Dark (—Ç–æ—á–∫–∏ —Ç–µ–º–Ω—ã–µ)</option>
                </optgroup>
                <optgroup label="Grid Patterns">
                  <option value="pattern_grid_lines" {% if section.background_style == 'pattern_grid_lines' %}selected{% endif %}>‚äû Grid Lines (—Å–µ—Ç–∫–∞)</option>
                </optgroup>
                <optgroup label="Radial Gradients">
                  <option value="pattern_radial_blue" {% if section.background_style == 'pattern_radial_blue' %}selected{% endif %}>‚óâ Radial Blue (—Å–≤–µ—á–µ–Ω–∏–µ —Å–∏–Ω–µ–µ)</option>
                  <option value="pattern_radial_gold" {% if section.background_style == 'pattern_radial_gold' %}selected{% endif %}>‚óâ Radial Gold (—Å–≤–µ—á–µ–Ω–∏–µ –∑–æ–ª–æ—Ç–æ–µ)</option>
                </optgroup>
                <optgroup label="Linear Gradients">
                  <option value="gradient_blue" {% if section.background_style == 'gradient_blue' %}selected{% endif %}>üî∑ Gradient Blue</option>
                  <option value="gradient_gold" {% if section.background_style == 'gradient_gold' %}selected{% endif %}>üî∂ Gradient Gold</option>
                </optgroup>
              </select>
            </div>
            <div class="section-setting">
              <label class="label">–®–∏—Ä–∏–Ω–∞</label>
              <select class="input" data-section-field="container_width" onchange="updateSectionWidth({{ section.id }}, this.value)">
                <option value="default" {% if section.container_width == 'default' %}selected{% endif %}>–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
                <option value="wide" {% if section.container_width == 'wide' %}selected{% endif %}>–®–∏—Ä–æ–∫–∞—è</option>
                <option value="full" {% if section.container_width == 'full' %}selected{% endif %}>–ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω</option>
                <option value="narrow" {% if section.container_width == 'narrow' %}selected{% endif %}>–£–∑–∫–∞—è</option>
              </select>
            </div>
            {% if section.section_type == 'hero' %}
            {% set _hv = (section.settings or {}).get('hero_variant', 'default') %}
            <div class="section-setting">
              <label class="label">–í–∞—Ä–∏–∞–Ω—Ç hero</label>
              <select class="input" data-section-settings-key="hero_variant" onchange="markAsChanged()">
                <option value="default" {% if _hv == 'default' %}selected{% endif %}>01. Default ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç</option>
                <option value="large" {% if _hv == 'large' %}selected{% endif %}>02. Large ‚Äî –∫—Ä—É–ø–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫</option>
                <option value="compact" {% if _hv == 'compact' %}selected{% endif %}>03. Compact ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π</option>
                <option value="pattern" {% if _hv == 'pattern' %}selected{% endif %}>04. Pattern ‚Äî —Å –ø–∞—Ç—Ç–µ—Ä–Ω–æ–º (overflow)</option>
              </select>
              <div class="editor-hint" style="font-size: 0.7rem; margin-top: 0.25rem;">hero.html v12</div>
            </div>
            {% endif %}
            {% if section.section_type == 'faq' %}
            {% set _av = (section.settings or {}).get('accordion_variant', 'basic') %}
            <div class="section-setting">
              <label class="label">–°—Ç–∏–ª—å –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞</label>
              <select class="input" data-section-settings-key="accordion_variant" onchange="markAsChanged()">
                <option value="basic" {% if _av == 'basic' %}selected{% endif %}>01. Basic ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç —Å —à–µ–≤—Ä–æ–Ω–æ–º</option>
                <option value="bordered" {% if _av == 'bordered' %}selected{% endif %}>02. Bordered ‚Äî —Ä–∞–º–∫–∞ –∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏</option>
                <option value="separated" {% if _av == 'separated' %}selected{% endif %}>03. Separated ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∏ —Å —Ç–µ–Ω—å—é</option>
                <option value="icons" {% if _av == 'icons' %}selected{% endif %}>04. With Icons ‚Äî —Å –∏–∫–æ–Ω–∫–æ–π –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ</option>
                <option value="dark" {% if _av == 'dark' %}selected{% endif %}>05. Dark ‚Äî —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞, –∑–æ–ª–æ—Ç–æ–π –∞–∫—Ü–µ–Ω—Ç</option>
                <option value="nested" {% if _av == 'nested' %}selected{% endif %}>06. Nested style ‚Äî –ª–µ–≤–∞—è –ø–æ–ª–æ—Å–∫–∞, –±–µ–π–¥–∂</option>
              </select>
              <div class="editor-hint" style="font-size: 0.7rem; margin-top: 0.25rem;">accordions.html v12 ‚Äî –≤—Å–µ 6 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</div>
            </div>
            {% endif %}
            {% if section.section_type == 'cta' %}
            {% set _cv = (section.settings or {}).get('cta_variant', 'basic') %}
            <div class="section-setting">
              <label class="label">–í–∞—Ä–∏–∞–Ω—Ç CTA (v12)</label>
              <select class="input" data-section-settings-key="cta_variant" onchange="markAsChanged()">
                <option value="basic" {% if _cv == 'basic' %}selected{% endif %}>01. Basic ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç</option>
                <option value="dark" {% if _cv == 'dark' %}selected{% endif %}>02. Dark ‚Äî —Ç—ë–º–Ω—ã–π —Ñ–æ–Ω, —Ç–æ—á–∫–∏</option>
                <option value="gradient" {% if _cv == 'gradient' %}selected{% endif %}>03. Gradient ‚Äî —Å–∏–Ω–∏–π –≥—Ä–∞–¥–∏–µ–Ω—Ç</option>
                <option value="split" {% if _cv == 'split' %}selected{% endif %}>04. Split ‚Äî –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏ + —Ñ–∏—á–∏ —Å –∏–∫–æ–Ω–∫–∞–º–∏</option>
                <option value="banner" {% if _cv == 'banner' %}selected{% endif %}>05. Banner ‚Äî –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –∫–æ–º–ø–∞–∫—Ç</option>
                <option value="cards" {% if _cv == 'cards' %}selected{% endif %}>06. Horizontal CTA Cards ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –∏–∫–æ–Ω–∫–æ–π</option>
                <option value="newsletter" {% if _cv == 'newsletter' %}selected{% endif %}>07. Newsletter ‚Äî –ø–æ–¥–ø–∏—Å–∫–∞ (email + –∫–Ω–æ–ø–∫–∞)</option>
                <option value="countdown" {% if _cv == 'countdown' %}selected{% endif %}>08. Countdown ‚Äî —Ç–∞–π–º–µ—Ä + –∫–Ω–æ–ø–∫–∞</option>
                <option value="minimal" {% if _cv == 'minimal' %}selected{% endif %}>09. Minimal ‚Äî –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π</option>
                <option value="compact" {% if _cv == 'compact' %}selected{% endif %}>10. Compact ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π</option>
                <option value="bordered" {% if _cv == 'bordered' %}selected{% endif %}>11. Bordered ‚Äî —Ä–∞–º–∫–∞, –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç</option>
              </select>
              <div class="editor-hint" style="font-size: 0.7rem; margin-top: 0.25rem;">cta.html v12 ‚Äî –≤—Å–µ 11 –≤–∏–¥–æ–≤</div>
            </div>
            {% endif %}
            {% if section.section_type == 'pricing' %}
            {% set _pv = (section.settings or {}).get('pricing_variant', 'basic') %}
            <div class="section-setting">
              <label class="label">–°—Ç–∏–ª—å —Ç–∞–±–ª–∏—Ü—ã —Ü–µ–Ω (v12)</label>
              <select class="input" data-section-settings-key="pricing_variant" onchange="markAsChanged()">
                <option value="basic" {% if _pv == 'basic' %}selected{% endif %}>01. Basic ‚Äî 3 –∫–æ–ª–æ–Ω–∫–∏</option>
                <option value="dotted" {% if _pv == 'dotted' %}selected{% endif %}>02. Dotted ‚Äî —Ç–æ—á–∫–∏ (—Å–µ—Ä—ã–π/—Å–∏–Ω–∏–π/–∑–æ–ª–æ—Ç–æ–π)</option>
                <option value="dark" {% if _pv == 'dark' %}selected{% endif %}>03. Dark ‚Äî —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞</option>
                <option value="compact" {% if _pv == 'compact' %}selected{% endif %}>04. Compact ‚Äî 2 –∫–æ–ª–æ–Ω–∫–∏</option>
                <option value="toggle" {% if _pv == 'toggle' %}selected{% endif %}>05. With Billing Toggle ‚Äî –º–µ—Å—è—Ü/–≥–æ–¥</option>
              </select>
              <div class="editor-hint" style="font-size: 0.7rem; margin-top: 0.25rem;">pricing.html v12 ‚Äî 5 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</div>
            </div>
            {% endif %}
            {% if section.section_type in ['document_types', 'features', 'pricing', 'upd_types'] %}
            {% set _gc = (section.grid_columns | default(2) | int) %}
            {% set _gc = 2 if _gc not in [1, 2, 3, 4] else _gc %}
            {% set _gap = section.grid_gap | default('medium') %}
            {% set _style = section.grid_style | default('grid') %}
            <div class="section-setting">
              <label class="label">–ö–æ–ª–æ–Ω–∫–∏ —Å–µ—Ç–∫–∏</label>
              <select class="input section-grid-field" data-grid-key="grid_columns" data-section-id="{{ section.id }}" onchange="markAsChanged()">
                <option value="1" {% if _gc == 1 %}selected{% endif %}>1 –∫–æ–ª–æ–Ω–∫–∞</option>
                <option value="2" {% if _gc == 2 %}selected{% endif %}>2 –∫–æ–ª–æ–Ω–∫–∏</option>
                <option value="3" {% if _gc == 3 %}selected{% endif %}>3 –∫–æ–ª–æ–Ω–∫–∏</option>
                <option value="4" {% if _gc == 4 %}selected{% endif %}>4 –∫–æ–ª–æ–Ω–∫–∏</option>
              </select>
            </div>
            <div class="section-setting">
              <label class="label">–û—Ç—Å—Ç—É–ø (gap)</label>
              <select class="input section-grid-field" data-grid-key="grid_gap" data-section-id="{{ section.id }}" onchange="markAsChanged()">
                <option value="small" {% if _gap == 'small' %}selected{% endif %}>Small</option>
                <option value="medium" {% if _gap == 'medium' %}selected{% endif %}>Medium</option>
                <option value="large" {% if _gap == 'large' %}selected{% endif %}>Large</option>
              </select>
            </div>
            <div class="section-setting">
              <label class="label">–°—Ç–∏–ª—å —Ä–∞—Å–∫–ª–∞–¥–∫–∏</label>
              <select class="input section-grid-field" data-grid-key="grid_style" data-section-id="{{ section.id }}" onchange="markAsChanged()">
                <option value="grid" {% if _style == 'grid' %}selected{% endif %}>–°–µ—Ç–∫–∞</option>
                <option value="masonry" {% if _style == 'masonry' %}selected{% endif %}>Masonry</option>
              </select>
            </div>
            {% endif %}
          </div>
          {% if section.section_type == 'document_types' %}
          <div class="section-hint" style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 0.5rem; padding: 0.75rem 1rem; margin-bottom: 1rem; font-size: 0.8125rem; color: #1e40af;">
            <strong>–°–µ–∫—Ü–∏—è ¬´–ö–∞—Ä—Ç–æ—á–∫–∏¬ª:</strong> –¥–æ–±–∞–≤—å—Ç–µ –±–ª–æ–∫–∏ <strong>Heading</strong> / <strong>Paragraph</strong> –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –∑–∞—Ç–µ–º –±–ª–æ–∫–∏ <strong>Document Type Card</strong> ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –≤—ã–±–æ—Ä–æ–º —Å—Ç–∏–ª—è –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ.
          </div>
          {% endif %}
          {% if section.section_type == 'faq' %}
          <div class="section-hint" style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 0.5rem; padding: 0.75rem 1rem; margin-bottom: 1rem; font-size: 0.8125rem; color: #1e40af;">
            <strong>–°–µ–∫—Ü–∏—è FAQ:</strong> –¥–æ–±–∞–≤—å—Ç–µ –±–ª–æ–∫ <strong>Heading</strong> (–∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–µ–∫—Ü–∏–∏), –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ <strong>Paragraph</strong>, –∑–∞—Ç–µ–º –±–ª–æ–∫–∏ <strong>FAQ Item</strong> ‚Äî –≤–æ–ø—Ä–æ—Å, –æ—Ç–≤–µ—Ç (HTML) –∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∫–Ω–æ–ø–∫–∞ –≤ –æ—Ç–≤–µ—Ç–µ (—Å—Ç–∏–ª–∏ –∏–∑ buttons.html v12).
          </div>
          {% endif %}
          {% if section.section_type == 'form_section' %}
          <div class="section-hint" style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 0.5rem; padding: 0.75rem 1rem; margin-bottom: 1rem; font-size: 0.8125rem; color: #1e40af;">
            <strong>–°–µ–∫—Ü–∏—è ¬´–§–æ—Ä–º–∞¬ª:</strong> –¥–æ–±–∞–≤—å—Ç–µ –±–ª–æ–∫ <strong>Heading</strong> (–∑–∞–≥–æ–ª–æ–≤–æ–∫), –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ <strong>Paragraph</strong> (–æ–ø–∏—Å–∞–Ω–∏–µ), –∑–∞—Ç–µ–º –±–ª–æ–∫ <strong>Contact Form</strong> ‚Äî —Ñ–æ—Ä–º–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ (–ø–æ–ª—è –∏ –∫–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ –±–ª–æ–∫–∞).
          </div>
          {% endif %}
          {% if section.section_type == 'cta' %}
          <div class="section-hint" style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 0.5rem; padding: 0.75rem 1rem; margin-bottom: 1rem; font-size: 0.8125rem; color: #1e40af;">
            <strong>–°–µ–∫—Ü–∏—è CTA (v12):</strong> –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –≤—ã—à–µ. –ë–ª–æ–∫–∏: <strong>Label</strong>, <strong>Heading</strong> (accent ‚Äî —Å–ª–æ–≤–æ –≤—ã–¥–µ–ª—è–µ—Ç—Å—è —Ü–≤–µ—Ç–æ–º), <strong>Paragraph</strong>, –æ–¥–Ω–∞ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ <strong>Button</strong>. –î–ª—è –≤–∞—Ä–∏–∞–Ω—Ç–∞ Split ‚Äî –¥–æ–±–∞–≤—å—Ç–µ <strong>Feature Card</strong> (–∏–∫–æ–Ω–∫–∏ + —Ç–µ–∫—Å—Ç). –î–ª—è Countdown ‚Äî –±–ª–æ–∫ <strong>Countdown</strong> (—Ç–∞–π–º–µ—Ä). –î–ª—è Newsletter ‚Äî –±–ª–æ–∫ <strong>Newsletter</strong>. –î–ª—è Horizontal CTA Cards ‚Äî –±–ª–æ–∫–∏ <strong>CTA Card</strong> –∏–ª–∏ <strong>Link Group</strong>.
          </div>
          {% endif %}
          {% if section.section_type == 'pricing' %}
          <div class="section-hint" style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 0.5rem; padding: 0.75rem 1rem; margin-bottom: 1rem; font-size: 0.8125rem; color: #1e40af;">
            <strong>–°–µ–∫—Ü–∏—è Pricing (v12):</strong> –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å –≤—ã—à–µ. –î–æ–±–∞–≤—å—Ç–µ –±–ª–æ–∫ <strong>Heading</strong> –∏/–∏–ª–∏ <strong>Label</strong> (–∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–µ–∫—Ü–∏–∏), –∑–∞—Ç–µ–º <strong>2 –∏–ª–∏ 3</strong> –±–ª–æ–∫–∞ <strong>Pricing Card</strong> ‚Äî –≤ –∫–∞–∂–¥–æ–º: —Ç–µ–≥, –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω–∞ (–º–µ—Å—è—Ü/–≥–æ–¥/–∑–∞ —à—Ç—É–∫—É), —Ñ–æ–Ω –∏ —Ü–≤–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏, —Å–ø–∏—Å–æ–∫ —Ñ–∏—á, –∫–Ω–æ–ø–∫–∞.
          </div>
          {% endif %}
          <div class="blocks-container" data-section-id="{{ section.id }}">
            {% for block in section.blocks | sort(attribute='position') %}
            {% set is_complex = block.block_type in ['pricing_table', 'upd_types_grid'] %}
            <div class="block-item{% if is_complex %} block-item-complex{% endif %}" data-block-id="{{ block.id }}">
              <div class="block-header">
                <span class="block-drag-handle" title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞"><iconify-icon icon="ri:drag-move-2-line" width="18"></iconify-icon></span>
                <span class="block-type">{{ block.block_type }}</span>
                {% if is_complex %}
                  <span class="block-badge-complex">Complex Block</span>
                {% endif %}
                <div class="block-actions">
                  {% if not is_complex %}
                  <button class="block-btn" onclick="copyBlock({{ block.id }}, {{ section.id }})" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å">
                    <iconify-icon icon="ri:file-copy-line" width="16"></iconify-icon>
                  </button>
                  <button class="block-btn" onclick="editBlock({{ block.id }})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                    <iconify-icon icon="ri:edit-line" width="16"></iconify-icon>
                  </button>
                  {% else %}
                  <button class="block-btn" disabled title="–†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ YAML">
                    <iconify-icon icon="ri:lock-line" width="16"></iconify-icon>
                  </button>
                  {% endif %}
                  <button class="block-btn danger" onclick="deleteBlock({{ block.id }})" title="–£–¥–∞–ª–∏—Ç—å">
                    <iconify-icon icon="ri:delete-bin-line" width="16"></iconify-icon>
                  </button>
                </div>
              </div>
              <div class="block-content block-content-preview">
                {% if is_complex %}
                  <em style="color: #94a3b8;">Complex structure ({{ block.content.plans | length if block.content.plans else block.content.cards | length if block.content.cards else 'N/A' }} items)</em>
                {% elif block.block_type == 'document_type_card' %}
                  <span style="color: #64748b;">–ö–∞—Ä—Ç–æ—á–∫–∞:</span> {{ block.content.name | default('–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è') | truncate(40) }} ‚Äî —Å—Ç–∏–ª—å ¬´{{ block.content.card_style | default('default') }}¬ª
                {% elif block.block_type == 'contact_form' %}
                  <span style="color: #64748b;">–§–æ—Ä–º–∞</span> {% if block.content.fields %}({{ block.content.fields | length }} –ø–æ–ª–µ–π){% else %}(–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä){% endif %}
                {% else %}
                  {{ block.content.text | default(block.content.title) | default(block.content.name) | default('–ë–ª–æ–∫ –∫–æ–Ω—Ç–µ–Ω—Ç–∞') | truncate(100) }}
                {% endif %}
              </div>
            </div>
            {% endfor %}
            
            <button class="btn btn-outline" onclick="addBlockToSection({{ section.id }}, '{{ section.section_type }}')" style="width: 100%; margin-top: 0.5rem;">
              <iconify-icon icon="ri:add-line" width="16"></iconify-icon>
              –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫
            </button>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="sections-empty">
          <iconify-icon icon="ri:layout-grid-line" width="64" style="color: #cbd5e1; margin-bottom: 1rem;"></iconify-icon>
          <p>–°–µ–∫—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é —Å–µ–∫—Ü–∏—é –≤—ã—à–µ.</p>
        </div>
      {% endif %}
    </div>
  </div>
  
  <!-- Sidebar -->
  <div class="builder-sidebar">
    <div class="page-info-card">
      <h3 style="font-size: 1rem; font-weight: 700; margin-bottom: 1rem;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</h3>
      
      <div class="form-group">
        <label class="label">URL (slug)</label>
        <input type="text" class="input" value="/{{ page.slug }}/" readonly>
      </div>
      
      <div class="form-group">
        <label class="label">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
        <input type="text" name="title" class="input" value="{{ page.title }}" onchange="updatePageTitle(this.value)">
      </div>
      
      <div class="form-group">
        <label class="label">Meta Title</label>
        <input type="text" class="input" name="meta_title" value="{{ page.meta_title or '' }}" placeholder="{{ page.title or '–ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –ø–æ–∏—Å–∫–æ–≤–∏–∫–æ–≤' }}" onchange="markAsChanged()">
      </div>
      
      <div class="form-group">
        <label class="label">Meta Description</label>
        <textarea class="input" name="meta_description" rows="3" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ (–¥–æ 160 —Å–∏–º–≤–æ–ª–æ–≤)" onchange="markAsChanged()">{{ page.meta_description or '' }}</textarea>
      </div>
      
      <div class="form-group">
        <label class="label">Meta Keywords</label>
        <input type="text" class="input" name="meta_keywords" value="{{ page.meta_keywords or '' }}" placeholder="–∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é" onchange="markAsChanged()">
      </div>
      
      <div class="form-group">
        <label class="label">–¢–∏–ø —Å—Ç—Ä–∞–Ω–∏—Ü—ã</label>
        <select class="input" name="page_type" onchange="markAsChanged()">
          <option value="custom" {% if page.page_type == 'custom' %}selected{% endif %}>Custom</option>
          <option value="home" {% if page.page_type == 'home' %}selected{% endif %}>Home</option>
          <option value="service" {% if page.page_type == 'service' %}selected{% endif %}>Service</option>
          <option value="blog" {% if page.page_type == 'blog' %}selected{% endif %}>Blog</option>
        </select>
      </div>
    </div>
  </div>
</div>

<script>
const pageId = {{ page.id }};
let hasUnsavedChanges = false;

// –ò—Å—Ö–æ–¥–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ payload)
const pageStructure = {{ page_structure_json|safe }};
let nextNewSectionId = 1;
let nextNewBlockId = 1;
const pendingBlocks = {};  // temp id -> { block_type, content, css_classes }
const pendingEdits = {};   // server block id -> { content, css_classes }

function findSection(sectionId) {
  if (!pageStructure || !pageStructure.sections) return null;
  const idNum = parseInt(sectionId, 10);
  if (isNaN(idNum)) return null;
  return pageStructure.sections.find(s => s.id === idNum) || null;
}

function findBlock(blockId) {
  const idStr = String(blockId);
  if (idStr.startsWith('new-')) return pendingBlocks[idStr] ? { block: { block_type: pendingBlocks[idStr].block_type, content: pendingBlocks[idStr].content, css_classes: pendingBlocks[idStr].css_classes } } : null;
  if (!pageStructure || !pageStructure.sections) return null;
  const idNum = parseInt(blockId, 10);
  if (isNaN(idNum)) return null;
  for (const sec of pageStructure.sections) {
    const block = (sec.blocks || []).find(b => b.id === idNum);
    if (block) {
      const edited = pendingEdits[idNum];
      return { section: sec, block: edited ? { ...block, ...edited } : block };
    }
  }
  return null;
}

// –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
function markAsChanged() {
  hasUnsavedChanges = true;
  document.getElementById('saveBtn').style.display = 'flex';
}

// –°–æ–±—Ä–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏–∑ DOM (–ø–æ—Ä—è–¥–æ–∫) + pageStructure / pendingBlocks / pendingEdits, –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
async function savePage() {
  const sectionCards = Array.from(document.querySelectorAll('.section-card'));
  const sectionsPayload = [];
  for (let pos = 0; pos < sectionCards.length; pos++) {
    const card = sectionCards[pos];
    const sectionId = card.dataset.sectionId;
    const sectionType = card.dataset.sectionType || 'custom';
    const sec = String(sectionId).startsWith('new-') ? null : findSection(sectionId);
    const background_style = (card.querySelector('select[data-section-field="background_style"]') || {}).value || (sec && sec.background_style) || 'light';
    const container_width = (card.querySelector('select[data-section-field="container_width"]') || {}).value || (sec && sec.container_width) || 'default';
    const gridCols = card.querySelector('.section-grid-field[data-grid-key="grid_columns"]');
    const gridGap = card.querySelector('.section-grid-field[data-grid-key="grid_gap"]');
    const gridStyle = card.querySelector('.section-grid-field[data-grid-key="grid_style"]');
    const settings = Object.assign({}, (sec && sec.settings) || {});
    if (sectionType === 'hero') {
      const heroSel = card.querySelector('select[data-section-settings-key="hero_variant"]');
      if (heroSel) settings.hero_variant = heroSel.value;
    }
    if (sectionType === 'faq') {
      const accordionSel = card.querySelector('select[data-section-settings-key="accordion_variant"]');
      if (accordionSel) settings.accordion_variant = accordionSel.value;
    }
    if (sectionType === 'cta') {
      const ctaSel = card.querySelector('select[data-section-settings-key="cta_variant"]');
      if (ctaSel) settings.cta_variant = ctaSel.value;
    }
    if (sectionType === 'pricing') {
      const pvSel = card.querySelector('select[data-section-settings-key="pricing_variant"]');
      if (pvSel) settings.pricing_variant = pvSel.value;
    }
    const blocksContainer = card.querySelector('.blocks-container');
    const blockItems = blocksContainer ? Array.from(blocksContainer.querySelectorAll('.block-item')) : [];
    const blocksPayload = [];
    for (let bpos = 0; bpos < blockItems.length; bpos++) {
      const bid = blockItems[bpos].dataset.blockId;
      const found = findBlock(bid);
      const blk = found ? found.block : null;
      blocksPayload.push({
        block_type: blk ? blk.block_type : 'paragraph',
        position: bpos,
        content: (blk && blk.content) || {},
        css_classes: (blk && blk.css_classes) || null
      });
    }
    sectionsPayload.push({
      section_type: sectionType,
      position: pos,
      background_style: background_style,
      container_width: container_width,
      padding_y: (sec && sec.padding_y) || 'default',
      grid_columns: gridCols ? (parseInt(gridCols.value, 10) || 2) : 2,
      grid_gap: (gridGap && gridGap.value) || 'medium',
      grid_style: (gridStyle && gridStyle.value) || 'grid',
      settings: settings,
      blocks: blocksPayload
    });
  }
  const titleEl = document.querySelector('.form-group input[value][name="title"]') || document.querySelector('.form-group input[name="title"]');
  const pageTitle = (document.querySelector('.form-group input[value]') && document.querySelector('.form-group input').value) || (titleEl && titleEl.value);
  const metaTitleEl = document.querySelector('.form-group input[name="meta_title"]');
  const metaDescEl = document.querySelector('.form-group textarea[name="meta_description"]');
  const metaKwEl = document.querySelector('.form-group input[name="meta_keywords"]');
  const pageTypeEl = document.querySelector('.form-group select[name="page_type"]');
  const page_meta = {
    title: (pageStructure && pageStructure.page_meta && pageStructure.page_meta.title) || pageTitle || '',
    meta_title: (metaTitleEl && metaTitleEl.value.trim()) || null,
    meta_description: (metaDescEl && metaDescEl.value.trim()) || null,
    meta_keywords: (metaKwEl && metaKwEl.value.trim()) || null,
    page_type: (pageTypeEl && pageTypeEl.value) || null
  };
  const titleInput = document.querySelector('.form-group label + input');
  const titleFromSidebar = document.querySelector('.builder-sidebar input[name="title"]');
  if (titleFromSidebar) page_meta.title = titleFromSidebar.value.trim() || page_meta.title;
  const allTitleInputs = document.querySelectorAll('.form-group input');
  for (const inp of allTitleInputs) {
    if (inp.name === 'title' || (inp.placeholder && inp.placeholder.indexOf('–ó–∞–≥–æ–ª–æ–≤–æ–∫') !== -1)) {
      page_meta.title = inp.value.trim() || page_meta.title;
      break;
    }
  }
  const payload = { page_meta: page_meta, sections: sectionsPayload };
  const res = await fetch(`/api/v1/pages/${pageId}/structure/`, {
    method: 'PUT',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  });
  if (!res.ok) {
    const err = await res.text();
    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (err.length < 200 ? err : res.status));
    return;
  }
  hasUnsavedChanges = false;
  document.getElementById('saveBtn').style.display = 'none';
  alert('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
  location.reload();
}

// –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', (e) => {
  if (hasUnsavedChanges) {
    e.preventDefault();
    e.returnValue = '';
  }
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Sortable –¥–ª—è —Å–µ–∫—Ü–∏–π (–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∑–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–µ–∫—Ü–∏–∏)
const sectionsContainer = document.getElementById('sectionsContainer');
if (sectionsContainer && typeof Sortable !== 'undefined') {
  new Sortable(sectionsContainer, {
    animation: 150,
    handle: '.section-title',
    ghostClass: 'sortable-ghost',
    dragClass: 'sortable-drag',
    onEnd: function(evt) {
      reorderSections();
    }
  });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Sortable –¥–ª—è –±–ª–æ–∫–æ–≤ –≤ –∫–∞–∂–¥–æ–π —Å–µ–∫—Ü–∏–∏ (–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∑–∞ –∏–∫–æ–Ω–∫—É)
document.querySelectorAll('.blocks-container').forEach(container => {
  if (typeof Sortable !== 'undefined') {
    new Sortable(container, {
      animation: 150,
      handle: '.block-drag-handle',
      ghostClass: 'sortable-ghost',
      filter: '.btn.btn-outline',
      onEnd: function(evt) {
        reorderBlocks(container.dataset.sectionId);
      }
    });
  }
});

// –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é —Ç–æ–ª—å–∫–æ –≤ DOM; –≤ –ë–î –ø–æ–ø–∞–¥—ë—Ç –ø–æ –∫–Ω–æ–ø–∫–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª
function addSection(sectionType) {
  const newId = 'new-' + (nextNewSectionId++);
  const pos = document.querySelectorAll('.section-card').length;
  const sectionLabel = sectionType === 'document_types' ? '–ö–∞—Ä—Ç–æ—á–∫–∏' : sectionType === 'about' ? '–¢–µ–∫—Å—Ç+—Ç–µ–≥' : sectionType === 'form_section' ? '–§–æ—Ä–º–∞' : sectionType;
  const card = document.createElement('div');
  card.className = 'section-card';
  card.dataset.sectionId = newId;
  card.dataset.sectionType = sectionType;
  card.innerHTML = `
    <div class="section-header">
      <div class="section-title" title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∑–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ —Å–µ–∫—Ü–∏–π">
        <iconify-icon icon="ri:drag-move-line" width="20"></iconify-icon>
        <span class="section-type-badge">${escapeHtml(sectionLabel)}</span>
        <span>–°–µ–∫—Ü–∏—è #${pos + 1}</span>
      </div>
      <div class="section-actions">
        <button class="section-btn" onclick="editSection('${newId}')" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏"><iconify-icon icon="ri:settings-3-line" width="18"></iconify-icon></button>
        <button class="section-btn danger" onclick="deleteSection('${newId}')" title="–£–¥–∞–ª–∏—Ç—å"><iconify-icon icon="ri:delete-bin-line" width="18"></iconify-icon></button>
      </div>
    </div>
    <div class="section-settings">
      <div class="section-setting">
        <label class="label">–§–æ–Ω</label>
        <select class="input" data-section-field="background_style">
          <option value="light" selected>Light</option>
          <option value="dark">Dark</option>
          <option value="pattern_light">Pattern Light</option>
          <option value="pattern_dark">Pattern Dark</option>
        </select>
      </div>
      <div class="section-setting">
        <label class="label">–®–∏—Ä–∏–Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞</label>
        <select class="input" data-section-field="container_width">
          <option value="default" selected>Default</option>
          <option value="wide">Wide</option>
          <option value="full">Full</option>
          <option value="narrow">Narrow</option>
        </select>
      </div>
    </div>
    <div class="blocks-container" data-section-id="${newId}">
      <button class="btn btn-outline" onclick="addBlockToSection('${newId}', '${escapeHtml(sectionType)}')" style="width: 100%; margin-top: 0.5rem;">
        <iconify-icon icon="ri:add-line" width="16"></iconify-icon>
        –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫
      </button>
    </div>
  `;
  document.getElementById('sectionsContainer').appendChild(card);
  const newBlocksContainer = card.querySelector('.blocks-container');
  if (newBlocksContainer && typeof Sortable !== 'undefined') {
    new Sortable(newBlocksContainer, {
      animation: 150,
      handle: '.block-drag-handle',
      ghostClass: 'sortable-ghost',
      filter: '.btn.btn-outline',
      onEnd: function() { reorderBlocks(newId); }
    });
  }
  markAsChanged();
}

function deleteSection(sectionId) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å–µ–∫—Ü–∏—é? –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.')) return;
  const card = document.querySelector('.section-card[data-section-id="' + sectionId + '"]');
  if (card) card.remove();
  markAsChanged();
}

function reorderSections() {
  markAsChanged();
}

function reorderBlocks(sectionId) {
  markAsChanged();
}

function copyBlock(blockId, sectionId) {
  const found = findBlock(blockId);
  if (!found || !found.block) {
    alert('–ë–ª–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω');
    return;
  }
  const block = found.block;
  const tempId = 'new-' + sectionId + '-' + (nextNewBlockId++);
  const contentCopy = JSON.parse(JSON.stringify(block.content || {}));
  pendingBlocks[tempId] = { block_type: block.block_type, content: contentCopy, css_classes: block.css_classes || '' };
  markAsChanged();
  const container = document.querySelector('.blocks-container[data-section-id="' + sectionId + '"]');
  if (!container) return;
  const previewText = getBlockPreviewText(block);
  const isComplex = ['pricing_table', 'upd_types_grid'].includes(block.block_type);
  const div = document.createElement('div');
  div.className = 'block-item' + (isComplex ? ' block-item-complex' : '');
  div.dataset.blockId = tempId;
  const editOnclick = !isComplex ? 'editBlock(\'' + tempId.replace(/'/g, "\\'") + '\')' : '';
  div.innerHTML = `
    <div class="block-header">
      <span class="block-drag-handle" title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞"><iconify-icon icon="ri:drag-move-2-line" width="18"></iconify-icon></span>
      <span class="block-type">${escapeHtml(block.block_type)}</span>
      ${isComplex ? '<span class="block-badge-complex">Complex Block</span>' : ''}
      <div class="block-actions">
        ${!isComplex ? '<button class="block-btn" onclick="' + editOnclick + '" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"><iconify-icon icon="ri:edit-line" width="16"></iconify-icon></button>' : ''}
        <button class="block-btn danger" onclick="deleteBlock(\'' + tempId.replace(/'/g, "\\'") + '\')" title="–£–¥–∞–ª–∏—Ç—å"><iconify-icon icon="ri:delete-bin-line" width="16"></iconify-icon></button>
      </div>
    </div>
    <div class="block-content block-content-preview">${previewText}</div>
  `;
  const refBlock = container.querySelector('.block-item[data-block-id="' + String(blockId).replace(/"/g, '\\"') + '"]');
  if (refBlock) refBlock.insertAdjacentElement('afterend', div);
  else {
    const addBtn = container.querySelector('.btn.btn-outline');
    container.insertBefore(div, addBtn);
  }
}

function deleteBlock(blockId) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –±–ª–æ–∫? –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.')) return;
  const idStr = String(blockId);
  const el = document.querySelector('.block-item[data-block-id="' + idStr.replace(/"/g, '\\"') + '"]');
  if (el) el.remove();
  if (idStr.startsWith('new-')) delete pendingBlocks[idStr];
  markAsChanged();
}

async function publishPage() {
  const response = await fetch(`/admin/pages/${pageId}/publish/`, {
    method: 'POST'
  });
  
  if (response.ok) {
    location.reload();
  }
}

async function unpublishPage() {
  const response = await fetch(`/admin/pages/${pageId}/unpublish/`, {
    method: 'POST'
  });
  
  if (response.ok) {
    location.reload();
  }
}

function editSection(sectionId) {
  alert('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ "–§–æ–Ω" –∏ "–®–∏—Ä–∏–Ω–∞" –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ–∫—Ü–∏–∏');
}

function moveSection(sectionId, direction) {
  alert('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ drag-and-drop (–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ) –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Å–µ–∫—Ü–∏–π');
}
</script>

{% include "admin/pages/modals/block_editor.html" %}
{% include "admin/pages/modals/add_block.html" %}

<script>
// ============================================================================
// TinyMCE –¥–ª—è Paragraph blocks (–ª–æ–∫–∞–ª—å–Ω–æ –∏–∑ /static/js/tinymce/)
// ============================================================================
var TINYMCE_ID = 'paragraph-tinymce';
var TINYMCE_SRC = '/static/js/tinymce/tinymce.min.js?v=6';
var TINYMCE_BASE = '/static/js/tinymce';
var tinymceLoadPromise = null;

function loadTinyMCE() {
  if (typeof tinymce !== 'undefined') return Promise.resolve();
  if (tinymceLoadPromise) return tinymceLoadPromise;
  tinymceLoadPromise = new Promise(function(resolve, reject) {
    var s = document.createElement('script');
    s.src = TINYMCE_SRC;
    s.onload = resolve;
    s.onerror = function() { reject(new Error('TinyMCE load failed')); };
    document.head.appendChild(s);
  });
  return tinymceLoadPromise;
}

function initParagraphEditor(initialContent) {
  var ta = document.getElementById(TINYMCE_ID);
  if (!ta) return;
  var txt = (initialContent != null && initialContent !== undefined) ? String(initialContent) : '';
  if (typeof tinymce !== 'undefined' && tinymce.get(TINYMCE_ID)) {
    tinymce.get(TINYMCE_ID).remove();
  }
  ta.value = txt;
  if (typeof tinymce !== 'undefined') {
    tinymce.init({
      base_url: TINYMCE_BASE,
      selector: '#' + TINYMCE_ID,
      height: 280,
      menubar: false,
      language: 'ru',
      plugins: 'lists link image code',
      toolbar: 'undo redo | blocks | bold italic | alignleft aligncenter alignright | bullist numlist | link image | removeformat code',
      block_formats: 'Paragraph=p; Heading 2=h2; Heading 3=h3; Heading 4=h4',
      content_style: 'body { font-family: Inter, sans-serif; font-size: 14px; line-height: 1.6; }',
      images_upload_url: '/api/v1/upload/tinymce-image',
      images_upload_credentials: true,
      automatic_uploads: true,
      images_reuse_filename: false,
      relative_urls: false,
      remove_script_host: false
    });
  }
}

function getParagraphEditorHtml() {
  var ed = typeof tinymce !== 'undefined' ? tinymce.get(TINYMCE_ID) : null;
  if (ed) return Promise.resolve(ed.getContent());
  var ta = document.getElementById(TINYMCE_ID);
  return Promise.resolve(ta ? ta.value : '');
}

function destroyParagraphEditor() {
  if (typeof tinymce !== 'undefined' && tinymce.get(TINYMCE_ID)) {
    tinymce.get(TINYMCE_ID).remove();
  }
}

// ============================================================================
// Block Editor Modal
// ============================================================================

let currentEditingBlock = null;

function openBlockEditor(blockId, blockData) {
  currentEditingBlock = blockId;
  
  const modal = document.getElementById('blockEditorModal');
  const blockType = blockData.block_type;
  
  // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä—ã
  document.querySelectorAll('.block-editor-content').forEach(el => el.style.display = 'none');
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
  let editor = null;
  let editorType = blockType;
  
  // –°–ª–æ–∂–Ω—ã–µ –±–ª–æ–∫–∏ (pricing, upd_types) - –ù–ï —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç—Å—è
  const complexBlocks = ['pricing_table', 'upd_types_grid'];
  if (complexBlocks.includes(blockType)) {
    alert('–≠—Ç–æ—Ç –±–ª–æ–∫ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–æ–∂–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ YAML —Ä–µ–∂–∏–º –≤ —Ä–∞–∑–¥–µ–ª–µ "–ö–æ–Ω—Ç–µ–Ω—Ç"');
    return;
  }
  // document_types_grid (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç) ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä
  if (blockType === 'document_types_grid') {
    alert('–ë–ª–æ–∫ –≤ —Å—Ç–∞—Ä–æ–º —Ñ–æ—Ä–º–∞—Ç–µ. –î–æ–±–∞–≤—å—Ç–µ —Å–µ–∫—Ü–∏—é ¬´–ö–∞—Ä—Ç–æ—á–∫–∏¬ª –∑–∞–Ω–æ–≤–æ —Å –±–ª–æ–∫–∞–º–∏ Document Type Card.');
    return;
  }
  const knownTypes = ['heading', 'paragraph', 'button', 'feature_card', 'stat_card', 'label', 'note', 'document_type_card', 'contact_form', 'faq_item', 'link_group', 'countdown', 'newsletter', 'cta_card', 'pricing_card'];
  if (!knownTypes.includes(blockType)) {
    editorType = 'paragraph';
  }
  if (blockType === 'faq_item') editorType = 'faq_item';
  if (blockType === 'link_group') editorType = 'link_group';
  if (blockType === 'countdown') editorType = 'countdown';
  if (blockType === 'newsletter') editorType = 'newsletter';
  if (blockType === 'cta_card') editorType = 'cta_card';
  if (blockType === 'pricing_card') editorType = 'pricing_card';
  
  editor = document.getElementById(`editor-${editorType}`);
  
  if (editor) {
    editor.style.display = 'block';
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
    fillEditorFields(editorType, blockData.content, blockData.css_classes);
    
    document.getElementById('editBlockId').value = blockId;
    document.getElementById('editBlockType').value = blockType; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–∏–ø!
    
    modal.style.display = 'flex';
  } else {
    alert(`–†–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è —Ç–∏–ø–∞ "${blockType}" –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω`);
  }
}

function fillEditorFields(blockType, content, cssClasses) {
  if (blockType === 'heading') {
    document.getElementById('heading-text').value = content.text || '';
    document.getElementById('heading-level').value = content.level || 2;
    document.getElementById('heading-accent').value = content.accent || '';
  } else if (blockType === 'paragraph') {
    var paraContent = (content && (content.text || (content.data && content.data.text))) || '';
    if (typeof loadTinyMCE === 'function' && typeof initParagraphEditor === 'function') {
      var paraContentCopy = paraContent;
      loadTinyMCE().then(function() { setTimeout(function() { initParagraphEditor(paraContentCopy); }, 100); }).catch(function() { alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ–∫—Å—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.'); });
    }
  } else if (blockType === 'button') {
    document.getElementById('button-text').value = content.text || '';
    document.getElementById('button-url').value = content.url || '';
    
    // –ü–∞—Ä—Å–∏–º CSS –∫–ª–∞—Å—Å—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∏–ª—è –∏ —Ä–∞–∑–º–µ—Ä–∞
    const classes = cssClasses || '';
    if (classes.includes('btn-gold')) {
      document.getElementById('button-style').value = 'btn btn-gold';
    } else if (classes.includes('btn-outline')) {
      document.getElementById('button-style').value = 'btn btn-outline';
    } else if (classes.includes('btn-ghost')) {
      document.getElementById('button-style').value = 'btn btn-ghost';
    } else if (classes.includes('btn-link')) {
      document.getElementById('button-style').value = 'btn btn-link';
    } else {
      document.getElementById('button-style').value = 'btn btn-primary';
    }
    
    if (classes.includes('btn-massive')) {
      document.getElementById('button-size').value = 'btn-massive';
    } else if (classes.includes('btn-lg')) {
      document.getElementById('button-size').value = 'btn-lg';
    } else if (classes.includes('btn-sm')) {
      document.getElementById('button-size').value = 'btn-sm';
    } else {
      document.getElementById('button-size').value = '';
    }
  } else if (blockType === 'feature_card') {
    document.getElementById('feature_card-title').value = content.title || '';
    document.getElementById('feature_card-description').value = content.description || '';
    document.getElementById('feature_card-icon').value = content.icon || 'check-circle';
  } else if (blockType === 'stat_card') {
    document.getElementById('stat_card-value').value = content.value || '';
    document.getElementById('stat_card-label').value = content.label || '';
  } else if (blockType === 'label') {
    document.getElementById('label-text').value = content.text || '';
    var labelBadgeEl = document.getElementById('label-badge_style');
    if (labelBadgeEl) labelBadgeEl.value = content.badge_style || 'primary';
  } else if (blockType === 'note') {
    document.getElementById('note-text').value = content.text || '';
    document.getElementById('note-accent').value = content.accent || '';
  } else if (blockType === 'document_type_card') {
    document.getElementById('document_type_card-name').value = content.name || '';
    document.getElementById('document_type_card-description').value = content.description || '';
    document.getElementById('document_type_card-url').value = content.url || '#';
    document.getElementById('document_type_card-card_style').value = content.card_style || 'default';
    document.getElementById('document_type_card-card_background').value = content.card_background || '';
    document.getElementById('document_type_card-icon').value = content.icon || 'check-circle';
    if (typeof updateIconPreview === 'function') updateIconPreview('document_type_card-icon', content.icon || 'check-circle');
    document.getElementById('document_type_card-tag').value = content.tag || '';
    var tagBadgeEl = document.getElementById('document_type_card-tag_badge_style');
    if (tagBadgeEl) tagBadgeEl.value = content.tag_badge_style || 'primary';
    document.getElementById('document_type_card-label').value = content.label || '';
    document.getElementById('document_type_card-value').value = content.value || '';
    document.getElementById('document_type_card-change').value = content.change || '';
    document.getElementById('document_type_card-tag_promo').value = content.tag_promo || content.tag || '';
    document.getElementById('document_type_card-meta').value = content.meta || '';
    document.getElementById('document_type_card-tag_article').value = content.tag_article || content.tag || '';
    document.getElementById('document_type_card-meta_article').value = content.meta_article || content.meta || '';
    document.getElementById('document_type_card-tag_info').value = content.tag_info || content.tag || '';
    var cardWidthEl = document.getElementById('document_type_card-card_width');
    if (cardWidthEl) {
      var cardWidthVal = (content.card_width !== undefined && content.card_width !== null) ? String(content.card_width) : '';
      cardWidthEl.value = cardWidthVal;
      if (cardWidthEl.value !== cardWidthVal) {
        for (var i = 0; i < cardWidthEl.options.length; i++) {
          if (cardWidthEl.options[i].value === cardWidthVal) { cardWidthEl.selectedIndex = i; break; }
        }
      }
    }
    toggleDocumentTypeCardFields(content.card_style || 'default');
  } else if (blockType === 'contact_form') {
    document.getElementById('contact_form-form_width').value = content.form_width || 'default';
    document.getElementById('contact_form-submit_text').value = content.submit_text || '–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ';
    if (typeof formBuilderSetFields === 'function') formBuilderSetFields(content.fields || []);
  } else if (blockType === 'faq_item') {
    document.getElementById('faq_item-question').value = content.question || '';
    document.getElementById('faq_item-answer').value = content.answer || '';
    document.getElementById('faq_item-button_text').value = content.button_text || '';
    document.getElementById('faq_item-button_url').value = content.button_url || '';
    document.getElementById('faq_item-button_style').value = content.button_style || 'btn btn-primary';
    document.getElementById('faq_item-button_size').value = content.button_size || '';
    document.getElementById('faq_item-badge_text').value = content.badge_text || '';
  } else if (blockType === 'link_group') {
    if (typeof linkGroupSetLinks === 'function') linkGroupSetLinks(content.links || []);
  } else if (blockType === 'countdown') {
    document.getElementById('countdown-days').value = content.days !== undefined ? String(content.days) : '';
    document.getElementById('countdown-hours').value = content.hours !== undefined ? String(content.hours) : '';
    document.getElementById('countdown-minutes').value = content.minutes !== undefined ? String(content.minutes) : '';
    document.getElementById('countdown-seconds').value = content.seconds !== undefined ? String(content.seconds) : '';
  } else if (blockType === 'newsletter') {
    document.getElementById('newsletter-placeholder').value = content.placeholder || '';
    document.getElementById('newsletter-button_text').value = content.button_text || 'SUBSCRIBE';
    document.getElementById('newsletter-form_action').value = content.form_action || '#';
  } else if (blockType === 'cta_card') {
    document.getElementById('cta_card-title').value = content.title || '';
    document.getElementById('cta_card-description').value = content.description || content.text || '';
    document.getElementById('cta_card-url').value = content.url || '';
    document.getElementById('cta_card-icon').value = content.icon || '';
  } else if (blockType === 'pricing_card') {
    document.getElementById('pricing_card-tag').value = content.tag || '';
    document.getElementById('pricing_card-tag_style').value = content.tag_style || 'default';
    document.getElementById('pricing_card-plan_name').value = content.plan_name || '';
    document.getElementById('pricing_card-plan_desc').value = content.plan_desc || '';
    document.getElementById('pricing_card-currency').value = content.currency || '‚ÇΩ';
    document.getElementById('pricing_card-price_month').value = content.price_month != null ? String(content.price_month) : '';
    document.getElementById('pricing_card-price_year').value = content.price_year != null ? String(content.price_year) : '';
    document.getElementById('pricing_card-price_unit').value = content.price_unit != null ? String(content.price_unit) : '';
    document.getElementById('pricing_card-term_month').value = content.term_month || '/mo';
    document.getElementById('pricing_card-term_year').value = content.term_year || '/yr';
    document.getElementById('pricing_card-term_unit').value = content.term_unit || '/—à—Ç';
    document.getElementById('pricing_card-card_background').value = content.card_background || 'default';
    document.getElementById('pricing_card-is_featured').checked = !!content.is_featured;
    document.getElementById('pricing_card-button_text').value = content.button_text || '';
    document.getElementById('pricing_card-button_url').value = content.button_url || '';
    document.getElementById('pricing_card-button_style').value = content.button_style || 'btn btn-secondary';
    if (typeof pricingFeaturesSet === 'function') pricingFeaturesSet(content.features || []);
  }
}

function toggleDocumentTypeCardFields(style) {
  const common = document.getElementById('doc-card-common');
  if (common) common.style.display = style === 'stat' ? 'none' : 'block';
  document.querySelectorAll('.doc-card-fields[data-card-style]').forEach(function(el) {
    const s = el.getAttribute('data-card-style');
    if (s === 'common') return;
    el.style.display = s === style ? 'block' : 'none';
  });
}

function closeBlockEditor() {
  destroyParagraphEditor();
  document.getElementById('blockEditorModal').style.display = 'none';
  currentEditingBlock = null;
}

async function saveBlockChanges() {
  const blockId = document.getElementById('editBlockId').value;
  const blockType = document.getElementById('editBlockType').value;
  
  let content = {};
  let cssClasses = '';
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –∞–∫—Ç–∏–≤–µ–Ω
  const activeEditor = Array.from(document.querySelectorAll('.block-editor-content')).find(el => el.style.display !== 'none');
  if (!activeEditor) {
    alert('–û—à–∏–±–∫–∞: —Ä–µ–¥–∞–∫—Ç–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
    return;
  }
  
  const activeEditorType = activeEditor.id.replace('editor-', '');
  
  // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
  if (activeEditorType === 'heading') {
    content = {
      text: document.getElementById('heading-text').value,
      level: parseInt(document.getElementById('heading-level').value),
      accent: document.getElementById('heading-accent').value
    };
    cssClasses = 'section-title';
  } else if (blockType === 'paragraph') {
    var paragraphHtml = typeof getParagraphEditorHtml === 'function' ? await getParagraphEditorHtml() : (document.getElementById('paragraph-tinymce') && document.getElementById('paragraph-tinymce').value) || '';
    content = { text: paragraphHtml || '' };
    cssClasses = 'section-text';
  } else if (blockType === 'button') {
    const style = document.getElementById('button-style').value;
    const size = document.getElementById('button-size').value;
    content = {
      text: document.getElementById('button-text').value,
      url: document.getElementById('button-url').value
    };
    cssClasses = `${style} ${size}`.trim();
  } else if (activeEditorType === 'feature_card') {
    content = {
      title: document.getElementById('feature_card-title').value,
      description: document.getElementById('feature_card-description').value,
      icon: document.getElementById('feature_card-icon').value,
      card_background: document.getElementById('feature_card-card_background').value || null
    };
    cssClasses = 'feature-card';
  } else if (blockType === 'stat_card') {
    content = {
      value: document.getElementById('stat_card-value').value,
      label: document.getElementById('stat_card-label').value,
      card_background: document.getElementById('stat_card-card_background').value || null
    };
    cssClasses = 'about-stat-card';
  } else if (activeEditorType === 'label') {
    content = {
      text: document.getElementById('label-text').value,
      badge_style: document.getElementById('label-badge_style').value || 'primary'
    };
    cssClasses = 'section-label';
  } else if (activeEditorType === 'note') {
    content = {
      text: document.getElementById('note-text').value,
      accent: document.getElementById('note-accent').value
    };
    cssClasses = 'hero-note';
  } else if (activeEditorType === 'document_type_card') {
    content = {
      name: document.getElementById('document_type_card-name').value,
      description: document.getElementById('document_type_card-description').value,
      url: document.getElementById('document_type_card-url').value || '#',
      card_style: document.getElementById('document_type_card-card_style').value,
      card_background: document.getElementById('document_type_card-card_background').value || null,
      card_width: document.getElementById('document_type_card-card_width').value || null,
      icon: document.getElementById('document_type_card-icon').value || null,
      tag: document.getElementById('document_type_card-tag').value || null,
      tag_badge_style: (document.getElementById('document_type_card-tag_badge_style') || {}).value || 'primary',
      label: document.getElementById('document_type_card-label').value || null,
      value: document.getElementById('document_type_card-value').value || null,
      change: document.getElementById('document_type_card-change').value || null,
      tag_promo: document.getElementById('document_type_card-tag_promo').value || null,
      meta: document.getElementById('document_type_card-meta').value || null,
      tag_article: document.getElementById('document_type_card-tag_article').value || null,
      meta_article: document.getElementById('document_type_card-meta_article').value || null,
      tag_info: document.getElementById('document_type_card-tag_info').value || null
    };
    cssClasses = 'document-type-card';
  } else if (blockType === 'contact_form') {
    content = {
      form_width: document.getElementById('contact_form-form_width').value || 'default',
      submit_text: document.getElementById('contact_form-submit_text').value || '–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ',
      fields: typeof formBuilderGetFields === 'function' ? formBuilderGetFields() : []
    };
    cssClasses = 'contact-form-v12';
  } else if (blockType === 'faq_item') {
    const btnStyle = document.getElementById('faq_item-button_style').value;
    const btnSize = document.getElementById('faq_item-button_size').value;
    content = {
      question: document.getElementById('faq_item-question').value,
      answer: document.getElementById('faq_item-answer').value,
      button_text: document.getElementById('faq_item-button_text').value || null,
      button_url: document.getElementById('faq_item-button_url').value || null,
      button_style: btnStyle || null,
      button_size: btnSize || null,
      badge_text: document.getElementById('faq_item-badge_text').value || null
    };
    cssClasses = '';
  } else if (blockType === 'link_group') {
    content = {
      links: typeof linkGroupGetLinks === 'function' ? linkGroupGetLinks() : []
    };
    cssClasses = '';
  } else if (blockType === 'countdown') {
    content = {
      days: document.getElementById('countdown-days').value || '00',
      hours: document.getElementById('countdown-hours').value || '00',
      minutes: document.getElementById('countdown-minutes').value || '00',
      seconds: document.getElementById('countdown-seconds').value || '00'
    };
    cssClasses = 'cta-countdown-block';
  } else if (blockType === 'newsletter') {
    content = {
      placeholder: document.getElementById('newsletter-placeholder').value || 'Enter your email',
      button_text: document.getElementById('newsletter-button_text').value || 'SUBSCRIBE',
      form_action: document.getElementById('newsletter-form_action').value || '#'
    };
    cssClasses = '';
  } else if (blockType === 'cta_card') {
    content = {
      title: document.getElementById('cta_card-title').value || '',
      description: document.getElementById('cta_card-description').value || '',
      url: document.getElementById('cta_card-url').value || '#',
      icon: document.getElementById('cta_card-icon').value || ''
    };
    cssClasses = 'kit-card kit-card--cta';
  } else if (blockType === 'pricing_card') {
    content = {
      tag: document.getElementById('pricing_card-tag').value || null,
      tag_style: document.getElementById('pricing_card-tag_style').value || 'default',
      plan_name: document.getElementById('pricing_card-plan_name').value || 'Plan',
      plan_desc: document.getElementById('pricing_card-plan_desc').value || '',
      currency: document.getElementById('pricing_card-currency').value || '‚ÇΩ',
      price_month: document.getElementById('pricing_card-price_month').value || null,
      price_year: document.getElementById('pricing_card-price_year').value || null,
      price_unit: document.getElementById('pricing_card-price_unit').value || null,
      term_month: document.getElementById('pricing_card-term_month').value || '/mo',
      term_year: document.getElementById('pricing_card-term_year').value || '/yr',
      term_unit: document.getElementById('pricing_card-term_unit').value || '/—à—Ç',
      card_background: document.getElementById('pricing_card-card_background').value || 'default',
      is_featured: document.getElementById('pricing_card-is_featured').checked,
      features: typeof pricingFeaturesGet === 'function' ? pricingFeaturesGet() : [],
      button_text: document.getElementById('pricing_card-button_text').value || '–í—ã–±—Ä–∞—Ç—å',
      button_url: document.getElementById('pricing_card-button_url').value || '#',
      button_style: document.getElementById('pricing_card-button_style').value || 'btn btn-secondary'
    };
    cssClasses = 'pricing-card';
  }
  
  markAsChanged();
  const idStr = String(blockId);
  if (idStr.startsWith('new-')) {
    if (pendingBlocks[idStr]) {
      pendingBlocks[idStr].content = content;
      pendingBlocks[idStr].css_classes = cssClasses;
    }
  } else {
    pendingEdits[parseInt(blockId, 10)] = { content: content, css_classes: cssClasses };
  }
  const previewEl = document.querySelector('.block-item[data-block-id="' + idStr.replace(/"/g, '\\"') + '"] .block-content-preview');
  if (previewEl) previewEl.innerHTML = getBlockPreviewText({ block_type: blockType, content: content, css_classes: cssClasses });
  closeBlockEditor();
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞: –¥–∞–Ω–Ω—ã–µ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è (pageStructure + pendingEdits / pendingBlocks)
window.editBlock = function(blockId) {
  const found = window.findBlock(blockId);
  if (!found || !found.block) {
    alert('–ë–ª–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω');
    return;
  }
  const blockData = { block_type: found.block.block_type, content: found.block.content || {}, css_classes: found.block.css_classes || '' };
  openBlockEditor(blockId, blockData);
}

// ============================================================================
// Add Block Modal
// ============================================================================

function openAddBlockModal(sectionId) {
  document.getElementById('addBlockSectionId').value = sectionId;
  document.getElementById('addBlockType').value = 'paragraph';
  document.getElementById('addBlockModal').style.display = 'flex';
}

function closeAddBlockModal() {
  document.getElementById('addBlockModal').style.display = 'none';
}

async function confirmAddBlock() {
  const sectionId = document.getElementById('addBlockSectionId').value;
  const blockType = document.getElementById('addBlockType').value;
  
  // –î–µ—Ñ–æ–ª—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞
  const defaultContent = {
    heading: {text: 'New Heading', level: 2},
    paragraph: {text: 'New paragraph text'},
    button: {text: 'Click Here', url: '#'},
    feature_card: {title: '–ù–æ–≤–∞—è —Ñ–∏—á–∞', description: '–û–ø–∏—Å–∞–Ω–∏–µ —Ñ–∏—á–∏', icon: 'check-circle', card_background: ''},
    stat_card: {value: '0', label: '–ü–æ–¥–ø–∏—Å—å', card_background: ''},
    document_type_card: {name: '–ö–∞—Ä—Ç–æ—á–∫–∞', description: '–û–ø–∏—Å–∞–Ω–∏–µ', url: '/', card_style: 'default', card_background: '', card_width: '', icon: 'check-circle', tag: '', tag_badge_style: 'primary', label: '', value: '', change: '', meta: '', tag_promo: '', tag_article: '', meta_article: '', tag_info: ''},
    label: {text: '–û –Ω–∞—Å', badge_style: 'primary'},
    note: {text: 'Note text'},
    contact_form: {
      form_width: 'default',
      submit_text: '–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ',
      fields: [
        { type: 'text', name: 'name', label: '–í–∞—à–µ –∏–º—è', placeholder: '–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤', required: true },
        { type: 'email', name: 'email', label: 'Email', placeholder: 'ivan@example.com', required: true },
        { type: 'tel', name: 'phone', label: '–¢–µ–ª–µ—Ñ–æ–Ω', placeholder: '+7 (999) 123-45-67', required: false },
        { type: 'text', name: 'subject', label: '–¢–µ–º–∞', placeholder: '–í–æ–ø—Ä–æ—Å –ø–æ —Ä–∞–±–æ—Ç–µ —Å–µ—Ä–≤–∏—Å–∞', required: true },
        { type: 'textarea', name: 'message', label: '–°–æ–æ–±—â–µ–Ω–∏–µ', placeholder: '–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ...', required: true, rows: 5 }
      ]
    },
    faq_item: { question: '–ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å', answer: '<p>–û—Ç–≤–µ—Ç...</p>', button_text: '', button_url: '', button_style: 'btn btn-primary', button_size: '', badge_text: '' },
    link_group: {
      links: [
        { text: '–£–ü–î –¥–ª—è –û–û–û', url: '/upd/' },
        { text: '–£–ü–î –¥–ª—è –ò–ü', url: '/upd/' },
        { text: '–£–ü–î —Å –ù–î–°', url: '/upd/' },
        { text: '–£–ü–î –±–µ–∑ –ù–î–°', url: '/upd/' },
        { text: '–î–ª—è —Å–∞–º–æ–∑–∞–Ω—è—Ç—ã—Ö', url: '/upd/' }
      ]
    },
    countdown: { days: '12', hours: '08', minutes: '34', seconds: '56' },
    newsletter: { placeholder: 'Enter your email', button_text: 'SUBSCRIBE', form_action: '#' },
    cta_card: { title: 'QUICK START', description: 'Get up and running in minutes.', url: '/docs/', icon: 'bolt' },
    pricing_card: {
      tag: '', tag_style: 'default', plan_name: 'STARTER', plan_desc: 'For small teams',
      currency: '‚ÇΩ', price_month: '29', price_year: '', price_unit: '',
      term_month: '/mo', term_year: '/yr', term_unit: '/—à—Ç',
      card_background: 'default', is_featured: false,
      features: [
        { text: 'Up to 5 users', enabled: true },
        { text: '10 GB storage', enabled: true },
        { text: 'Basic analytics', enabled: true },
        { text: 'AI features', enabled: false },
        { text: 'Priority support', enabled: false }
      ],
      button_text: '–í—ã–±—Ä–∞—Ç—å', button_url: '/register/', button_style: 'btn btn-secondary'
    }
  };
  
  const defaultClasses = {
    heading: 'section-title',
    paragraph: 'section-subtitle',
    button: 'btn btn-primary',
    feature_card: 'feature-card',
    stat_card: 'about-stat-card',
    document_type_card: 'document-type-card',
    label: 'section-label',
    note: 'hero-note',
    contact_form: 'contact-form-v12',
    faq_item: '',
    link_group: '',
    countdown: 'cta-countdown-block',
    newsletter: '',
    cta_card: 'kit-card kit-card--cta',
    pricing_card: 'pricing-card'
  };
  
  const content = defaultContent[blockType] || { text: 'New block' };
  const cssClasses = defaultClasses[blockType] || '';
  const tempId = 'new-' + sectionId + '-' + (nextNewBlockId++);
  pendingBlocks[tempId] = { block_type: blockType, content: content, css_classes: cssClasses };
  markAsChanged();
  closeAddBlockModal();

  const container = document.querySelector('.blocks-container[data-section-id="' + sectionId + '"]');
  if (container) {
    const block = { block_type: blockType, content: content, css_classes: cssClasses };
    const previewText = getBlockPreviewText(block);
    const isComplex = ['pricing_table', 'upd_types_grid'].includes(blockType);
    const div = document.createElement('div');
    div.className = 'block-item' + (isComplex ? ' block-item-complex' : '');
    div.dataset.blockId = tempId;
    const editOnclick = !isComplex ? 'editBlock(\'' + tempId.replace(/'/g, "\\'") + '\')' : '';
    div.innerHTML = `
      <div class="block-header">
        <span class="block-drag-handle" title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞"><iconify-icon icon="ri:drag-move-2-line" width="18"></iconify-icon></span>
        <span class="block-type">${escapeHtml(blockType)}</span>
        ${isComplex ? '<span class="block-badge-complex">Complex Block</span>' : ''}
        <div class="block-actions">
          ${!isComplex ? '<button class="block-btn" onclick="' + editOnclick + '" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"><iconify-icon icon="ri:edit-line" width="16"></iconify-icon></button>' : ''}
          <button class="block-btn danger" onclick="deleteBlock(\'' + tempId.replace(/'/g, "\\'") + '\')" title="–£–¥–∞–ª–∏—Ç—å"><iconify-icon icon="ri:delete-bin-line" width="16"></iconify-icon></button>
        </div>
      </div>
      <div class="block-content block-content-preview">${previewText}</div>
    `;
    const addBtn = container.querySelector('.btn.btn-outline');
    container.insertBefore(div, addBtn);
  }
}

function getBlockPreviewText(block) {
  const c = block.content || {};
  const trunc = (s, len) => String(s == null ? '' : s).substring(0, len || 100);
  if (block.block_type === 'document_type_card') {
    return '<span style="color: #64748b;">–ö–∞—Ä—Ç–æ—á–∫–∞:</span> ' + escapeHtml(trunc(c.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è', 40)) + ' ‚Äî —Å—Ç–∏–ª—å ¬´' + escapeHtml(String(c.card_style || 'default')) + '¬ª';
  }
  if (block.block_type === 'contact_form') {
    const n = (c.fields && c.fields.length) ? c.fields.length : 5;
    return '<span style="color: #64748b;">–§–æ—Ä–º–∞</span> (' + n + ' –ø–æ–ª–µ–π)';
  }
  if (block.block_type === 'faq_item') return '<span style="color: #64748b;">FAQ:</span> ' + escapeHtml(trunc(c.question || '–í–æ–ø—Ä–æ—Å', 50));
  if (block.block_type === 'link_group') {
    var n = (c.links && c.links.length) ? c.links.length : 0;
    return '<span style="color: #64748b;">Link group</span> (' + n + ' —Å—Å—ã–ª–æ–∫)';
  }
  if (block.block_type === 'countdown') {
    return '<span style="color: #64748b;">–¢–∞–π–º–µ—Ä</span> ' + [c.days, c.hours, c.minutes, c.seconds].map(function(x){ return x || '0'; }).join(':');
  }
  if (block.block_type === 'newsletter') return '<span style="color: #64748b;">–ü–æ–¥–ø–∏—Å–∫–∞</span> ' + escapeHtml(trunc(c.placeholder || 'email', 30));
  if (block.block_type === 'cta_card') return '<span style="color: #64748b;">CTA –∫–∞—Ä—Ç–æ—á–∫–∞:</span> ' + escapeHtml(trunc(c.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è', 40));
  if (block.block_type === 'pricing_card') return '<span style="color: #64748b;">–¢–∞—Ä–∏—Ñ:</span> ' + escapeHtml(trunc(c.plan_name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è', 40));
  if (block.block_type === 'heading') return escapeHtml(trunc(c.text || '–ë–ª–æ–∫ –∫–æ–Ω—Ç–µ–Ω—Ç–∞'));
  if (block.block_type === 'paragraph') return escapeHtml(trunc(c.text || '–ë–ª–æ–∫ –∫–æ–Ω—Ç–µ–Ω—Ç–∞'));
  return escapeHtml(trunc(c.text || c.title || c.name || c.question || '–ë–ª–æ–∫ –∫–æ–Ω—Ç–µ–Ω—Ç–∞'));
}

function escapeHtml(str) {
  if (str == null) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é addBlockToSection
window.addBlockToSection = function(sectionId) {
  openAddBlockModal(sectionId);
}
</script>

{% endblock %}
