{% extends "admin/base_admin.html" %}

{% block title %}{% if is_edit %}Редактировать{% else %}Создать{% endif %} промокод{% endblock %}
{% block page_title %}{% if is_edit %}Редактировать промокод {{ promocode.code }}{% else %}Создать промокод{% endif %}{% endblock %}

{% block header_actions %}
<a href="/admin/promocodes/" class="btn btn-outline">
  <iconify-icon icon="ri:arrow-left-line" width="16"></iconify-icon>
  Назад к списку
</a>
{% endblock %}

{% block content %}
<div class="admin-core">
  <div class="form-card form-card--standalone form-card--narrow">
    {% if error %}
    <div class="form-error">{{ error }}</div>
    {% endif %}

    <form method="POST" action="{% if is_edit %}/admin/promocodes/{{ promocode.id }}/edit{% else %}/admin/promocodes/create{% endif %}">
      <div class="form-group">
        <label class="label" for="promo-code">Код промокода</label>
        {% if is_edit %}
        <input type="text" id="promo-code" class="input input--mono" value="{{ promocode.code }}" disabled style="text-transform: uppercase; font-weight: 700;">
        <p class="form-hint">Код нельзя изменить после создания</p>
        {% else %}
        <input type="text" name="code" id="promo-code" class="input input--mono" placeholder="BESTCLIENT" required style="text-transform: uppercase; font-weight: 700;">
        <p class="form-hint">Латинские буквы и цифры, без пробелов</p>
        {% endif %}
      </div>

      <div class="form-group">
        <label class="label" for="promo_type">Тип промокода</label>
        {% if is_edit %}
        <input type="text" class="input" value="{% if promocode.promo_type == 'subscription' %}Подписка{% elif promocode.promo_type == 'documents' %}Документы{% else %}Скидка{% endif %}" disabled>
        {% else %}
        <select name="promo_type" id="promo_type" class="input" required onchange="toggleTypeFields()">
          <option value="">Выберите тип</option>
          <option value="subscription">Подписка (активирует подписку)</option>
          <option value="documents">Документы (добавляет документы)</option>
          <option value="discount">Скидка (на оплату)</option>
        </select>
        {% endif %}
      </div>

      <div id="subscription-fields" class="form-group form-group--toggle" style="display: {% if is_edit and promocode.promo_type == 'subscription' %}block{% else %}none{% endif %};">
        <div class="form-row">
          <div class="form-group">
            <label class="label" for="subscription_days">Дней подписки</label>
            <input type="number" name="subscription_days" id="subscription_days" class="input" value="{{ promocode.subscription_days if is_edit and promocode else 30 }}" min="1" placeholder="30">
          </div>
          <div class="form-group">
            <label class="label" for="subscription_price">Цена (руб.)</label>
            <input type="number" name="subscription_price" id="subscription_price" class="input" value="{{ promocode.subscription_price if is_edit and promocode else '' }}" min="0" placeholder="0 = бесплатно">
            <p class="form-hint">0 или пусто = бесплатная подписка</p>
          </div>
        </div>
      </div>

      <div id="documents-fields" class="form-group form-group--toggle" style="display: {% if is_edit and promocode.promo_type == 'documents' %}block{% else %}none{% endif %};">
        <label class="label" for="documents_count">Количество документов</label>
        <input type="number" name="documents_count" id="documents_count" class="input" value="{{ promocode.documents_count if is_edit and promocode else 10 }}" min="1" placeholder="10">
      </div>

      <div id="discount-fields" class="form-group form-group--toggle" style="display: {% if is_edit and promocode.promo_type == 'discount' %}block{% else %}none{% endif %};">
        <label class="label" for="discount_percent">Процент скидки</label>
        <input type="number" name="discount_percent" id="discount_percent" class="input" value="{{ promocode.discount_percent if is_edit and promocode else 10 }}" min="1" max="100" placeholder="10">
      </div>

      <div class="form-group">
        <label class="label" for="description">Описание (для админки)</label>
        <input type="text" name="description" id="description" class="input" value="{{ promocode.description if is_edit and promocode else '' }}" placeholder="Промокод для партнёров">
      </div>

      <div class="form-group">
        <label class="label">Настройки</label>
        <div class="form-row">
          <label class="checkbox-label">
            <input type="checkbox" name="is_reusable" value="true" {% if not is_edit or promocode.is_reusable %}checked{% endif %}>
            <span>Многоразовый (разные аккаунты)</span>
          </label>
          {% if is_edit %}
          <label class="checkbox-label">
            <input type="checkbox" name="is_active" value="true" {% if promocode.is_active %}checked{% endif %}>
            <span>Активен</span>
          </label>
          {% endif %}
        </div>
      </div>

      <div class="form-group">
        <label class="label">Ограничения</label>
        <div class="form-row">
          <div class="form-group">
            <label class="label" for="max_uses">Макс. использований</label>
            <input type="number" name="max_uses" id="max_uses" class="input" value="{{ promocode.max_uses if is_edit and promocode and promocode.max_uses else '' }}" min="1" placeholder="Без лимита">
            <p class="form-hint">Пусто = без ограничений</p>
          </div>
          <div class="form-group">
            <label class="label" for="valid_until">Действует до</label>
            <input type="date" name="valid_until" id="valid_until" class="input" value="{{ promocode.valid_until.strftime('%Y-%m-%d') if is_edit and promocode and promocode.valid_until else '' }}">
            <p class="form-hint">Пусто = бессрочно</p>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">
          <iconify-icon icon="{% if is_edit %}ri:save-line{% else %}ri:add-line{% endif %}" width="16"></iconify-icon>
          {% if is_edit %}Сохранить{% else %}Создать промокод{% endif %}
        </button>
        <a href="/admin/promocodes/" class="btn btn-outline">Отмена</a>
      </div>
    </form>
  </div>
</div>

<script>
function toggleTypeFields() {
  const type = document.getElementById('promo_type').value;
  
  document.getElementById('subscription-fields').style.display = type === 'subscription' ? 'block' : 'none';
  document.getElementById('documents-fields').style.display = type === 'documents' ? 'block' : 'none';
  document.getElementById('discount-fields').style.display = type === 'discount' ? 'block' : 'none';
}
</script>
{% endblock %}
