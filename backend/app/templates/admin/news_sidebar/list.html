{% extends "admin/base_admin.html" %}

{% block title %}Сайдбар новостей{% endblock %}
{% block page_title %}Сайдбар новостей{% endblock %}

{% block content %}
{% if request.query_params.get('saved') %}
<div class="admin-alert admin-alert-success" style="margin-bottom: 1.5rem;">
  <iconify-icon icon="ri:checkbox-circle-line" width="22"></iconify-icon>
  Элемент добавлен
</div>
{% endif %}
{% if request.query_params.get('error') == 'type' %}
<div class="admin-alert admin-alert-error" style="margin-bottom: 1.5rem;">
  Выберите тип блока.
</div>
{% endif %}

<div class="admin-core">
  <div class="news-sidebar-add-card" style="background: var(--color-white); border: 1px solid var(--color-slate-200); border-radius: var(--radius-2xl); padding: 1.5rem; margin-bottom: 1.5rem;">
    <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--color-slate-500); margin-bottom: 1rem;">Добавить блок в сайдбар</div>
    <form method="POST" action="/admin/news-sidebar/add/" style="display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end;">
      <div>
        <label class="label" style="display: block; font-size: 13px; font-weight: 500; margin-bottom: 4px;">Тип блока</label>
        <select name="block_type" id="sidebar-block-type" class="input" style="min-width: 220px; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--color-slate-200);">
          <option value="cta_card">Блок CTA (призыв)</option>
          <option value="related_articles">Похожие статьи</option>
          <option value="shortcode">Шорткод</option>
        </select>
      </div>
      <div id="sidebar-shortcode-wrap" style="display: none;">
        <label class="label" style="display: block; font-size: 13px; font-weight: 500; margin-bottom: 4px;">Шорткод</label>
        <select name="shortcode_id" class="input" style="min-width: 200px; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--color-slate-200);">
          <option value="">— Выберите —</option>
          {% for sc in shortcodes %}
          <option value="{{ sc.id }}">[{{ sc.name }}] {{ sc.title }}</option>
          {% endfor %}
        </select>
      </div>
      <button type="submit" class="btn btn-primary">Добавить</button>
    </form>
    <p class="form-hint" style="font-size: 12px; color: var(--color-slate-500); margin-top: 10px;">Порядок можно менять кнопками «Вверх» / «Вниз». Сайдбар общий для всех статей раздела «Новости».</p>
  </div>

  <div class="table-wrapper">
    <table class="table table--compact">
      <thead>
        <tr>
          <th style="width: 60px;">Порядок</th>
          <th>Тип</th>
          <th>Шорткод / примечание</th>
          <th style="width: 140px;">Действия</th>
        </tr>
      </thead>
      <tbody>
        {% for item in items %}
        <tr>
          <td>{{ loop.index }}</td>
          <td><span class="admin-badge admin-badge-primary">{{ block_type_labels.get(item.block_type, item.block_type) }}</span></td>
          <td>
            {% if item.block_type == 'shortcode' and item.shortcode %}
            <code>[{{ item.shortcode.name }}]</code> {{ item.shortcode.title }}
            {% elif item.block_type == 'cta_card' %}
            Фиксированный блок «Создайте УПД»
            {% elif item.block_type == 'related_articles' %}
            Блок «Похожие статьи» (по категории)
            {% else %}
            —
            {% endif %}
          </td>
          <td>
            <div class="table-actions">
              <form action="/admin/news-sidebar/{{ item.id }}/move-up/" method="POST" style="display: inline;">
                <button type="submit" class="table-action" title="Выше">&#9650;</button>
              </form>
              <form action="/admin/news-sidebar/{{ item.id }}/move-down/" method="POST" style="display: inline;">
                <button type="submit" class="table-action" title="Ниже">&#9660;</button>
              </form>
              <form action="/admin/news-sidebar/{{ item.id }}/delete/" method="POST" style="display: inline;" onsubmit="return confirm('Удалить блок из сайдбара?');">
                <button type="submit" class="table-action" title="Удалить">
                  <iconify-icon icon="ri:delete-bin-line" width="16"></iconify-icon>
                </button>
              </form>
            </div>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="4" style="text-align: center; padding: 3rem;">
            <div class="admin-empty-state">
              <iconify-icon icon="ri:layout-right-line" width="48" style="color: var(--color-slate-300);"></iconify-icon>
              <div class="admin-empty-state-title">Сайдбар пуст</div>
              <div class="admin-empty-state-text">Добавьте блоки выше. На страницах статей будет показываться только контент без сайдбара, пока список пуст.</div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
(function() {
  var typeSelect = document.getElementById('sidebar-block-type');
  var shortcodeWrap = document.getElementById('sidebar-shortcode-wrap');
  if (!typeSelect || !shortcodeWrap) return;
  function toggle() {
    shortcodeWrap.style.display = typeSelect.value === 'shortcode' ? 'block' : 'none';
  }
  typeSelect.addEventListener('change', toggle);
  toggle();
})();
</script>
{% endblock %}
