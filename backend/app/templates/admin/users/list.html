{% extends "admin/base_admin.html" %}

{% block title %}Пользователи{% endblock %}
{% block page_title %}Пользователи{% endblock %}

{% block header_actions %}
<div class="admin-header-meta">
  Всего: <strong>{{ total_users }}</strong>
</div>
{% endblock %}

{% block content %}
{% if deleted %}
<div class="admin-alert admin-alert-success" role="alert">
  Пользователь удалён.
</div>
{% endif %}
<div class="admin-core">
  {% if users %}
  <div class="table-wrapper">
    <table class="table table--striped table--users">
      <thead>
        <tr>
          <th>Пользователь</th>
          <th>Тариф</th>
          <th>Документов</th>
          <th>Дата регистрации</th>
          <th>Последний вход</th>
          <th>Телефон</th>
          <th>Статус</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
        <tr>
          <td>
            <a href="/admin/users/{{ user.id }}/" class="table-user-link">
              {{ user.email }}
              {% if user.auth_provider == 'yandex' %}
              <span class="badge badge--yandex">Y</span>
              {% elif user.auth_provider == 'google' %}
              <span class="badge badge--google">G</span>
              {% endif %}
            </a>
            <div class="table__muted table-user-meta">ID: {{ user.id }}{% if user.name %} / {{ user.name }}{% endif %}</div>
          </td>
          <td>
            {% set tariff = user.tariff or 'free' %}
            {% if tariff == 'subscription' %}
            <span class="badge badge--gold">
              <iconify-icon icon="ri:vip-crown-line" width="14"></iconify-icon>
              Подписка
            </span>
            {% if user.subscription_expires %}
            <div class="table__muted table-tariff-meta">до {{ user.subscription_expires[:10] }}</div>
            {% endif %}
            {% elif tariff == 'pay_per_doc' %}
            <span class="badge badge--purple">
              <iconify-icon icon="ri:file-list-3-line" width="14"></iconify-icon>
              Пакет
            </span>
            {% if user.purchased_docs_remaining is not none %}
            <div class="table__muted table-tariff-meta">{{ user.purchased_docs_remaining }} док.</div>
            {% endif %}
            {% else %}
            <span class="badge badge--neutral">Free</span>
            <div class="table__muted table-tariff-meta">{{ user.free_generations_used or 0 }}/5</div>
            {% endif %}
          </td>
          <td>
            <span class="table-docs-count">{{ user.documents_count }}</span>
            <span class="table__muted">шт</span>
          </td>
          <td class="table__muted">
            {{ user.created_at[:10] if user.created_at else '—' }}
          </td>
          <td class="table__muted">
            {% if user.last_login %}
            {{ user.last_login[:16].replace('T', ' ') }}
            {% else %}
            —
            {% endif %}
          </td>
          <td class="table__muted">
            {{ user.phone if user.phone else '—' }}
          </td>
          <td>
            {% if user.is_verified %}
            <span class="badge badge--success">
              <iconify-icon icon="ri:checkbox-circle-fill" width="14"></iconify-icon>
              Подтверждён
            </span>
            {% else %}
            <span class="badge badge--warning">
              <iconify-icon icon="ri:time-line" width="14"></iconify-icon>
              Не подтверждён
            </span>
            {% endif %}
          </td>
          <td>
            <a href="/admin/users/delete/{{ user.id }}/" class="btn btn-danger btn-sm" title="Удалить" onclick="return confirm('Удалить пользователя {{ user.email }}? Связанные платежи и использования будут удалены.');">
                <iconify-icon icon="ri:delete-bin-line" width="16"></iconify-icon>
              Удалить
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="admin-empty">
    <iconify-icon icon="ri:user-unfollow-line" width="64" class="admin-empty__icon"></iconify-icon>
    <h3 class="admin-empty__title">Пользователи не найдены</h3>
    <p class="admin-empty__text">Зарегистрированные пользователи появятся здесь</p>
  </div>
  {% endif %}
</div>

{% if total_pages > 1 %}
<div class="admin-pagination">
  {% if page > 1 %}
  <a href="?page={{ page - 1 }}" class="btn btn-ghost btn-sm">
    <iconify-icon icon="ri:arrow-left-s-line" width="20"></iconify-icon>
  </a>
  {% endif %}
  {% for p in range(1, total_pages + 1) %}
  <a href="?page={{ p }}" class="btn btn-ghost btn-sm {% if p == page %}active{% endif %}">{{ p }}</a>
  {% endfor %}
  {% if page < total_pages %}
  <a href="?page={{ page + 1 }}" class="btn btn-ghost btn-sm">
    <iconify-icon icon="ri:arrow-right-s-line" width="20"></iconify-icon>
  </a>
  {% endif %}
</div>
{% endif %}
{% endblock %}
