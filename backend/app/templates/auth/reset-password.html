{% extends "base.html" %}

{% block title %}Новый пароль — Documatica{% endblock %}

{% block body_class %}auth-page{% endblock %}

{% block body %}
<div class="auth-page-v12">
  <div class="auth-card-v12">
    <!-- Header -->
    <div class="auth-header-v12">
      <a href="/" class="auth-logo-v12">
        <svg viewBox="0 0 64 64">
          <path d="M12 16H48V48H12V16Z" fill="#3b82f6" fill-opacity="0.1"/>
          <path d="M18 24H46M18 32H46M18 40H34" stroke="#3b82f6" stroke-width="6" stroke-linecap="round"/>
          <circle cx="48" cy="40" r="6" fill="#FBBF24"/>
        </svg>
        <span class="logo-text">
          <span class="logo-bold">docu</span><span class="logo-light">matica</span>
        </span>
      </a>
      <h1 class="auth-title-v12">Новый пароль</h1>
      <p class="auth-subtitle-v12">Придумайте надежный пароль для вашего аккаунта</p>
    </div>
    
    <!-- Error Message (hidden by default) -->
    <div id="error-message" class="auth-message-v12 error" style="display: none;">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="15" y1="9" x2="9" y2="15"></line>
        <line x1="9" y1="9" x2="15" y2="15"></line>
      </svg>
      <div>
        <strong>Ошибка</strong>
        <p id="error-text">Ссылка недействительна или устарела</p>
      </div>
    </div>
    
    <!-- Success Message (hidden by default) -->
    <div id="success-message" class="auth-message-v12 success" style="display: none;">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
        <polyline points="22 4 12 14.01 9 11.01"></polyline>
      </svg>
      <div>
        <strong>Пароль изменен!</strong>
        <p>Теперь вы можете войти с новым паролем</p>
        <a href="/login/" class="auth-link-btn">Войти в аккаунт</a>
      </div>
    </div>
    
    <!-- Form -->
    <form id="reset-form" class="auth-form-v12">
      <div class="auth-field-v12">
        <label class="auth-label-v12">Новый пароль</label>
        <div class="password-wrapper">
          <input type="password" class="auth-input-v12" name="password" required minlength="8" placeholder="Минимум 8 символов">
          <button type="button" class="password-toggle" onclick="togglePassword(this)">
            <svg class="eye-open" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
            <svg class="eye-closed" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none">
              <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
              <line x1="1" y1="1" x2="23" y2="23"></line>
            </svg>
          </button>
        </div>
      </div>
      
      <div class="auth-field-v12">
        <label class="auth-label-v12">Подтвердите пароль</label>
        <input type="password" class="auth-input-v12" name="confirm_password" required placeholder="Повторите пароль">
      </div>
      
      <button type="submit" class="auth-btn-v12">
        Сохранить пароль
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
          <polyline points="17 21 17 13 7 13 7 21"></polyline>
          <polyline points="7 3 7 8 15 8"></polyline>
        </svg>
      </button>
    </form>
    
    <!-- System Status -->
    <div class="auth-status-v12">
      <div class="status-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
        </svg>
      </div>
      <span class="status-text">Secure Connection</span>
    </div>
  </div>
</div>

<script>
function togglePassword(btn) {
  const wrapper = btn.closest('.password-wrapper');
  const input = wrapper.querySelector('input');
  const eyeOpen = btn.querySelector('.eye-open');
  const eyeClosed = btn.querySelector('.eye-closed');
  
  if (input.type === 'password') {
    input.type = 'text';
    eyeOpen.style.display = 'none';
    eyeClosed.style.display = 'block';
  } else {
    input.type = 'password';
    eyeOpen.style.display = 'block';
    eyeClosed.style.display = 'none';
  }
}

document.getElementById('reset-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const form = e.target;
  const btn = form.querySelector('button[type="submit"]');
  const password = form.querySelector('input[name="password"]').value;
  const confirmPassword = form.querySelector('input[name="confirm_password"]').value;
  
  // Validate passwords match
  if (password !== confirmPassword) {
    toastError('Пароли не совпадают');
    return;
  }
  
  // Get token from URL
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token');
  
  if (!token) {
    document.getElementById('error-text').textContent = 'Токен не найден в URL';
    document.getElementById('error-message').style.display = 'flex';
    form.style.display = 'none';
    return;
  }
  
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Сохранение...';
  
  try {
    const response = await fetch('/api/v1/auth/reset-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token, new_password: password })
    });
    
    const data = await response.json();
    
    if (response.ok) {
      form.style.display = 'none';
      document.getElementById('success-message').style.display = 'flex';
    } else {
      // Handle different error formats
      let errorMsg = 'Ссылка недействительна или устарела';
      if (data.detail) {
        if (typeof data.detail === 'string') {
          errorMsg = data.detail;
        } else if (Array.isArray(data.detail)) {
          // Pydantic validation error format
          errorMsg = data.detail.map(e => e.msg).join(', ');
        } else if (typeof data.detail === 'object' && data.detail.msg) {
          errorMsg = data.detail.msg;
        }
      }
      document.getElementById('error-text').textContent = errorMsg;
      document.getElementById('error-message').style.display = 'flex';
      form.style.display = 'none';
    }
  } catch (error) {
    toastError('Ошибка соединения');
    btn.disabled = false;
    btn.innerHTML = 'Сохранить пароль <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path></svg>';
  }
});
</script>

<style>
.auth-message-v12 {
  display: flex;
  align-items: flex-start;
  gap: 1rem;
  padding: 1.5rem;
  border-radius: 1rem;
  margin-bottom: 1.5rem;
}
.auth-message-v12.success {
  background: rgba(34, 197, 94, 0.1);
  border: 1px solid rgba(34, 197, 94, 0.2);
  color: #16a34a;
}
.auth-message-v12.error {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.2);
  color: #dc2626;
}
.auth-message-v12 svg {
  flex-shrink: 0;
  margin-top: 2px;
}
.auth-message-v12 strong {
  display: block;
  margin-bottom: 0.25rem;
}
.auth-message-v12 p {
  margin: 0;
  font-size: 0.875rem;
  opacity: 0.9;
}
.auth-link-btn {
  display: inline-block;
  margin-top: 1rem;
  padding: 0.5rem 1rem;
  background: #16a34a;
  color: white;
  border-radius: 0.5rem;
  text-decoration: none;
  font-weight: 600;
  font-size: 0.875rem;
}
.auth-link-btn:hover {
  background: #15803d;
}
.password-wrapper {
  position: relative;
}
.password-toggle {
  position: absolute;
  right: 1rem;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  cursor: pointer;
  padding: 0.25rem;
  color: #94a3b8;
}
.password-toggle:hover {
  color: #64748b;
}
.spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
{% endblock %}
