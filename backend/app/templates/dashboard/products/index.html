{% extends "base_dashboard_v12.html" %}

{% block content %}
<!-- Page Header -->
<header class="page-header-v12">
  <div class="page-header-left-v12">

    <h1 class="page-title-v12">Товары и услуги</h1>
    <p class="page-subtitle-v12">Справочник товаров и услуг</p>
  </div>
  <div class="page-header-right-v12">
    <a href="/dashboard/products/create/" class="btn-primary-v12">
      <iconify-icon icon="mdi:plus" class="me-1"></iconify-icon>
      Добавить
    </a>
    <button type="button" class="btn-outline-v12" data-bs-toggle="modal" data-bs-target="#importModal">
      <iconify-icon icon="mdi:file-excel" class="me-1"></iconify-icon>
      Импорт Excel
    </button>
  </div>
</header>

<!-- Search -->
<div class="card radius-8 border-0 shadow-sm mb-24">
  <div class="card-body p-16">
    <input type="text" class="form-control" placeholder="Поиск..." style="width: 250px;" id="search-input">
  </div>
</div>

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content radius-8">
      <div class="modal-header">
        <h6 class="modal-title">Импорт товаров из Excel</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="text-secondary-light mb-16">
          Загрузите файл Excel (.xlsx) с товарами. 
          <a href="/api/v1/products/template/download">Скачайте шаблон</a> для правильного формата.
        </p>
        <div class="mb-3">
          <label class="form-label">Файл Excel</label>
          <input type="file" class="form-control" id="import-file" accept=".xlsx,.xls">
        </div>
        <div id="import-result" class="alert d-none"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-outline-v12" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn-primary-v12" id="import-btn">
          <iconify-icon icon="mdi:upload" class="me-1"></iconify-icon>
          Импортировать
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Products Table -->
<div class="section-card-v12">
  <div class="section-header-v12">
    <h2 class="section-title-v12">Товары и услуги</h2>
  </div>
  <table class="data-table-v12" id="products-table">
        <thead>
          <tr>
            <th>Наименование</th>
            <th>Ед. изм.</th>
            <th>Цена</th>
            <th>НДС</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody id="products-body">
          <!-- Products will be loaded here -->
    </tbody>
  </table>
  
  <div id="empty-state" class="empty-state-v12" style="display: none;">
    <div class="icon">
      <svg viewBox="0 0 24 24" width="64" height="64" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M3 3h18v18H3z"></path>
        <path d="M9 9h6M9 15h6"></path>
      </svg>
    </div>
    <div class="title">Товаров пока нет</div>
    <div class="description">Создайте первый товар или импортируйте из Excel</div>
    <a href="/dashboard/products/create/" class="btn-primary-v12">
      <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
      Добавить товар
    </a>
  </div>
      <iconify-icon icon="mdi:package-variant" class="text-5xl text-secondary-light mb-16 d-block"></iconify-icon>
      <h6 class="mb-8">Товаров и услуг пока нет</h6>
      <p class="text-secondary-light mb-16">Добавьте товары для быстрого добавления в документы</p>

</div>

<script>
document.addEventListener('DOMContentLoaded', async function() {
  try {
    console.log('Загрузка товаров...');
    const response = await fetch('/api/v1/products/', {
      credentials: 'include'
    });
    console.log('Response status:', response.status);
    
    const products = await response.json();
    console.log('Получено товаров:', products.length, products);
    
    const tbody = document.getElementById('products-body');
    const emptyState = document.getElementById('empty-state');
    const table = document.getElementById('products-table');
    
    if (products.length === 0) {
      console.log('Товаров нет, показываю empty state');
      table.style.display = 'none';
      emptyState.style.display = 'block';
      return;
    }
    
    console.log('Отрисовка товаров...');
    products.forEach(p => {
      const row = document.createElement('tr');
      row.style.cursor = 'pointer';
      row.onclick = function(e) {
        if (!e.target.closest('button')) {
          window.location.href = `/dashboard/products/edit/${p.id}/`;
        }
      };
      row.innerHTML = `
        <td><strong>${p.name}</strong></td>
        <td>${p.unit || 'шт'}</td>
        <td>${formatCurrency(p.price || 0)}</td>
        <td>${formatVat(p.vat_rate)}</td>
        <td>
          <div class="d-flex gap-1">
            <button class="btn-outline-v12 btn-sm" title="Удалить" onclick="event.stopPropagation(); deleteProduct('${p.id}')">
              <iconify-icon icon="mdi:delete"></iconify-icon>
            </button>
          </div>
        </td>
      `;
      tbody.appendChild(row);
    });
    console.log('Товары отрисованы');
  } catch (error) {
    console.error('Error loading products:', error);
  }
});

function formatCurrency(value) {
  return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB' }).format(value);
}

function formatVat(rate) {
  if (rate === undefined || rate === null) return '20%'; // По умолчанию
  if (rate === -1) return 'Без НДС';
  return rate + '%';
}

async function deleteProduct(id) {
  if (!confirm('Удалить товар/услугу?')) return;
  
  try {
    await fetch(`/api/v1/products/${id}`, { 
      method: 'DELETE',
      credentials: 'include'
    });
    location.reload();
  } catch (error) {
    console.error('Error deleting product:', error);
  }
}

// Import from Excel
document.getElementById('import-btn').addEventListener('click', async function() {
  const fileInput = document.getElementById('import-file');
  const resultDiv = document.getElementById('import-result');
  
  if (!fileInput.files.length) {
    resultDiv.className = 'alert alert-warning';
    resultDiv.textContent = 'Выберите файл';
    resultDiv.classList.remove('d-none');
    return;
  }
  
  const formData = new FormData();
  formData.append('file', fileInput.files[0]);
  
  this.disabled = true;
  this.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Импорт...';
  
  try {
    const response = await fetch('/api/v1/products/import', {
      method: 'POST',
      credentials: 'include',
      body: formData
    });
    
    const result = await response.json();
    
    if (response.ok) {
      resultDiv.className = 'alert alert-success';
      resultDiv.textContent = result.message;
      resultDiv.classList.remove('d-none');
      setTimeout(() => location.reload(), 1500);
    } else {
      resultDiv.className = 'alert alert-danger';
      resultDiv.textContent = result.detail || 'Ошибка импорта';
      resultDiv.classList.remove('d-none');
    }
  } catch (error) {
    resultDiv.className = 'alert alert-danger';
    resultDiv.textContent = 'Ошибка: ' + error.message;
    resultDiv.classList.remove('d-none');
  } finally {
    this.disabled = false;
    this.innerHTML = '<iconify-icon icon="mdi:upload" class="me-1"></iconify-icon>Импортировать';
  }
});

// Search
document.getElementById('search-input').addEventListener('input', function() {
  const query = this.value.toLowerCase();
  const rows = document.querySelectorAll('#products-body tr');
  
  rows.forEach(row => {
    const name = row.querySelector('td:first-child').textContent.toLowerCase();
    row.style.display = name.includes(query) ? '' : 'none';
  });
});
</script>
{% endblock %}
