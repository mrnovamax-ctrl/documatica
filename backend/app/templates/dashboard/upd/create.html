<!DOCTYPE html>
<html lang="ru" data-theme="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Создать УПД - Documatica</title>
  <link rel="icon" type="image/svg+xml" href="/static/images/favicon.svg">
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <!-- remix icon font css -->
  <link rel="stylesheet" href="/static/css/remixicon.css">
  <!-- Iconify for v12 icons -->
  <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
  <!-- BootStrap css -->
  <link rel="stylesheet" href="/static/css/lib/bootstrap.min.css">
  <!-- Date picker css -->
  <link rel="stylesheet" href="/static/css/lib/flatpickr.min.css">
  <!-- html2canvas for preview -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- Documatica v12.0 Design System (ONLY v12, no old styles) -->
  <link rel="stylesheet" href="/static/css/documatica.css?v=12.9">
  <!-- UPD Constructor Styles (extracted from inline for better performance) -->
    <link rel="stylesheet" href="/static/css/upd-constructor.css?v=2.1">
  <!-- Toast Notifications -->
  <script src="/static/js/toasts.js"></script>
  
  <style>
    /* Стили для readonly поля суммы */
    .product-total[readonly] {
      background-color: #f1f5f9 !important;
      color: #64748b;
      cursor: not-allowed;
    }
    
    /* Анимация выезда кнопки "Добавить в контрагенты" */
    #save-buyer-btn {
      opacity: 0;
      visibility: hidden;
    }
    #save-buyer-btn.show {
      opacity: 1 !important;
      visibility: visible !important;
      transform: translateX(0) !important;
    }
    #save-buyer-btn:hover {
      padding: 0 16px !important;
      box-shadow: 0 4px 16px rgba(251, 191, 36, 0.5) !important;
    }
    #save-buyer-btn:hover span {
      opacity: 1 !important;
      width: auto !important;
    }
    #save-buyer-btn:hover svg {
      transform: rotate(90deg) !important;
    }
    #save-buyer-btn:active {
      transform: translateX(0) scale(0.95) !important;
    }
    
    /* Анимация выезда кнопки "Добавить в организации" */
    #save-seller-btn {
      opacity: 0;
      visibility: hidden;
    }
    #save-seller-btn.show {
      opacity: 1 !important;
      visibility: visible !important;
      transform: translateX(0) !important;
    }
    #save-seller-btn:hover {
      padding: 0 16px !important;
      box-shadow: 0 4px 16px rgba(251, 191, 36, 0.5) !important;
    }
    #save-seller-btn:hover span {
      opacity: 1 !important;
      width: auto !important;
    }
    #save-seller-btn:hover svg {
      transform: rotate(90deg) !important;
    }
    #save-seller-btn:active {
      transform: translateX(0) scale(0.95) !important;
    }
  </style>
</head>

<body class="constructor-page-v12">

<!-- Sidebar v12 -->
{% include 'components/sidebar_v12.html' %}

<!-- Sidebar Overlay for mobile -->
<div class="sidebar-overlay-v12" onclick="document.body.classList.remove('sidebar-open')"></div>

<!-- Mobile Burger Button -->
<button class="constructor-burger-btn" onclick="document.body.classList.toggle('sidebar-open')" style="position: fixed; top: 16px; right: 16px; z-index: 1001; width: 48px; height: 48px; background: white; border: 1px solid #e2e8f0; border-radius: 12px; display: none; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
  <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="#64748b" stroke-width="2">
    <line x1="3" y1="6" x2="21" y2="6"></line>
    <line x1="3" y1="12" x2="21" y2="12"></line>
    <line x1="3" y1="18" x2="21" y2="18"></line>
  </svg>
</button>
<style>
  @media (max-width: 1023px) {
    .constructor-burger-btn { display: flex !important; }
    .sidebar-v12 { transform: translateX(-100%); z-index: 1000; transition: transform 0.3s ease; }
    body.sidebar-open .sidebar-v12 { transform: translateX(0); }
    body.sidebar-open .sidebar-overlay-v12 { opacity: 1; visibility: visible; }
    .sidebar-overlay-v12 { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
  }
</style>

<main class="dashboard-main-v12">
  <!-- Header v12 -->
  {% include 'components/header_dashboard_v12.html' %}

  <div class="dashboard-content-v12 upd-constructor-page">
    <!-- Page Title -->
    <div class="page-title-v12">
      <h1>Создать УПД</h1>
      <p>Универсальный передаточный документ</p>
    </div>

    <form id="upd-form">
      <div class="row gy-4">
        <!-- Left Column - Form -->
        <div class="col-xxl-7 col-xl-6">
          <!-- Document Info -->
          <div class="card radius-16 mb-24">
            <div class="card-header py-16 px-24 border-bottom">
              <h4 class="mb-0">Параметры документа</h4>
            </div>
            <div class="card-body p-24">
              <div class="row g-16" style="margin-bottom: 24px;">
                <!-- Статус УПД - автоматически определяется по НДС (скрыто) -->
                <div class="col-12 d-none" id="upd-status-wrapper">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Статус УПД</label>
                  <div class="d-flex align-items-center flex-wrap gap-28">
                    <div class="form-check checked-primary d-flex align-items-center gap-2">
                      <input class="form-check-input" type="radio" name="upd-status" id="upd-status-1" value="1" checked>
                      <label class="form-check-label line-height-1 fw-medium text-secondary-light" for="upd-status-1">1 - счет-фактура и передаточный документ</label>
                    </div>
                    <div class="form-check checked-primary d-flex align-items-center gap-2">
                      <input class="form-check-input" type="radio" name="upd-status" id="upd-status-2" value="2">
                      <label class="form-check-label line-height-1 fw-medium text-secondary-light" for="upd-status-2">2 - передаточный документ (акт)</label>
                    </div>
                  </div>
                </div>
                <!-- Информация о статусе УПД -->
                <div class="col-12">
                  <div class="alert alert-secondary-100 py-8 px-16 radius-8 mb-0 d-flex align-items-center gap-8" style="background: #f1f5f9; border: none;">
                    <span class="text-secondary-light text-sm">Статус УПД:</span>
                    <span id="upd-status-display" class="fw-semibold text-primary-600">1 - счет-фактура и передаточный документ</span>
                    <span class="text-secondary-light text-xs ms-8">(определяется автоматически по ставке НДС)</span>
                  </div>
                </div>
                <!-- Номер и дата -->
                <div class="col-md-4">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Номер УПД <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="upd-number" placeholder="Авто" required>
                    <button class="btn btn-outline-secondary-600" type="button" id="auto-number-btn" title="Автонумерация">
                      Авто
                    </button>
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Дата документа <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <input type="text" class="form-control date-picker" id="upd-date" placeholder="дд.мм.гггг" required>
                    <button class="btn btn-outline-secondary-600" type="button" id="upd-date-icon">
                      <iconify-icon icon="mdi:calendar"></iconify-icon>
                    </button>
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Исправление №</label>
                  <div class="row g-8">
                    <div class="col-6">
                      <input type="text" class="form-control" id="correction-number" placeholder="--">
                    </div>
                    <div class="col-6">
                      <input type="text" class="form-control date-picker" id="correction-date" placeholder="от">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Seller Info -->
          <div class="card radius-16 mb-24">
            <div class="card-header py-16 px-24 border-bottom d-flex align-items-center justify-content-between">
              <h4 class="mb-0">Продавец</h4>
              <button type="button" class="btn btn-sm btn-outline-primary-600" data-bs-toggle="modal" data-bs-target="#selectCompanyModal">
                Выбрать из списка
              </button>
            </div>
            <div class="card-body p-24">
              <div class="row g-16" style="margin-bottom: 24px;">
                <div class="col-md-6">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Наименование <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="seller-name" placeholder='ООО "Название"' required>
                </div>
                <div class="col-md-3">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">ИНН <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="seller-inn" placeholder="7707123456" required maxlength="12">
                    <button class="btn btn-outline-primary-600 dadata-search-btn" type="button" id="seller-inn-search" title="Найти по ИНН">
                      <iconify-icon icon="mdi:magnify" class="text-lg"></iconify-icon>
                    </button>
                  </div>
                  <small class="text-muted d-none" id="seller-inn-loading">Поиск...</small>
                </div>
                <div class="col-md-3">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">КПП</label>
                  <input type="text" class="form-control" id="seller-kpp" placeholder="770701001" maxlength="9">
                </div>
                <div class="col-12 d-none" id="seller-inn-error-container">
                  <div class="alert alert-danger py-2 px-3 mb-0" role="alert">
                    <small id="seller-inn-error"></small>
                  </div>
                </div>
                <div class="col-12" style="position: relative;">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Адрес <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="seller-address" placeholder="123456, г. Москва, ул. Примерная, д. 1" required style="padding-right: 50px;">
                  <!-- Кнопка добавить в организации внутри поля -->
                  <button type="button" id="save-seller-btn" title="Добавить в мои организации" style="position: absolute; right: 12px; bottom: 10px; background: #FBBF24; color: #0f172a; border: none; border-radius: 0.75rem; height: 36px; min-width: 36px; padding: 0 12px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s, visibility 0.3s; cursor: pointer; box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3); z-index: 10; transform: translateX(calc(100% + 24px)); white-space: nowrap; font-weight: 900; font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" style="flex-shrink: 0; transition: transform 0.3s;">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span style="opacity: 0; width: 0; overflow: hidden; transition: opacity 0.3s, width 0.3s;">Добавить в мои организации</span>
                  </button>
                </div>
              </div>
              
              <!-- Грузоотправитель -->
              <div class="mt-24 pt-16 border-top">
                <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Грузоотправитель и его адрес</label>
                <div class="d-flex align-items-center flex-wrap gap-28 mb-12">
                  <div class="form-check checked-primary d-flex align-items-center gap-2">
                    <input class="form-check-input" type="radio" name="consignor-type" id="consignor-none" value="none" checked>
                    <label class="form-check-label line-height-1 fw-medium text-secondary-light" for="consignor-none">Не заполнять</label>
                  </div>
                  <div class="form-check checked-primary d-flex align-items-center gap-2">
                    <input class="form-check-input" type="radio" name="consignor-type" id="consignor-same" value="same">
                    <label class="form-check-label line-height-1 fw-medium text-secondary-light" for="consignor-same">Совпадает с продавцом</label>
                  </div>
                  <div class="form-check checked-primary d-flex align-items-center gap-2">
                    <input class="form-check-input" type="radio" name="consignor-type" id="consignor-manual" value="manual">
                    <label class="form-check-label line-height-1 fw-medium text-secondary-light" for="consignor-manual">Ручной ввод</label>
                  </div>
                </div>
                <input type="text" class="form-control" id="consignor-address" placeholder="Грузоотправитель, адрес" disabled>
              </div>
              
              <!-- Настройки НДС по умолчанию -->
              <div class="mt-24 pt-16 border-top">
                <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Настройки НДС и страна происхождения (по умолчанию для товаров)</label>
                <div class="row g-16" style="margin-bottom: 24px;">
                  <div class="col-md-3">
                    <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Ставка НДС</label>
                    <select class="form-select" id="default-vat">
                      <option value="22">22%</option>
                      <option value="20" selected>20%</option>
                      <option value="18">18%</option>
                      <option value="10">10%</option>
                      <option value="7">7%</option>
                      <option value="5">5%</option>
                      <option value="0">0%</option>
                      <option value="none">Без НДС</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">НДС</label>
                    <select class="form-select" id="default-vat-type">
                      <option value="on-top" selected>Сверху</option>
                      <option value="included">Включен в цену</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Страна</label>
                    <input type="text" class="form-control" id="default-country" value="Россия">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Код страны</label>
                    <input type="text" class="form-control" id="default-country-code" value="643">
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Buyer Info -->
          <div class="card radius-16 mb-24">
            <div class="card-header py-16 px-24 border-bottom d-flex align-items-center justify-content-between">
              <h4 class="mb-0">Покупатель</h4>
              <button type="button" class="btn btn-sm btn-outline-primary-600" data-bs-toggle="modal" data-bs-target="#selectContractorModal">
                Выбрать из списка
              </button>
            </div>
            <div class="card-body p-24">
              <div class="row g-16" style="margin-bottom: 24px;">
                <div class="col-md-6">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Наименование <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="buyer-name" placeholder='ООО "Контрагент"' required>
                </div>
                <div class="col-md-3">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">ИНН <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="buyer-inn" placeholder="7708654321" required maxlength="12">
                    <button class="btn btn-outline-primary-600 dadata-search-btn" type="button" id="buyer-inn-search" title="Найти по ИНН">
                      <iconify-icon icon="mdi:magnify" class="text-lg"></iconify-icon>
                    </button>
                  </div>
                  <small class="text-muted d-none" id="buyer-inn-loading">Поиск...</small>
                </div>
                <div class="col-md-3">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">КПП</label>
                  <input type="text" class="form-control" id="buyer-kpp" placeholder="770801001" maxlength="9">
                </div>
                <div class="col-12 d-none" id="buyer-inn-error-container">
                  <div class="alert alert-danger py-2 px-3 mb-0" role="alert">
                    <small id="buyer-inn-error"></small>
                  </div>
                </div>
                <div class="col-12" style="position: relative;">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Адрес <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="buyer-address" placeholder="654321, г. Санкт-Петербург, пр. Невский, д. 100" required style="padding-right: 50px;">
                  <!-- Кнопка добавить в клиенты внутри поля -->
                  <button type="button" id="save-buyer-btn" title="Добавить в мои контрагенты" style="position: absolute; right: 12px; bottom: 10px; background: #FBBF24; color: #0f172a; border: none; border-radius: 0.75rem; height: 36px; min-width: 36px; padding: 0 12px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s, visibility 0.3s; cursor: pointer; box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3); z-index: 10; transform: translateX(calc(100% + 24px)); white-space: nowrap; font-weight: 900; font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" style="flex-shrink: 0; transition: transform 0.3s;">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span style="opacity: 0; width: 0; overflow: hidden; transition: opacity 0.3s, width 0.3s;">Добавить в мои контрагенты</span>
                  </button>
                </div>
              </div>
              
              <!-- Валюта и идентификатор госконтракта -->
              <div class="mt-24 pt-16 border-top">
                <div class="row g-16" style="margin-bottom: 24px;">
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Валюта: наименование, код</label>
                    <div class="row g-8">
                      <div class="col-8">
                        <input type="text" class="form-control" id="currency-name" value="Российский рубль" placeholder="Наименование валюты">
                      </div>
                      <div class="col-4">
                        <input type="text" class="form-control" id="currency-code" value="643" placeholder="Код">
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Идентификатор гос. контракта</label>
                    <input type="text" class="form-control" id="gov-contract-id" placeholder="При наличии">
                  </div>
                </div>
              </div>
              
              <!-- Грузополучатель -->
              <div class="mt-24 pt-16 border-top">
                <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Грузополучатель и его адрес</label>
                <div class="d-flex align-items-center flex-wrap gap-28 mb-12">
                  <div class="form-check checked-primary d-flex align-items-center gap-2">
                    <input class="form-check-input" type="radio" name="consignee-type" id="consignee-none" value="none" checked>
                    <label class="form-check-label line-height-1 fw-medium text-secondary-light" for="consignee-none">Не заполнять</label>
                  </div>
                  <div class="form-check checked-primary d-flex align-items-center gap-2">
                    <input class="form-check-input" type="radio" name="consignee-type" id="consignee-same" value="same">
                    <label class="form-check-label line-height-1 fw-medium text-secondary-light" for="consignee-same">Совпадает с покупателем</label>
                  </div>
                  <div class="form-check checked-primary d-flex align-items-center gap-2">
                    <input class="form-check-input" type="radio" name="consignee-type" id="consignee-manual" value="manual">
                    <label class="form-check-label line-height-1 fw-medium text-secondary-light" for="consignee-manual">Ручной ввод</label>
                  </div>
                </div>
                <input type="text" class="form-control" id="consignee-address" placeholder="Грузополучатель, адрес" disabled>
              </div>
            </div>
          </div>
          
          <!-- Payment and Shipping Documents -->
          <div class="card radius-16 mb-24">
            <div class="card-header py-16 px-24 border-bottom">
              <h4 class="mb-0">Дополнительные сведения</h4>
            </div>
            <div class="card-body p-24">
              <div class="row g-16" style="margin-bottom: 24px;">
                <div class="col-md-6">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">К платежно-расчетному документу №</label>
                  <input type="text" class="form-control" id="payment-document" placeholder="№ и дата платежного документа">
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Документ об отгрузке</label>
                  <input type="text" class="form-control" id="shipping-document" placeholder="№ и дата документа об отгрузке">
                </div>
              </div>
            </div>
          </div>

          <!-- Products/Services -->
          <div class="card radius-16 mb-24">
            <div class="card-header py-16 px-24 border-bottom">
              <h4 class="mb-0">
                Товары и услуги
              </h4>
            </div>
            <div class="card-body p-24">
              <div id="products-container">
                <!-- Product Row 1 -->
                <div class="product-row card border radius-12 p-16 mb-16" data-row="1">
                  <div class="row g-12 align-items-end">
                    <div class="col">
                      <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Наименование <span class="text-danger">*</span></label>
                      <input type="text" class="form-control product-name" placeholder="Название товара или услуги" required>
                    </div>
                    <div class="col-auto" style="width: 100px;">
                      <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Кол-во</label>
                      <input type="number" class="form-control product-qty" value="1" min="0.01" step="0.01">
                    </div>
                    <div class="col-auto" style="width: 110px;">
                      <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Ед. изм.</label>
                      <select class="form-select product-unit">
                        <option value="шт">шт</option>
                        <option value="усл">усл</option>
                        <option value="ч">ч</option>
                        <option value="кг">кг</option>
                        <option value="л">л</option>
                        <option value="м">м</option>
                        <option value="м2">м2</option>
                        <option value="м3">м3</option>
                      </select>
                    </div>
                    <div class="col-auto" style="width: 120px;">
                      <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Цена</label>
                      <input type="number" class="form-control product-price" value="0" min="0" step="0.01">
                    </div>
                    <div class="col-auto" style="width: 120px;">
                      <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Сумма</label>
                      <input type="text" class="form-control product-total" value="0 ₽" readonly>
                    </div>
                    <div class="col-auto">
                      <button type="button" class="btn btn-outline-danger remove-product" title="Удалить">
                        <iconify-icon icon="mdi:trash-can-outline"></iconify-icon>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Add Product Buttons -->
              <div class="d-flex mb-16" style="gap: 16px;">
                <button type="button" class="add-product-btn flex-grow-1 py-16 radius-12 d-flex align-items-center justify-content-center gap-8 text-secondary-light" id="add-product">
                  <iconify-icon icon="mdi:plus-circle" class="text-xl"></iconify-icon>
                  Добавить ещё
                </button>
                <button type="button" class="add-product-btn flex-grow-1 py-16 radius-12 d-flex align-items-center justify-content-center gap-8 text-secondary-light" data-bs-toggle="modal" data-bs-target="#selectProductModal">
                  <iconify-icon icon="mdi:package-variant" class="text-xl"></iconify-icon>
                  Выбрать из справочника
                </button>
              </div>

              <!-- Totals -->
              <div style="margin-top: 48px;">
                <div class="row justify-content-end">
                  <div class="col-md-6">
                    <div class="d-flex justify-content-between mb-16">
                      <span class="text-secondary-light">Итого без НДС:</span>
                      <span class="fw-medium" id="total-without-vat">0 ₽</span>
                    </div>
                    <div class="d-flex justify-content-between mb-16">
                      <span class="text-secondary-light">НДС:</span>
                      <span class="fw-medium" id="total-vat">0 ₽</span>
                    </div>
                    <div class="d-flex justify-content-between">
                      <span class="fw-semibold text-lg">Итого с НДС:</span>
                      <span class="fw-bold text-lg text-primary-600" id="total-with-vat">0 ₽</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Additional Info - Подписант со стороны продавца -->
          <div class="card radius-16 mb-24">
            <div class="card-header py-16 px-24 border-bottom">
              <h4 class="mb-0">Подписант со стороны продавца</h4>
            </div>
            <div class="card-body p-24">
              <div class="row g-16" style="margin-bottom: 24px;">
                <!-- Основание передачи -->
                <div class="col-md-6">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Основание передачи (сдачи) / получения (приемки)</label>
                  <input type="text" class="form-control" id="transfer-basis" placeholder="Договор № от дд.мм.гггг">
                </div>
                <!-- Данные о транспортировке -->
                <div class="col-md-6">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Данные о транспортировке и грузе</label>
                  <input type="text" class="form-control" id="transport-info" placeholder="Транспортная накладная, поручение экспедитору, экспедиторская / складская расписка и т.п.">
                </div>
                <!-- Товар передал -->
                <div class="col-12">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Товар (груз) передал / услуги, результаты работ, права сдал</label>
                  <div class="row g-12">
                    <div class="col-md-4">
                      <input type="text" class="form-control" id="released-position" placeholder="Должность">
                    </div>
                    <div class="col-md-4">
                      <input type="text" class="form-control" id="released-by" placeholder="ФИО">
                    </div>
                    <div class="col-md-4">
                      <div class="input-group">
                        <input type="text" class="form-control date-picker" id="shipping-date" placeholder="Дата отгрузки">
                        <button class="btn btn-outline-secondary-600" type="button" id="set-today-shipping" title="Текущая дата">
                          Сегодня
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Иные сведения об отгрузке -->
                <div class="col-12">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Иные сведения об отгрузке, передаче</label>
                  <input type="text" class="form-control" id="other-shipping-info" placeholder="Ссылки на неотъемлемые приложения, сопутствующие документы, иные документы и т.п.">
                </div>
                <!-- Ответственный за правильность оформления -->
                <div class="col-12">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Ответственный за правильность оформления факта хоз. жизни</label>
                  <div class="row g-12">
                    <div class="col-md-4">
                      <input type="text" class="form-control" id="responsible-position" placeholder="Должность">
                    </div>
                    <div class="col-md-4">
                      <input type="text" class="form-control" id="responsible-name" placeholder="ФИО">
                    </div>
                    <div class="col-md-4">
                      <input type="text" class="form-control" id="economic-entity" placeholder="В т.ч. комиссионера / агента (может не заполняться)">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Подписант со стороны покупателя -->
          <div class="card radius-16 mb-24">
            <div class="card-header py-16 px-24 border-bottom">
              <h4 class="mb-0">Подписант со стороны покупателя</h4>
            </div>
            <div class="card-body p-24">
              <div class="row g-16" style="margin-bottom: 24px;">
                <!-- Товар получил -->
                <div class="col-12">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Товар (груз) получил / услуги, результаты работ, права принял</label>
                  <div class="row g-12">
                    <div class="col-md-4">
                      <input type="text" class="form-control" id="received-position" placeholder="Должность">
                    </div>
                    <div class="col-md-4">
                      <input type="text" class="form-control" id="received-by" placeholder="ФИО">
                    </div>
                    <div class="col-md-4">
                      <div class="input-group">
                        <input type="text" class="form-control date-picker" id="receiving-date" placeholder="Дата получения">
                        <button class="btn btn-outline-secondary-600" type="button" id="set-today-receiving" title="Текущая дата">
                          Сегодня
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Иные сведения о получении -->
                <div class="col-12">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Иные сведения о получении, приемке</label>
                  <input type="text" class="form-control" id="other-receiving-info" placeholder="Информация о наличии/отсутствии претензии; ссылки на неотъемлемые приложения, и другие документы и т.п.">
                </div>
                <!-- Ответственный за правильность оформления (покупатель) -->
                <div class="col-12">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Ответственный за правильность оформления факта хоз. жизни</label>
                  <div class="row g-12">
                    <div class="col-md-4">
                      <input type="text" class="form-control" id="buyer-responsible-position" placeholder="Должность">
                    </div>
                    <div class="col-md-4">
                      <input type="text" class="form-control" id="buyer-responsible-name" placeholder="ФИО">
                    </div>
                    <div class="col-md-4">
                      <input type="text" class="form-control" id="buyer-economic-entity" placeholder="Может не заполняться при М.П.">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="card radius-16">
            <div class="card-body p-24">
              <div class="d-flex flex-wrap justify-content-center" style="gap: 16px;">
                <button type="button" class="btn btn-outline-neutral-600 px-24" id="save-draft">
                  Сохранить черновик
                </button>
                <button type="button" class="btn btn-outline-neutral-600 px-24" id="save-template">
                  Сохранить как шаблон
                </button>
                <button type="button" class="btn btn-outline-primary-600 px-24" id="preview-btn" data-bs-toggle="modal" data-bs-target="#previewModal">
                  Предпросмотр
                </button>
                <button type="submit" class="btn btn-primary-600 px-32">
                  Скачать PDF
                </button>
                <button type="button" class="btn btn-outline-neutral-600 px-24" id="export-xls-btn" disabled title="Сначала создайте документ">
                  Скачать XLS
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column - Preview -->
        <div class="col-xxl-5 col-xl-6 d-none d-xl-block">
          <div class="sticky-preview">
            <div class="card radius-16">
              <div class="card-header py-16 px-24 border-bottom d-flex align-items-center justify-content-between">
                <h4 class="mb-0">Предпросмотр УПД</h4>
                <div class="d-flex" style="gap: 8px;">
                  <button type="button" class="btn btn-sm btn-outline-primary-600" data-bs-toggle="modal" data-bs-target="#previewModal">
                    Открыть
                  </button>
                </div>
              </div>
              <div class="card-body p-0 bg-white d-flex align-items-start justify-content-center position-relative" style="overflow: auto; background: #f8fafc;">
                <canvas id="sidebar-preview-canvas" style="width: 100%; height: auto;"></canvas>
                <!-- Лупа -->
                <div id="canvas-magnifier" style="display: none; position: absolute; width: 400px; height: 300px; border: 3px solid #3b82f6; border-radius: 12px; pointer-events: none; z-index: 1000; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3); background: white;">
                  <canvas id="magnifier-canvas" width="1200" height="900" style="width: 100%; height: 100%; display: block;"></canvas>
                </div>
              </div>
            </div>
            
            <!-- AI Analysis Block -->
            <div class="card radius-16 mt-24">
              <div class="card-header py-16 px-24 d-flex align-items-center justify-content-between" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);">
                <div class="d-flex align-items-center" style="gap: 24px;">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2">
                    <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/>
                    <circle cx="7.5" cy="14.5" r="1.5"/>
                    <circle cx="16.5" cy="14.5" r="1.5"/>
                  </svg>
                  <span class="fw-bold text-uppercase" style="font-size: 18px; letter-spacing: 0.3em; color: #fbbf24; font-weight: 900;">ИИ Анализ документа</span>
                </div>
                <div class="d-flex align-items-center gap-8">
                  <button type="button" class="btn btn-sm d-none align-items-center gap-8" id="clear-highlights-btn" style="background: transparent; color: #94a3b8; border: 1px solid #475569; font-weight: 600; font-size: 10px; text-transform: uppercase;">
                    Сбросить подсветку
                  </button>
                  <button type="button" class="btn btn-sm d-flex align-items-center gap-8" id="ai-analyze-btn" style="background: #fbbf24; color: #0f172a; font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="11" cy="11" r="8"/>
                      <path d="m21 21-4.3-4.3"/>
                    </svg>
                    Анализировать
                  </button>
                </div>
              </div>
              <div class="card-body" id="ai-analysis-result" style="min-height: 100px;">
                <div class="text-center py-24 text-secondary-light">
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mb-12 mx-auto d-block" style="opacity: 0.5;">
                    <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 1 1 7.072 0l-.548.547A3.374 3.374 0 0 0 11 18.469V19a2 2 0 1 1-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                  </svg>
                  <p class="mb-4 fw-semibold text-secondary-light">Нажмите "Анализировать" для проверки документа</p>
                  <small class="text-secondary-light">ИИ проверит документ на ошибки с точки зрения бухгалтера и юриста</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
  
</main>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
  <div class="modal-dialog" style="max-width: 98vw; width: 1200px; margin: 20px auto;">
    <div class="modal-content radius-16" style="overflow: hidden;">
      <div class="modal-header bg-neutral-50 py-12 px-24 border-bottom">
        <h5 class="modal-title">Предпросмотр УПД</h5>
        <div class="d-flex gap-12 align-items-center">
          <button type="button" class="btn btn-sm btn-primary-600" id="modal-download-pdf">
            Скачать PDF
          </button>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
      </div>
      <div class="modal-body p-0 bg-white" style="overflow: hidden;">
        <iframe id="preview-iframe" style="width: 100%; height: 850px; border: none; display: block;" scrolling="no"></iframe>
      </div>
    </div>
  </div>
</div>

<!-- Select Company (Organization) Modal -->
<div class="modal fade" id="selectCompanyModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content radius-16">
      <div class="modal-header bg-neutral-50 py-16 px-24 border-bottom">
        <div>
          <h5 class="modal-title mb-1">Выберите организацию</h5>
          <p class="text-secondary-light text-sm mb-0">Нажмите на карточку для выбора</p>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-24">
        <div class="docu-mb-48">
          <input type="text" class="form-control" id="search-organization" placeholder="Поиск по названию или ИНН...">
        </div>
        <div id="organizations-modal-list" class="row g-3">
          <div class="col-12 text-center py-24 text-secondary-light">
            <iconify-icon icon="mdi:loading" class="spin text-2xl"></iconify-icon>
            <p class="mt-8">Загрузка организаций...</p>
          </div>
        </div>
        <div id="no-organizations-message" style="display: none;" class="text-center py-24">
          <iconify-icon icon="mdi:domain" class="text-secondary-light text-4xl"></iconify-icon>
          <p class="mt-8 text-secondary-light">Организации не найдены</p>
          <a href="/dashboard/organizations/create/" class="btn btn-sm btn-primary-600 mt-8">
            <iconify-icon icon="mdi:plus" class="me-1"></iconify-icon>
            Добавить организацию
          </a>
        </div>
      </div>
      <div class="modal-footer bg-neutral-50 border-top">
        <a href="/dashboard/organizations/create/" class="btn btn-outline-primary-600">
          <iconify-icon icon="mdi:plus" class="me-1"></iconify-icon>
          Добавить новую
        </a>
      </div>
    </div>
  </div>
</div>
<!-- Select Contractor Modal -->
<div class="modal fade" id="selectContractorModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content radius-16">
      <div class="modal-header bg-neutral-50 py-16 px-24 border-bottom">
        <div>
          <h5 class="modal-title mb-1">Выберите контрагента</h5>
          <p class="text-secondary-light text-sm mb-0">Нажмите на карточку для выбора</p>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-24">
        <div class="docu-mb-48">
          <input type="text" class="form-control" id="search-contractor" placeholder="Поиск по названию или ИНН...">
        </div>
        <div id="contractors-modal-list" class="row g-3">
          <div class="col-12 text-center py-24 text-secondary-light">
            <iconify-icon icon="mdi:loading" class="spin text-2xl"></iconify-icon>
            <p class="mt-8">Загрузка контрагентов...</p>
          </div>
        </div>
        <div id="no-contractors-message" style="display: none;" class="text-center py-24">
          <iconify-icon icon="mdi:account-group" class="text-secondary-light text-4xl"></iconify-icon>
          <p class="mt-8 text-secondary-light">Контрагенты не найдены</p>
          <a href="/dashboard/contractors/create/" class="btn btn-sm btn-primary-600 mt-8">
            <iconify-icon icon="mdi:plus" class="me-1"></iconify-icon>
            Добавить контрагента
          </a>
        </div>
      </div>
      <div class="modal-footer bg-neutral-50 border-top">
        <a href="/dashboard/contractors/create/" class="btn btn-outline-primary-600">
          <iconify-icon icon="mdi:plus" class="me-1"></iconify-icon>
          Добавить нового
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Select Product Modal -->
<div class="modal fade" id="selectProductModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content radius-16">
      <div class="modal-header bg-neutral-50 py-12 px-24 border-bottom">
        <h5 class="modal-title">Выберите товар или услугу</h5>
      </div>
      <div class="modal-body p-24">
        <div class="mb-16">
          <input type="text" class="form-control" id="search-product-modal" placeholder="Поиск по названию или артикулу...">
        </div>
        <div id="products-modal-list">
          <div class="text-center py-24 text-secondary-light">
            <iconify-icon icon="mdi:loading" class="spin text-2xl"></iconify-icon>
            <p class="mt-8">Загрузка товаров...</p>
          </div>
        </div>
        <div id="no-products-message" style="display: none;" class="text-center py-24">
          <iconify-icon icon="mdi:package-variant" class="text-secondary-light text-4xl"></iconify-icon>
          <p class="mt-8 text-secondary-light">Товары не найдены</p>
          <a href="/dashboard/products" class="btn btn-sm btn-primary-600 mt-8">Добавить товар</a>
        </div>
      </div>
      <div class="modal-footer">
        <a href="/dashboard/products" class="btn btn-outline-primary-600">
          <iconify-icon icon="mdi:plus"></iconify-icon>
          В справочник
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Auth Required Modal -->
<div class="modal fade" id="authRequiredModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border: none; border-radius: 2.5rem; overflow: hidden; box-shadow: 0 50px 100px -20px rgba(15,23,42,0.25);">
      <div class="modal-body p-0">
        <!-- Success Header -->
        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 2.5rem; text-align: center;">
          <div style="width: 80px; height: 80px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          </div>
          <h3 style="color: white; font-size: 1.5rem; font-weight: 900; margin: 0;">Документ готов</h3>
        </div>
        
        <!-- Content -->
        <div style="padding: 2rem 2.5rem 2.5rem;">
          <!-- Dynamic save status -->
          <div id="draft-save-status" style="background: #f0fdf4; border-radius: 1rem; padding: 1rem 1.25rem; margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div class="spinner-border spinner-border-sm text-success" role="status" style="width: 16px; height: 16px;">
                <span class="visually-hidden">Сохранение...</span>
              </div>
              <span style="color: #166534; font-weight: 600;">Сохраняем черновик...</span>
            </div>
          </div>
          
          <p style="margin: 0 0 1.5rem; font-size: 0.875rem; color: #64748b; text-align: center;">
            Войдите, чтобы скачать УПД и сохранить его в личном кабинете
          </p>
          
          <!-- Yandex OAuth - Primary -->
          <a href="/auth/yandex/login" style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; width: 100%; padding: 1rem 1.5rem; background: #FC3F1D; color: white; border-radius: 1.25rem; font-weight: 700; font-size: 0.9375rem; text-decoration: none; transition: all 0.3s; margin-bottom: 0.75rem;"
             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 25px -5px rgba(252,63,29,0.4)'"
             onmouseout="this.style.transform='none'; this.style.boxShadow='none'">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <circle cx="12" cy="12" r="11" fill="white" fill-opacity="0.15"/>
              <text x="8" y="16" font-size="12" font-weight="bold" fill="white">Y</text>
            </svg>
            Войти через Яндекс
          </a>
          
          <!-- Email login -->
          <a href="/login/" style="display: block; width: 100%; padding: 0.875rem 1.5rem; background: #3b82f6; color: white; border-radius: 1.25rem; font-weight: 700; font-size: 0.875rem; text-decoration: none; text-align: center; transition: all 0.3s; margin-bottom: 1.5rem;"
             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 25px -5px rgba(59,130,246,0.4)'"
             onmouseout="this.style.transform='none'; this.style.boxShadow='none'">
            Войти по email
          </a>
          
          <!-- Register link -->
          <p style="text-align: center; margin: 0; font-size: 0.875rem; color: #64748b;">
            Нет аккаунта? <a href="/register/" style="color: #3b82f6; font-weight: 600; text-decoration: none;">Зарегистрироваться</a>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Guest Registration Modal (Documatica v12.0 Style) -->
<div class="modal fade" id="guestRegistrationModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 480px;">
    <div class="modal-content" style="border: none; border-radius: 2.5rem; overflow: hidden; box-shadow: 0 50px 100px -20px rgba(15,23,42,0.3);">
      <div class="modal-body p-0">
        
        <!-- Success Header -->
        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 2rem 2.5rem; position: relative; overflow: hidden;">
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" style="position: absolute; top: 1.25rem; right: 1.25rem; opacity: 0.7;"></button>
          <div style="display: flex; align-items: center; gap: 1rem;">
            <div style="width: 56px; height: 56px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            </div>
            <div>
              <h3 style="color: white; font-size: 1.25rem; font-weight: 800; margin: 0 0 0.25rem;">Документ готов</h3>
              <p style="color: rgba(255,255,255,0.9); font-size: 0.875rem; margin: 0;">Зарегистрируйтесь, чтобы скачать</p>
            </div>
          </div>
        </div>
        
        <!-- Content -->
        <div style="padding: 2rem 2.5rem 2.5rem;">
          
          <!-- Dynamic save status -->
          <div id="draft-save-status" style="background: #fefce8; border: 1px solid #fef08a; border-radius: 1rem; padding: 1rem 1.25rem; margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div class="spinner-border spinner-border-sm" role="status" style="width: 16px; height: 16px; color: #eab308;">
                <span class="visually-hidden">Сохранение...</span>
              </div>
              <span style="color: #854d0e; font-weight: 600;">Сохраняем черновик на сервере...</span>
            </div>
          </div>
          
          <!-- Quick Yandex Login - HERO -->
          <div style="text-align: center; margin-bottom: 1.5rem;">
            <p style="font-size: 0.6875rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.15em; color: #94a3b8; margin-bottom: 0.75rem;">Самый быстрый способ</p>
            <a href="/auth/yandex/login" id="guest-yandex-btn" style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; width: 100%; padding: 1.125rem 1.5rem; background: #FC3F1D; color: white; border-radius: 1.25rem; font-weight: 800; font-size: 0.9375rem; text-decoration: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);"
               onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 15px 30px -5px rgba(252,63,29,0.45)'"
               onmouseout="this.style.transform='none'; this.style.boxShadow='none'">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                <circle cx="12" cy="12" r="11" fill="white" fill-opacity="0.15"/>
                <text x="8" y="16" font-size="12" font-weight="bold" fill="white">Y</text>
              </svg>
              Войти через Яндекс
              <span style="font-size: 0.6875rem; background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-weight: 700;">1 клик</span>
            </a>
          </div>
          
          <!-- Divider -->
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
            <div style="flex: 1; height: 1px; background: #e2e8f0;"></div>
            <span style="font-size: 0.75rem; font-weight: 600; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em;">или по email</span>
            <div style="flex: 1; height: 1px; background: #e2e8f0;"></div>
          </div>
          
          <!-- Registration Form -->
          <div id="guest-reg-alert" class="alert alert-danger d-none mb-16" role="alert" style="border-radius: 1rem; font-size: 0.875rem;"></div>
          
          <form id="guest-registration-form">
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.5625rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.15em; color: #94a3b8; margin-bottom: 0.5rem; padding-left: 0.25rem;">
                Email
              </label>
              <input type="email" id="guest-email" name="email" required
                style="width: 100%; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 1rem; padding: 0.875rem 1.25rem; font-weight: 600; font-size: 0.875rem; transition: all 0.2s;"
                onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'"
                onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'"
                placeholder="ivan@example.com">
            </div>
            
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.5625rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.15em; color: #94a3b8; margin-bottom: 0.5rem; padding-left: 0.25rem;">
                Пароль
              </label>
              <input type="password" id="guest-password" name="password" required minlength="6"
                style="width: 100%; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 1rem; padding: 0.875rem 1.25rem; font-weight: 600; font-size: 0.875rem; transition: all 0.2s;"
                onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'"
                onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'"
                placeholder="Минимум 6 символов">
            </div>
            
            <div style="margin-bottom: 1.25rem;">
              <label style="display: block; font-size: 0.5625rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.15em; color: #94a3b8; margin-bottom: 0.5rem; padding-left: 0.25rem;">
                Имя <span style="font-weight: 500; color: #cbd5e1;">(необязательно)</span>
              </label>
              <input type="text" id="guest-name" name="name"
                style="width: 100%; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 1rem; padding: 0.875rem 1.25rem; font-weight: 600; font-size: 0.875rem; transition: all 0.2s;"
                onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'"
                onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'"
                placeholder="Иван Иванов">
            </div>
            
            <div style="margin-bottom: 1.5rem;">
              <label style="display: flex; align-items: flex-start; gap: 0.75rem; cursor: pointer;">
                <input type="checkbox" id="guest-terms" required
                  style="width: 1.25rem; height: 1.25rem; border-radius: 0.375rem; border: 2px solid #cbd5e1; margin-top: 2px; flex-shrink: 0; accent-color: #3b82f6;">
                <span style="font-size: 0.75rem; color: #64748b; line-height: 1.5;">
                  Принимаю <a href="/privacy/" target="_blank" style="color: #3b82f6; text-decoration: none;">политику конфиденциальности</a> и <a href="/agreement/" target="_blank" style="color: #3b82f6; text-decoration: none;">условия использования</a>
                </span>
              </label>
            </div>
            
            <button type="submit" id="guest-reg-submit-btn"
              style="width: 100%; padding: 1rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 1.25rem; font-weight: 800; font-size: 0.8125rem; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; transition: all 0.3s;"
              onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 25px -5px rgba(59,130,246,0.4)'"
              onmouseout="this.style.transform='none'; this.style.boxShadow='none'">
              Зарегистрироваться
            </button>
          </form>
          
          <!-- Login link -->
          <p style="text-align: center; margin: 1.25rem 0 0; font-size: 0.875rem; color: #64748b;">
            Уже есть аккаунт? <a href="/login/" style="color: #3b82f6; font-weight: 600; text-decoration: none;">Войти</a>
          </p>
          
        </div>
      </div>
    </div>
  </div>
</div>

<!-- jQuery library js -->
<script src="/static/js/lib/jquery-3.7.1.min.js"></script>
<!-- Bootstrap js -->
<script src="/static/js/lib/bootstrap.bundle.min.js"></script>
<!-- Iconify Font js -->
<script src="/static/js/lib/iconify-icon.min.js"></script>
<!-- Date picker js -->
<script src="/static/js/flatpickr.js"></script>
<!-- jQuery UI js -->
<script src="/static/js/lib/jquery-ui.min.js"></script>
<!-- main js -->
<script src="/static/js/app.js"></script>

<!-- Pass Jinja2 variables to JavaScript -->
<script>
    window.UPD_CONFIG = {
        editDocumentId: '{{ edit_document_id | default("") }}',
        apiUrl: '/api/v1'
    };
</script>

<!-- UPD Constructor Main JS (extracted from inline) -->
<script src="/static/js/upd-constructor/upd-main.js?v=3.4"></script>

<!-- Support Widget -->
{% include 'components/support_widget.html' %}

</body>
</html>
