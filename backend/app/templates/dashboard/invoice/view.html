<!DOCTYPE html>
<html lang="ru" data-theme="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ title }}</title>
  <link rel="icon" type="image/svg+xml" href="/static/images/favicon.svg">
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <!-- remix icon font css -->
  <link rel="stylesheet" href="/static/css/remixicon.css">
  <!-- Iconify for v12 icons -->
  <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
  <!-- BootStrap css -->
  <link rel="stylesheet" href="/static/css/lib/bootstrap.min.css">
  <!-- Documatica v12.0 Design System (ONLY v12, no old styles) -->
  <link rel="stylesheet" href="/static/css/documatica.css?v=12.11">
  <style>
    /* Constructor page styles */
    body.constructor-page-v12 {
      background-color: #f8fafc !important;
      background-image: radial-gradient(circle, #3b82f6 1px, transparent 1px) !important;
      background-size: 32px 32px !important;
      background-attachment: fixed !important;
      margin: 0 !important;
      padding: 0 !important;
      min-height: 100vh !important;
    }
    
    /* Sidebar fixed on left */
    body.constructor-page-v12 aside.sidebar-v12 {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 320px !important;
      height: 100vh !important;
      z-index: 50 !important;
      overflow-y: auto !important;
    }
    
    /* Main content with left margin */
    body.constructor-page-v12 .dashboard-main-v12 {
      margin-left: 320px !important;
      min-height: 100vh !important;
      padding-top: 0 !important;
      margin-top: 0 !important;
      position: relative !important;
    }
    
    .card {
      background: white !important;
      border: 1px solid #e2e8f0 !important;
      border-radius: 2rem !important;
      overflow: hidden !important;
      box-shadow: 0 4px 20px rgba(15, 23, 42, 0.04) !important;
      margin-bottom: 24px !important;
    }
    
    .card-header {
      padding: 20px 28px !important;
      border-bottom: 1px solid #f1f5f9 !important;
      background: transparent !important;
    }
    
    .card-header h6 {
      font-size: 10px !important;
      font-weight: 900 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.3em !important;
      color: #94a3b8 !important;
      margin: 0 !important;
    }
    
    .card-body {
      padding: 24px !important;
    }
    
    .preview-frame {
      background: white;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(15, 23, 42, 0.08);
    }
    
    .preview-frame iframe {
      width: 100%;
      height: 800px;
      border: none;
    }
    
    .btn-primary-600 {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%) !important;
      border: none !important;
      border-radius: 1.5rem !important;
      padding: 14px 28px !important;
      font-size: 11px !important;
      font-weight: 800 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.12em !important;
      color: white !important;
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.25) !important;
      transition: all 0.3s ease !important;
    }
    
    .btn-primary-600:hover {
      transform: translateY(-2px) !important;
      box-shadow: 0 10px 28px rgba(59, 130, 246, 0.35) !important;
      color: white !important;
    }
    
    .btn-outline-primary-600 {
      background: white !important;
      border: 2px solid #e2e8f0 !important;
      border-radius: 1.5rem !important;
      padding: 12px 24px !important;
      font-size: 11px !important;
      font-weight: 700 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.1em !important;
      color: #64748b !important;
      transition: all 0.3s ease !important;
    }
    
    .btn-outline-primary-600:hover {
      background: #f8fafc !important;
      border-color: #3b82f6 !important;
      color: #3b82f6 !important;
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    
    .info-item {
      padding: 16px;
      background: #f8fafc;
      border-radius: 1rem;
    }
    
    .info-item .label {
      font-size: 9px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: #94a3b8;
      margin-bottom: 4px;
    }
    
    .info-item .value {
      font-size: 15px;
      font-weight: 700;
      color: #0f172a;
    }
    
    @media (max-width: 1023px) {
      body.constructor-page-v12 aside.sidebar-v12 {
        position: fixed !important;
        transform: translateX(-100%) !important;
        z-index: 1000 !important;
        height: 100vh !important;
      }
      body.constructor-page-v12.sidebar-open aside.sidebar-v12 {
        transform: translateX(0) !important;
      }
      body.constructor-page-v12 .dashboard-main-v12 {
        margin-left: 0 !important;
      }
    }
  </style>
</head>

<body class="constructor-page-v12">

<!-- Sidebar v12 -->
{% include 'components/sidebar_v12.html' %}

<!-- Sidebar Overlay for mobile -->
<div class="sidebar-overlay-v12" onclick="document.body.classList.remove('sidebar-open')"></div>

<main class="dashboard-main-v12">
  <!-- Header v12 -->
  {% include 'components/header_dashboard_v12.html' %}

  <div class="dashboard-content-v12">
    
    <!-- Page Header -->
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-32">
      <div>
        <h5 class="mb-0" style="font-size: 26px; font-weight: 800; color: #0f172a;">
          Счёт {{ document.document_number if document else '' }}
        </h5>
        <p class="text-secondary-light mt-2 mb-0" style="font-size: 14px;">
          от {{ document.document_date if document else '' }}
        </p>
      </div>
      <div class="d-flex gap-12">
        <a href="/dashboard/invoice/create/" class="btn btn-outline-primary-600">
          <iconify-icon icon="mdi:plus" width="18" class="me-2"></iconify-icon>
          Новый счёт
        </a>
        <button type="button" class="btn btn-primary-600" id="download-pdf-btn">
          <iconify-icon icon="mdi:download" width="18" class="me-2"></iconify-icon>
          Скачать PDF
        </button>
      </div>
    </div>
    
    <div class="row">
      <!-- Left Column - Info -->
      <div class="col-xl-4">
        
        <!-- Document Info Card -->
        <div class="card">
          <div class="card-header">
            <h6>Информация о документе</h6>
          </div>
          <div class="card-body">
            <div class="info-grid">
              <div class="info-item">
                <div class="label">Номер счёта</div>
                <div class="value">{{ document.document_number if document else '' }}</div>
              </div>
              <div class="info-item">
                <div class="label">Дата</div>
                <div class="value">{{ document.document_date if document else '' }}</div>
              </div>
              <div class="info-item">
                <div class="label">Сумма</div>
                <div class="value" style="color: #3b82f6;">
                  {{ "%.2f"|format(document.total_amount) if document and document.total_amount else '0.00' }} руб.
                </div>
              </div>
              <div class="info-item">
                <div class="label">Создан</div>
                <div class="value">{{ document.created_at[:10] if document and document.created_at else '' }}</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Supplier Card -->
        <div class="card">
          <div class="card-header">
            <h6>Поставщик</h6>
          </div>
          <div class="card-body">
            <div class="info-item">
              <div class="label">Наименование</div>
              <div class="value">{{ document.seller_name if document else '' }}</div>
            </div>
          </div>
        </div>
        
        <!-- Client Card -->
        <div class="card">
          <div class="card-header">
            <h6>Покупатель</h6>
          </div>
          <div class="card-body">
            <div class="info-item">
              <div class="label">Наименование</div>
              <div class="value">{{ document.buyer_name if document else '' }}</div>
            </div>
          </div>
        </div>
        
        <!-- Actions -->
        <div class="card">
          <div class="card-header">
            <h6>Действия</h6>
          </div>
          <div class="card-body d-flex flex-column gap-12">
            <a href="/dashboard/invoice/edit/{{ document_id }}/" class="btn btn-outline-primary-600 w-100">
              <iconify-icon icon="mdi:pencil" width="18" class="me-2"></iconify-icon>
              Редактировать
            </a>
            <button type="button" class="btn btn-outline-primary-600 w-100" id="print-btn">
              <iconify-icon icon="mdi:printer" width="18" class="me-2"></iconify-icon>
              Печать
            </button>
            <button type="button" class="btn w-100" style="background: #fef2f2; color: #ef4444; border-radius: 1.5rem; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; padding: 12px 24px;" id="delete-btn">
              <iconify-icon icon="mdi:trash-can" width="18" class="me-2"></iconify-icon>
              Удалить
            </button>
          </div>
        </div>
        
      </div>
      
      <!-- Right Column - Preview -->
      <div class="col-xl-8">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h6>Предпросмотр документа</h6>
          </div>
          <div class="card-body p-0">
            <div class="preview-frame">
              <iframe id="preview-iframe" src="/api/v1/documents/invoice/{{ document_id }}/preview"></iframe>
            </div>
          </div>
        </div>
      </div>
      
    </div>
  </div>

  <!-- Footer -->
  {% include 'components/footer.html' %}
</main>

<!-- jQuery -->
<script src="/static/js/lib/jquery-3.7.1.min.js"></script>
<!-- Bootstrap Bundle JS -->
<script src="/static/js/lib/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const token = localStorage.getItem('access_token') || getCookie('access_token');
  const documentId = '{{ document_id }}';
  
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }
  
  // Download PDF
  document.getElementById('download-pdf-btn').addEventListener('click', function() {
    window.location.href = '/api/v1/documents/invoice/' + documentId + '/pdf';
  });
  
  // Print
  document.getElementById('print-btn').addEventListener('click', function() {
    const iframe = document.getElementById('preview-iframe');
    iframe.contentWindow.focus();
    iframe.contentWindow.print();
  });
  
  // Delete
  document.getElementById('delete-btn').addEventListener('click', async function() {
    if (!confirm('Вы уверены, что хотите удалить этот счёт?')) {
      return;
    }
    
    try {
      const response = await fetch('/api/v1/documents/saved/' + documentId, {
        method: 'DELETE',
        headers: token ? { 'Authorization': 'Bearer ' + token } : {},
        credentials: 'include'
      });
      
      if (response.ok) {
        window.location.href = '/dashboard/documents/';
      } else {
        alert('Ошибка при удалении документа');
      }
    } catch (error) {
      console.error('Delete error:', error);
      alert('Ошибка при удалении документа');
    }
  });
});
</script>

</body>
</html>
