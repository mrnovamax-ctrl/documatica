<!DOCTYPE html>
<html lang="ru" data-theme="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Создать счёт на оплату - Documatica</title>
  <link rel="icon" type="image/svg+xml" href="/static/images/favicon.svg">
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <!-- remix icon font css -->
  <link rel="stylesheet" href="/static/css/remixicon.css">
  <!-- Iconify for v12 icons -->
  <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
  <!-- BootStrap css -->
  <link rel="stylesheet" href="/static/css/lib/bootstrap.min.css">
  <!-- Date picker css -->
  <link rel="stylesheet" href="/static/css/lib/flatpickr.min.css">
  <!-- html2canvas for preview -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- Documatica v12.0 Design System (ONLY v12, no old styles) -->
  <link rel="stylesheet" href="/static/css/documatica.css?v=12.9">
  <!-- UPD Constructor Styles (extracted from inline for better performance) -->
    <link rel="stylesheet" href="/static/css/upd-constructor.css?v=2.1">
  <!-- Toast Notifications -->
  <script src="/static/js/toasts.js"></script>
  
  <style>
    /* Анимация выезда кнопки "Добавить в контрагенты" */
    #save-buyer-btn {
      opacity: 0;
      visibility: hidden;
    }
    #save-buyer-btn.show {
      opacity: 1 !important;
      visibility: visible !important;
      transform: translateX(0) !important;
    }
    #save-buyer-btn:hover {
      padding: 0 16px !important;
      box-shadow: 0 4px 16px rgba(251, 191, 36, 0.5) !important;
    }
    #save-buyer-btn:hover span {
      opacity: 1 !important;
      width: auto !important;
    }
    #save-buyer-btn:hover svg {
      transform: rotate(90deg) !important;
    }
    #save-buyer-btn:active {
      transform: translateX(0) scale(0.95) !important;
    }
    
    /* Анимация выезда кнопки "Добавить в организации" */
    #save-seller-btn {
      opacity: 0;
      visibility: hidden;
    }
    #save-seller-btn.show {
      opacity: 1 !important;
      visibility: visible !important;
      transform: translateX(0) !important;
    }
    #save-seller-btn:hover {
      padding: 0 16px !important;
      box-shadow: 0 4px 16px rgba(251, 191, 36, 0.5) !important;
    }
    #save-seller-btn:hover span {
      opacity: 1 !important;
      width: auto !important;
    }
    #save-seller-btn:hover svg {
      transform: rotate(90deg) !important;
    }
    #save-seller-btn:active {
      transform: translateX(0) scale(0.95) !important;
    }
  </style>
  
  <!-- Yandex.Metrika counter -->
  <script type="text/javascript">
      (function(m,e,t,r,i,k,a){
          m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
          m[i].l=1*new Date();
          for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
          k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
      })(window, document,'script','https://mc.yandex.ru/metrika/tag.js', 'ym');

      ym(76440544, 'init', {webvisor:true, clickmap:true, referrer: document.referrer, url: location.href, accurateTrackBounce:true, trackLinks:true});
  </script>
  <noscript><div><img src="https://mc.yandex.ru/watch/76440544" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
  <!-- /Yandex.Metrika counter -->
</head>

<body class="constructor-page-v12">

<!-- Sidebar v12 -->
{% include 'components/sidebar_v12.html' %}

<!-- Sidebar Overlay for mobile -->
<div class="sidebar-overlay-v12" onclick="document.body.classList.remove('sidebar-open')"></div>

<!-- Mobile Burger Button -->
<button class="constructor-burger-btn" onclick="document.body.classList.toggle('sidebar-open')" style="position: fixed; top: 16px; right: 16px; z-index: 1001; width: 48px; height: 48px; background: white; border: 1px solid #e2e8f0; border-radius: 12px; display: none; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
  <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="#64748b" stroke-width="2">
    <line x1="3" y1="6" x2="21" y2="6"></line>
    <line x1="3" y1="12" x2="21" y2="12"></line>
    <line x1="3" y1="18" x2="21" y2="18"></line>
  </svg>
</button>
<style>
  @media (max-width: 1023px) {
    .constructor-burger-btn { display: flex !important; }
    .sidebar-v12 { transform: translateX(-100%); z-index: 1000; transition: transform 0.3s ease; }
    body.sidebar-open .sidebar-v12 { transform: translateX(0); }
    body.sidebar-open .sidebar-overlay-v12 { opacity: 1; visibility: visible; }
    .sidebar-overlay-v12 { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
  }
</style>

<main class="dashboard-main-v12">
  <!-- Header v12 -->
  {% include 'components/header_dashboard_v12.html' %}

  <div class="dashboard-content-v12 upd-constructor-page">
    <!-- Page Title -->
    <div class="page-title-v12">
      <h1>Создать счёт на оплату</h1>
      <p>Счёт на оплату товаров и услуг</p>
    </div>

    <form id="upd-form">
      <div class="row gy-4">
        <!-- Left Column - Form -->
        <div class="col-xxl-7 col-xl-6">
          <!-- Document Info -->
          <div class="card radius-16 mb-24">
            <div class="card-header py-16 px-24 border-bottom">
              <h4 class="mb-0">Параметры документа</h4>
            </div>
            <div class="card-body p-24">
              <div class="row g-16" style="margin-bottom: 24px;">
                <!-- Номер и дата -->
                <div class="col-md-6">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Номер счёта <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="invoice-number" placeholder="Авто" required>
                    <button class="btn btn-outline-secondary-600" type="button" id="auto-number-btn" title="Автонумерация">
                      Авто
                    </button>
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Дата счёта <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <input type="text" class="form-control date-picker" id="invoice-date" placeholder="дд.мм.гггг" required>
                    <button class="btn btn-outline-secondary-600" type="button" id="invoice-date-icon">
                      <iconify-icon icon="mdi:calendar"></iconify-icon>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Supplier Info -->
          <div class="card radius-16 mb-24">
            <div class="card-header py-16 px-24 border-bottom d-flex align-items-center justify-content-between">
              <h4 class="mb-0">Поставщик</h4>
              <button type="button" class="btn btn-sm btn-outline-primary-600" data-bs-toggle="modal" data-bs-target="#selectCompanyModal">
                Выбрать из списка
              </button>
            </div>
            <div class="card-body p-24">
              <div class="row g-16" style="margin-bottom: 24px;">
                <div class="col-md-6">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Наименование <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="supplier-name" placeholder='ООО "Название" или ИП Иванов И.И.' required>
                </div>
                <div class="col-md-3">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">ИНН <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="supplier-inn" placeholder="7707123456" required maxlength="12">
                    <button class="btn btn-outline-primary-600 dadata-search-btn" type="button" id="supplier-inn-search" title="Найти по ИНН">
                      <iconify-icon icon="mdi:magnify" class="text-lg"></iconify-icon>
                    </button>
                  </div>
                  <small class="text-muted d-none" id="supplier-inn-loading">Поиск...</small>
                </div>
                <div class="col-md-3">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">КПП</label>
                  <input type="text" class="form-control" id="supplier-kpp" placeholder="770701001" maxlength="9">
                </div>
                <div class="col-12 d-none" id="supplier-inn-error-container">
                  <div class="alert alert-danger py-2 px-3 mb-0" role="alert">
                    <small id="supplier-inn-error"></small>
                  </div>
                </div>
                <div class="col-12">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Адрес <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="supplier-address" placeholder="123456, г. Москва, ул. Примерная, д. 1" required>
                </div>
              </div>
              
              <!-- Банковские реквизиты -->
              <div class="mt-24 pt-16 border-top">
                <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 16px;">Банковские реквизиты</label>
                <div class="row g-16" style="margin-bottom: 24px;">
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Наименование банка <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="bank-name" placeholder="ПАО Сбербанк" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">БИК <span class="text-danger">*</span></label>
                    <div class="input-group">
                      <input type="text" class="form-control" id="bank-bik" placeholder="044525225" required maxlength="9">
                      <button class="btn btn-outline-primary-600 dadata-search-btn" type="button" id="bank-bik-search" title="Найти по БИК">
                        <iconify-icon icon="mdi:magnify" class="text-lg"></iconify-icon>
                      </button>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Расчётный счёт <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="bank-account" placeholder="40702810000000000001" required maxlength="20">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Корр. счёт</label>
                    <input type="text" class="form-control" id="bank-corr" placeholder="30101810400000000225" maxlength="20">
                  </div>
                </div>
              </div>
              
              <!-- Подписанты -->
              <div class="mt-24 pt-16 border-top">
                <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 16px;">Подписанты</label>
                <div class="row g-16" style="margin-bottom: 24px;">
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Руководитель</label>
                    <input type="text" class="form-control" id="signer-director" placeholder="Иванов И.И.">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Главный бухгалтер</label>
                    <input type="text" class="form-control" id="signer-accountant" placeholder="Петрова П.П.">
                  </div>
                </div>
              </div>
              
              <!-- Настройки НДС -->
              <div class="mt-24 pt-16 border-top">
                <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 16px;">Настройки НДС</label>
                <div class="row g-16" style="margin-bottom: 24px;">
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Ставка НДС</label>
                    <select class="form-select" id="default-vat">
                      <option value="22">22%</option>
                      <option value="20" selected>20%</option>
                      <option value="18">18%</option>
                      <option value="10">10%</option>
                      <option value="7">7%</option>
                      <option value="5">5%</option>
                      <option value="0">0%</option>
                      <option value="none">Без НДС</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Расчёт НДС</label>
                    <select class="form-select" id="default-vat-type">
                      <option value="on-top" selected>Сверху (начисляется)</option>
                      <option value="included">Включен в цену</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Buyer Info -->
          <div class="card radius-16 mb-24">
            <div class="card-header py-16 px-24 border-bottom d-flex align-items-center justify-content-between">
              <h4 class="mb-0">Покупатель (Плательщик)</h4>
              <button type="button" class="btn btn-sm btn-outline-primary-600" data-bs-toggle="modal" data-bs-target="#selectContractorModal">
                Выбрать из списка
              </button>
            </div>
            <div class="card-body p-24">
              <div class="row g-16" style="margin-bottom: 24px;">
                <div class="col-md-6">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Наименование <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="buyer-name" placeholder='ООО "Контрагент"' required>
                </div>
                <div class="col-md-3">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">ИНН <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="buyer-inn" placeholder="7708654321" required maxlength="12">
                    <button class="btn btn-outline-primary-600 dadata-search-btn" type="button" id="buyer-inn-search" title="Найти по ИНН">
                      <iconify-icon icon="mdi:magnify" class="text-lg"></iconify-icon>
                    </button>
                  </div>
                  <small class="text-muted d-none" id="buyer-inn-loading">Поиск...</small>
                </div>
                <div class="col-md-3">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">КПП</label>
                  <input type="text" class="form-control" id="buyer-kpp" placeholder="770801001" maxlength="9">
                </div>
                <div class="col-12 d-none" id="buyer-inn-error-container">
                  <div class="alert alert-danger py-2 px-3 mb-0" role="alert">
                    <small id="buyer-inn-error"></small>
                  </div>
                </div>
                <div class="col-12">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Адрес</label>
                  <input type="text" class="form-control" id="buyer-address" placeholder="654321, г. Санкт-Петербург, пр. Невский, д. 100">
                </div>
              </div>
            </div>
          </div>
          
          <!-- Additional Info -->
          <div class="card radius-16 mb-24">
            <div class="card-header py-16 px-24 border-bottom">
              <h4 class="mb-0">Дополнительно</h4>
            </div>
            <div class="card-body p-24">
              <div class="row g-16" style="margin-bottom: 24px;">
                <div class="col-md-6">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Основание</label>
                  <input type="text" class="form-control" id="contract-info" placeholder="Договор № от дд.мм.гггг">
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Срок оплаты (дней)</label>
                  <input type="number" class="form-control" id="payment-due" placeholder="5" min="1">
                </div>
                <div class="col-12">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Примечание</label>
                  <textarea class="form-control" id="invoice-note" rows="2" placeholder="Дополнительная информация для покупателя"></textarea>
                </div>
              </div>
            </div>
          </div>

          <!-- Products/Services -->
          <div class="card radius-16 mb-24">
            <div class="card-header py-16 px-24 border-bottom">
              <h4 class="mb-0">
                Товары и услуги
              </h4>
            </div>
            <div class="card-body p-24">
              <div id="products-container">
                <!-- Product Row 1 -->
                <div class="product-row card border radius-12 p-16 mb-16" data-row="1">
                  <div class="row g-12 align-items-end">
                    <div class="col">
                      <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Наименование <span class="text-danger">*</span></label>
                      <input type="text" class="form-control product-name" placeholder="Название товара или услуги" required>
                    </div>
                    <div class="col-auto" style="width: 100px;">
                      <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Кол-во</label>
                      <input type="number" class="form-control product-qty" value="1" min="0.01" step="0.01">
                    </div>
                    <div class="col-auto" style="width: 110px;">
                      <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Ед. изм.</label>
                      <select class="form-select product-unit">
                        <option value="шт">шт</option>
                        <option value="усл">усл</option>
                        <option value="ч">ч</option>
                        <option value="кг">кг</option>
                        <option value="л">л</option>
                        <option value="м">м</option>
                        <option value="м2">м2</option>
                        <option value="м3">м3</option>
                      </select>
                    </div>
                    <div class="col-auto" style="width: 120px;">
                      <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Цена</label>
                      <input type="number" class="form-control product-price" value="0" min="0" step="0.01">
                    </div>
                    <div class="col-auto" style="width: 120px;">
                      <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Сумма</label>
                      <input type="text" class="form-control product-total" value="0 ₽" readonly>
                    </div>
                    <div class="col-auto">
                      <button type="button" class="btn btn-outline-danger remove-product" title="Удалить">
                        <iconify-icon icon="mdi:trash-can-outline"></iconify-icon>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Add Product Buttons -->
              <div class="d-flex mb-16" style="gap: 16px;">
                <button type="button" class="add-product-btn flex-grow-1 py-16 radius-12 d-flex align-items-center justify-content-center gap-8 text-secondary-light" id="add-product">
                  <iconify-icon icon="mdi:plus-circle" class="text-xl"></iconify-icon>
                  Добавить ещё
                </button>
                <button type="button" class="add-product-btn flex-grow-1 py-16 radius-12 d-flex align-items-center justify-content-center gap-8 text-secondary-light" data-bs-toggle="modal" data-bs-target="#selectProductModal">
                  <iconify-icon icon="mdi:package-variant" class="text-xl"></iconify-icon>
                  Выбрать из справочника
                </button>
              </div>

              <!-- Totals -->
              <div style="margin-top: 48px;">
                <div class="row justify-content-end">
                  <div class="col-md-6">
                    <div class="d-flex justify-content-between mb-16">
                      <span class="text-secondary-light">Итого без НДС:</span>
                      <span class="fw-medium" id="total-without-vat">0 ₽</span>
                    </div>
                    <div class="d-flex justify-content-between mb-16">
                      <span class="text-secondary-light">НДС:</span>
                      <span class="fw-medium" id="total-vat">0 ₽</span>
                    </div>
                    <div class="d-flex justify-content-between">
                      <span class="fw-semibold text-lg">Итого с НДС:</span>
                      <span class="fw-bold text-lg text-primary-600" id="total-with-vat">0 ₽</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="card radius-16">
            <div class="card-body p-24">
              <div class="d-flex flex-wrap justify-content-center" style="gap: 16px;">
                <button type="button" class="btn btn-outline-neutral-600 px-24" id="save-draft">
                  Сохранить черновик
                </button>
                <button type="button" class="btn btn-outline-neutral-600 px-24" id="save-template">
                  Сохранить как шаблон
                </button>
                <button type="button" class="btn btn-outline-primary-600 px-24" id="preview-btn" data-bs-toggle="modal" data-bs-target="#previewModal">
                  Предпросмотр
                </button>
                <button type="submit" class="btn btn-primary-600 px-32">
                  Скачать PDF
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column - Preview -->
        <div class="col-xxl-5 col-xl-6 d-none d-xl-block">
          <div class="sticky-preview">
            <div class="card radius-16">
              <div class="card-header py-16 px-24 border-bottom d-flex align-items-center justify-content-between">
                <h4 class="mb-0">Предпросмотр счёта</h4>
                <button type="button" class="btn btn-sm btn-outline-primary-600" data-bs-toggle="modal" data-bs-target="#previewModal">
                  Предпросмотр
                </button>
              </div>
              <div class="card-body p-0 bg-white d-flex align-items-start justify-content-center position-relative" style="overflow: auto; background: #f8fafc;">
                <canvas id="sidebar-preview-canvas" style="width: 100%; height: auto;"></canvas>
                <!-- Лупа -->
                <div id="canvas-magnifier" style="display: none; position: absolute; width: 400px; height: 300px; border: 3px solid #3b82f6; border-radius: 12px; pointer-events: none; z-index: 1000; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3); background: white;">
                  <canvas id="magnifier-canvas" width="1200" height="900" style="width: 100%; height: 100%; display: block;"></canvas>
                </div>
              </div>
            </div>
            
            <!-- AI Analysis Block -->
            <div class="card radius-16 mt-24">
              <div class="card-header py-16 px-24 d-flex align-items-center justify-content-between" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);">
                <div class="d-flex align-items-center" style="gap: 24px;">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2">
                    <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/>
                    <circle cx="7.5" cy="14.5" r="1.5"/>
                    <circle cx="16.5" cy="14.5" r="1.5"/>
                  </svg>
                  <span class="fw-bold text-uppercase" style="font-size: 18px; letter-spacing: 0.3em; color: #fbbf24; font-weight: 900;">ИИ Анализ документа</span>
                </div>
                <div class="d-flex align-items-center gap-8">
                  <button type="button" class="btn btn-sm d-none align-items-center gap-8" id="clear-highlights-btn" style="background: transparent; color: #94a3b8; border: 1px solid #475569; font-weight: 600; font-size: 10px; text-transform: uppercase;">
                    Сбросить подсветку
                  </button>
                  <button type="button" class="btn btn-sm d-flex align-items-center gap-8" id="ai-analyze-btn" style="background: #fbbf24; color: #0f172a; font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="11" cy="11" r="8"/>
                      <path d="m21 21-4.3-4.3"/>
                    </svg>
                    Анализировать
                  </button>
                </div>
              </div>
              <div class="card-body" id="ai-analysis-result" style="min-height: 100px;">
                <div class="text-center py-24 text-secondary-light">
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mb-12 mx-auto d-block" style="opacity: 0.5;">
                    <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 1 1 7.072 0l-.548.547A3.374 3.374 0 0 0 11 18.469V19a2 2 0 1 1-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                  </svg>
                  <p class="mb-4 fw-semibold text-secondary-light">Нажмите "Анализировать" для проверки документа</p>
                  <small class="text-secondary-light">ИИ проверит документ на ошибки с точки зрения бухгалтера и юриста</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
  
</main>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
  <div class="modal-dialog" style="max-width: 98vw; width: 1200px; margin: 20px auto;">
    <div class="modal-content radius-16" style="overflow: hidden;">
      <div class="modal-header bg-neutral-50 py-12 px-24 border-bottom">
        <h5 class="modal-title">Предпросмотр УПД</h5>
        <div class="d-flex gap-12 align-items-center">
          <button type="button" class="btn btn-sm btn-primary-600" id="modal-download-pdf">
            Скачать PDF
          </button>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
      </div>
      <div class="modal-body p-0 bg-white" style="overflow: hidden;">
        <iframe id="preview-iframe" style="width: 100%; height: 850px; border: none; display: block;" scrolling="no"></iframe>
      </div>
    </div>
  </div>
</div>

<!-- Select Company (Organization) Modal -->
<div class="modal fade" id="selectCompanyModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content radius-16">
      <div class="modal-header bg-neutral-50 py-16 px-24 border-bottom">
        <div>
          <h5 class="modal-title mb-1">Выберите организацию</h5>
          <p class="text-secondary-light text-sm mb-0">Нажмите на карточку для выбора</p>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-24">
        <div class="docu-mb-48">
          <input type="text" class="form-control" id="search-organization" placeholder="Поиск по названию или ИНН...">
        </div>
        <div id="organizations-modal-list" class="row g-3">
          <div class="col-12 text-center py-24 text-secondary-light">
            <iconify-icon icon="mdi:loading" class="spin text-2xl"></iconify-icon>
            <p class="mt-8">Загрузка организаций...</p>
          </div>
        </div>
        <div id="no-organizations-message" style="display: none;" class="text-center py-24">
          <iconify-icon icon="mdi:domain" class="text-secondary-light text-4xl"></iconify-icon>
          <p class="mt-8 text-secondary-light">Организации не найдены</p>
          <a href="/dashboard/organizations/create/" class="btn btn-sm btn-primary-600 mt-8">
            <iconify-icon icon="mdi:plus" class="me-1"></iconify-icon>
            Добавить организацию
          </a>
        </div>
      </div>
      <div class="modal-footer bg-neutral-50 border-top">
        <a href="/dashboard/organizations/create/" class="btn btn-outline-primary-600">
          <iconify-icon icon="mdi:plus" class="me-1"></iconify-icon>
          Добавить новую
        </a>
      </div>
    </div>
  </div>
</div>
<!-- Select Contractor Modal -->
<div class="modal fade" id="selectContractorModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content radius-16">
      <div class="modal-header bg-neutral-50 py-16 px-24 border-bottom">
        <div>
          <h5 class="modal-title mb-1">Выберите контрагента</h5>
          <p class="text-secondary-light text-sm mb-0">Нажмите на карточку для выбора</p>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-24">
        <div class="docu-mb-48">
          <input type="text" class="form-control" id="search-contractor" placeholder="Поиск по названию или ИНН...">
        </div>
        <div id="contractors-modal-list" class="row g-3">
          <div class="col-12 text-center py-24 text-secondary-light">
            <iconify-icon icon="mdi:loading" class="spin text-2xl"></iconify-icon>
            <p class="mt-8">Загрузка контрагентов...</p>
          </div>
        </div>
        <div id="no-contractors-message" style="display: none;" class="text-center py-24">
          <iconify-icon icon="mdi:account-group" class="text-secondary-light text-4xl"></iconify-icon>
          <p class="mt-8 text-secondary-light">Контрагенты не найдены</p>
          <a href="/dashboard/contractors/create/" class="btn btn-sm btn-primary-600 mt-8">
            <iconify-icon icon="mdi:plus" class="me-1"></iconify-icon>
            Добавить контрагента
          </a>
        </div>
      </div>
      <div class="modal-footer bg-neutral-50 border-top">
        <a href="/dashboard/contractors/create/" class="btn btn-outline-primary-600">
          <iconify-icon icon="mdi:plus" class="me-1"></iconify-icon>
          Добавить нового
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Select Product Modal -->
<div class="modal fade" id="selectProductModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content radius-16">
      <div class="modal-header bg-neutral-50 py-12 px-24 border-bottom">
        <h5 class="modal-title">Выберите товар или услугу</h5>
      </div>
      <div class="modal-body p-24">
        <div class="mb-16">
          <input type="text" class="form-control" id="search-product-modal" placeholder="Поиск по названию или артикулу...">
        </div>
        <div id="products-modal-list">
          <div class="text-center py-24 text-secondary-light">
            <iconify-icon icon="mdi:loading" class="spin text-2xl"></iconify-icon>
            <p class="mt-8">Загрузка товаров...</p>
          </div>
        </div>
        <div id="no-products-message" style="display: none;" class="text-center py-24">
          <iconify-icon icon="mdi:package-variant" class="text-secondary-light text-4xl"></iconify-icon>
          <p class="mt-8 text-secondary-light">Товары не найдены</p>
          <a href="/dashboard/products" class="btn btn-sm btn-primary-600 mt-8">Добавить товар</a>
        </div>
      </div>
      <div class="modal-footer">
        <a href="/dashboard/products" class="btn btn-outline-primary-600">
          <iconify-icon icon="mdi:plus"></iconify-icon>
          В справочник
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Auth Required Modal -->
<div class="modal fade" id="authRequiredModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border: none; border-radius: 2.5rem; overflow: hidden; box-shadow: 0 50px 100px -20px rgba(15,23,42,0.25);">
      <div class="modal-body p-0">
        <!-- Success Header -->
        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 2.5rem; text-align: center;">
          <div style="width: 80px; height: 80px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          </div>
          <h3 style="color: white; font-size: 1.5rem; font-weight: 900; margin: 0;">Документ сохранён</h3>
        </div>
        
        <!-- Content -->
        <div style="padding: 2rem 2.5rem 2.5rem;">
          
          <!-- Dynamic draft save status -->
          <div id="draft-save-status-auth" style="text-align: center; margin-bottom: 1rem; padding: 0.75rem; background: #f0fdf4; border-radius: 1rem;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
              <svg class="spin" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
                <path d="M21 12a9 9 0 11-6.219-8.56"/>
              </svg>
              <span style="color: #1e40af; font-weight: 600;">Сохраняем черновик...</span>
            </div>
          </div>
          
          <div style="background: #f0fdf4; border-radius: 1rem; padding: 1rem 1.25rem; margin-bottom: 1.5rem; display: flex; align-items: flex-start; gap: 0.75rem;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M12 16v-4M12 8h.01"></path>
            </svg>
            <p style="margin: 0; font-size: 0.875rem; color: #166534; line-height: 1.5;">
              <strong>Ваш Счёт уже ждёт вас!</strong><br>
              Войдите в аккаунт, и документ появится в личном кабинете.
            </p>
          </div>
          
          <!-- Yandex OAuth - Primary -->
          <a href="/auth/yandex/login" style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; width: 100%; padding: 1rem 1.5rem; background: #FC3F1D; color: white; border-radius: 1.25rem; font-weight: 700; font-size: 0.9375rem; text-decoration: none; transition: all 0.3s; margin-bottom: 0.75rem;"
             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 25px -5px rgba(252,63,29,0.4)'"
             onmouseout="this.style.transform='none'; this.style.boxShadow='none'">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <circle cx="12" cy="12" r="11" fill="white" fill-opacity="0.15"/>
              <text x="8" y="16" font-size="12" font-weight="bold" fill="white">Y</text>
            </svg>
            Войти через Яндекс
          </a>
          
          <!-- Email login -->
          <a href="/login/" style="display: block; width: 100%; padding: 0.875rem 1.5rem; background: #3b82f6; color: white; border-radius: 1.25rem; font-weight: 700; font-size: 0.875rem; text-decoration: none; text-align: center; transition: all 0.3s; margin-bottom: 1.5rem;"
             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 25px -5px rgba(59,130,246,0.4)'"
             onmouseout="this.style.transform='none'; this.style.boxShadow='none'">
            Войти по email
          </a>
          
          <!-- Register link -->
          <p style="text-align: center; margin: 0; font-size: 0.875rem; color: #64748b;">
            Нет аккаунта? <a href="/register/" style="color: #3b82f6; font-weight: 600; text-decoration: none;">Зарегистрироваться</a>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Guest Registration Modal (Documatica v12.0 Style) -->
<div class="modal fade" id="guestRegistrationModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 480px;">
    <div class="modal-content" style="border: none; border-radius: 2.5rem; overflow: hidden; box-shadow: 0 50px 100px -20px rgba(15,23,42,0.3);">
      <div class="modal-body p-0">
        
        <!-- Success Header -->
        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 2rem 2.5rem; position: relative; overflow: hidden;">
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" style="position: absolute; top: 1.25rem; right: 1.25rem; opacity: 0.7;"></button>
          <div style="display: flex; align-items: center; gap: 1rem;">
            <div style="width: 56px; height: 56px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            </div>
            <div>
              <h3 style="color: white; font-size: 1.25rem; font-weight: 800; margin: 0 0 0.25rem;">Документ сохранён</h3>
              <p style="color: rgba(255,255,255,0.9); font-size: 0.875rem; margin: 0;">Осталось только войти или зарегистрироваться</p>
            </div>
          </div>
        </div>
        
        <!-- Content -->
        <div style="padding: 2rem 2.5rem 2.5rem;">
          
          <!-- Dynamic draft save status -->
          <div id="draft-save-status" style="text-align: center; margin-bottom: 1rem; padding: 0.75rem; background: #f0fdf4; border-radius: 1rem;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
              <svg class="spin" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
                <path d="M21 12a9 9 0 11-6.219-8.56"/>
              </svg>
              <span style="color: #1e40af; font-weight: 600;">Сохраняем черновик...</span>
            </div>
          </div>
          
          <!-- Reassurance message -->
          <div style="background: #fefce8; border: 1px solid #fef08a; border-radius: 1rem; padding: 1rem 1.25rem; margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="#eab308" style="flex-shrink: 0; margin-top: 1px;">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
              </svg>
              <div>
                <p style="margin: 0; font-size: 0.8125rem; color: #854d0e; line-height: 1.5;">
                  <strong>Документ никуда не денется!</strong> Он уже привязан к вашему email и будет ждать вас в личном кабинете.
                </p>
              </div>
            </div>
          </div>
          
          <!-- Quick Yandex Login - HERO -->
          <div style="text-align: center; margin-bottom: 1.5rem;">
            <p style="font-size: 0.6875rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.15em; color: #94a3b8; margin-bottom: 0.75rem;">Самый быстрый способ</p>
            <a href="/auth/yandex/login" id="guest-yandex-btn" style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; width: 100%; padding: 1.125rem 1.5rem; background: #FC3F1D; color: white; border-radius: 1.25rem; font-weight: 800; font-size: 0.9375rem; text-decoration: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);"
               onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 15px 30px -5px rgba(252,63,29,0.45)'"
               onmouseout="this.style.transform='none'; this.style.boxShadow='none'">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                <circle cx="12" cy="12" r="11" fill="white" fill-opacity="0.15"/>
                <text x="8" y="16" font-size="12" font-weight="bold" fill="white">Y</text>
              </svg>
              Войти через Яндекс
              <span style="font-size: 0.6875rem; background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-weight: 700;">1 клик</span>
            </a>
          </div>
          
          <!-- Divider -->
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
            <div style="flex: 1; height: 1px; background: #e2e8f0;"></div>
            <span style="font-size: 0.75rem; font-weight: 600; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em;">или по email</span>
            <div style="flex: 1; height: 1px; background: #e2e8f0;"></div>
          </div>
          
          <!-- Registration Form -->
          <div id="guest-reg-alert" class="alert alert-danger d-none mb-16" role="alert" style="border-radius: 1rem; font-size: 0.875rem;"></div>
          
          <form id="guest-registration-form">
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.5625rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.15em; color: #94a3b8; margin-bottom: 0.5rem; padding-left: 0.25rem;">
                Email
              </label>
              <input type="email" id="guest-email" name="email" required
                style="width: 100%; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 1rem; padding: 0.875rem 1.25rem; font-weight: 600; font-size: 0.875rem; transition: all 0.2s;"
                onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'"
                onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'"
                placeholder="ivan@example.com">
            </div>
            
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.5625rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.15em; color: #94a3b8; margin-bottom: 0.5rem; padding-left: 0.25rem;">
                Пароль
              </label>
              <input type="password" id="guest-password" name="password" required minlength="6"
                style="width: 100%; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 1rem; padding: 0.875rem 1.25rem; font-weight: 600; font-size: 0.875rem; transition: all 0.2s;"
                onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'"
                onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'"
                placeholder="Минимум 6 символов">
            </div>
            
            <div style="margin-bottom: 1.25rem;">
              <label style="display: block; font-size: 0.5625rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.15em; color: #94a3b8; margin-bottom: 0.5rem; padding-left: 0.25rem;">
                Имя <span style="font-weight: 500; color: #cbd5e1;">(необязательно)</span>
              </label>
              <input type="text" id="guest-name" name="name"
                style="width: 100%; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 1rem; padding: 0.875rem 1.25rem; font-weight: 600; font-size: 0.875rem; transition: all 0.2s;"
                onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'"
                onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'"
                placeholder="Иван Иванов">
            </div>
            
            <div style="margin-bottom: 1.5rem;">
              <label style="display: flex; align-items: flex-start; gap: 0.75rem; cursor: pointer;">
                <input type="checkbox" id="guest-terms" required
                  style="width: 1.25rem; height: 1.25rem; border-radius: 0.375rem; border: 2px solid #cbd5e1; margin-top: 2px; flex-shrink: 0; accent-color: #3b82f6;">
                <span style="font-size: 0.75rem; color: #64748b; line-height: 1.5;">
                  Принимаю <a href="/privacy/" target="_blank" style="color: #3b82f6; text-decoration: none;">политику конфиденциальности</a> и <a href="/agreement/" target="_blank" style="color: #3b82f6; text-decoration: none;">условия использования</a>
                </span>
              </label>
            </div>
            
            <button type="submit" id="guest-reg-submit-btn"
              style="width: 100%; padding: 1rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 1.25rem; font-weight: 800; font-size: 0.8125rem; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; transition: all 0.3s;"
              onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 25px -5px rgba(59,130,246,0.4)'"
              onmouseout="this.style.transform='none'; this.style.boxShadow='none'">
              Зарегистрироваться
            </button>
          </form>
          
          <!-- Login link -->
          <p style="text-align: center; margin: 1.25rem 0 0; font-size: 0.875rem; color: #64748b;">
            Уже есть аккаунт? <a href="/login/" style="color: #3b82f6; font-weight: 600; text-decoration: none;">Войти</a>
          </p>
          
        </div>
      </div>
    </div>
  </div>
</div>

<!-- jQuery library js -->
<script src="/static/js/lib/jquery-3.7.1.min.js"></script>
<!-- Bootstrap js -->
<script src="/static/js/lib/bootstrap.bundle.min.js"></script>
<!-- Iconify Font js -->
<script src="/static/js/lib/iconify-icon.min.js"></script>
<!-- Date picker js -->
<script src="/static/js/flatpickr.js"></script>
<!-- jQuery UI js -->
<script src="/static/js/lib/jquery-ui.min.js"></script>
<!-- main js -->
<script src="/static/js/app.js?v=2.1"></script>

<!-- Pass Jinja2 variables to JavaScript -->
<script>
    window.INVOICE_CONFIG = {
        editDocumentId: '{{ edit_document_id | default("") }}',
        apiUrl: '/api/v1',
        documentType: 'invoice'
    };
</script>

<!-- Invoice Constructor Main JS -->
<script src="/static/js/invoice-constructor/invoice-main.js?v=2.1"></script>

</body>
</html>
