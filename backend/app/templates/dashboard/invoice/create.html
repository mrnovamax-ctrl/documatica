<!DOCTYPE html>
<html lang="ru" data-theme="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Создать счёт на оплату - Documatica</title>
  <link rel="icon" type="image/png" href="/static/images/favicon.png" sizes="16x16">
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <!-- remix icon font css -->
  <link rel="stylesheet" href="/static/css/remixicon.css">
  <!-- Iconify for v12 icons -->
  <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
  <!-- BootStrap css -->
  <link rel="stylesheet" href="/static/css/lib/bootstrap.min.css">
  <!-- Date picker css -->
  <link rel="stylesheet" href="/static/css/lib/flatpickr.min.css">
  <!-- html2canvas for preview -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- Documatica v12.0 Design System (ONLY v12, no old styles) -->
  <link rel="stylesheet" href="/static/css/documatica.css?v=12.11">
  <style>
    /* Constructor page styles */
    body.constructor-page-v12 {
      background-color: #f8fafc !important;
      background-image: radial-gradient(circle, #3b82f6 1px, transparent 1px) !important;
      background-size: 32px 32px !important;
      background-attachment: fixed !important;
      margin: 0 !important;
      padding: 0 !important;
      min-height: 100vh !important;
    }
    
    /* Sidebar fixed on left */
    body.constructor-page-v12 aside.sidebar-v12 {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 320px !important;
      height: 100vh !important;
      z-index: 50 !important;
      overflow-y: auto !important;
    }
    
    /* Main content with left margin */
    body.constructor-page-v12 .dashboard-main-v12 {
      margin-left: 320px !important;
      min-height: 100vh !important;
      padding-top: 0 !important;
      margin-top: 0 !important;
      position: relative !important;
    }
    
    /* Header at top of main */
    body.constructor-page-v12 .dashboard-header-v12 {
      margin-top: 0 !important;
      padding-top: 0 !important;
    }
    
    /* Animated action buttons */
    #save-supplier-btn,
    #save-client-btn {
      opacity: 0;
      visibility: hidden;
    }
    #save-supplier-btn.show,
    #save-client-btn.show {
      opacity: 1 !important;
      visibility: visible !important;
      transform: translateX(0) !important;
    }
    #save-supplier-btn:hover,
    #save-client-btn:hover {
      padding: 0 16px !important;
      box-shadow: 0 4px 16px rgba(251, 191, 36, 0.5) !important;
    }
    #save-supplier-btn:hover span,
    #save-client-btn:hover span {
      opacity: 1 !important;
      width: auto !important;
    }
    #save-supplier-btn:hover svg,
    #save-client-btn:hover svg {
      transform: rotate(90deg) !important;
    }
    #save-supplier-btn:active,
    #save-client-btn:active {
      transform: translateX(0) scale(0.95) !important;
    }
    
    .card.radius-16, .card {
      background: white !important;
      border: 1px solid #e2e8f0 !important;
      border-radius: 2rem !important;
      overflow: hidden !important;
      box-shadow: 0 4px 20px rgba(15, 23, 42, 0.04) !important;
      margin-bottom: 24px !important;
    }
    .card-header {
      background: transparent !important;
      border-bottom: 1px solid #f1f5f9 !important;
    }
    .card-header h6 {
      font-size: 10px !important;
      font-weight: 900 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.4em !important;
      color: #3b82f6 !important;
    }
    .form-control {
      background: #f8fafc !important;
      border: 1px solid #e2e8f0 !important;
      border-radius: 1rem !important;
      padding: 14px 18px !important;
      font-size: 14px !important;
      font-weight: 600 !important;
      color: #0f172a !important;
      transition: all 0.2s ease !important;
    }
    .form-control:focus {
      background: white !important;
      border-color: #3b82f6 !important;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1) !important;
    }
    .form-label {
      font-size: 9px !important;
      font-weight: 900 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.3em !important;
      color: #94a3b8 !important;
    }
    
    @media (max-width: 1023px) {
      body.constructor-page-v12 aside.sidebar-v12 {
        position: fixed !important;
        transform: translateX(-100%) !important;
        z-index: 1000 !important;
        height: 100vh !important;
      }
      body.constructor-page-v12.sidebar-open aside.sidebar-v12 {
        transform: translateX(0) !important;
      }
      body.constructor-page-v12 .dashboard-main-v12 {
        margin-left: 0 !important;
      }
    }
  </style>
</head>

<body class="constructor-page-v12">

<!-- Sidebar v12 -->
{% include 'components/sidebar_v12.html' %}

<!-- Sidebar Overlay for mobile -->
<div class="sidebar-overlay-v12" onclick="document.body.classList.remove('sidebar-open')"></div>

<main class="dashboard-main-v12">
  <!-- Header v12 -->
  {% include 'components/header_dashboard_v12.html' %}

  <div class="dashboard-content-v12">
    <!-- Page Title -->
    <div class="page-title-v12">
      <h1>Создать счёт на оплату</h1>
      <p>Заполните данные для формирования счёта</p>
    </div>

    <form id="invoice-form">
      <div class="row gy-4">
        <!-- Left Column - Form -->
        <div class="col-xxl-7 col-xl-6">
          
          <!-- Document Info -->
          <div class="card radius-16 mb-24">
            <div class="card-header py-16 px-24 border-bottom">
              <h4 class="mb-0">Реквизиты документа</h4>
            </div>
            <div class="card-body p-24">
              <div class="row g-16">
                <div class="col-md-6">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Номер счёта <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="invoice_number" placeholder="Например: 124" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Дата счёта <span class="text-danger">*</span></label>
                  <input type="text" class="form-control date-picker" id="invoice_date" placeholder="Выберите дату" required>
                </div>
                <div class="col-12">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Основание (договор, счёт)</label>
                  <input type="text" class="form-control" id="contract_info" placeholder="Например: Договор №34 от 30.08.2025">
                </div>
              </div>
            </div>
          </div>

          <!-- Supplier Info -->
          <div class="card radius-16 mb-24">
            <div class="card-header py-16 px-24 border-bottom d-flex align-items-center justify-content-between">
              <h4 class="mb-0">Поставщик</h4>
              <button type="button" class="btn btn-sm btn-outline-primary-600" data-bs-toggle="modal" data-bs-target="#selectOrganizationModal">
                Выбрать из списка
              </button>
            </div>
            <div class="card-body p-24">
              <div class="row g-16">
                <div class="col-md-6">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Наименование <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="supplier_name" placeholder='ООО "Компания"' required>
                </div>
                <div class="col-md-3">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">ИНН <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="supplier_inn" placeholder="7707123456" required maxlength="12">
                </div>
                <div class="col-md-3">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">КПП</label>
                  <input type="text" class="form-control" id="supplier_kpp" placeholder="770701001" maxlength="9">
                </div>
                <div class="col-12" style="position: relative;">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Адрес <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="supplier_address" placeholder="123456, г. Москва, ул. Примерная, д. 1" required style="padding-right: 50px;">
                  <!-- Кнопка добавить в организации внутри поля -->
                  <button type="button" id="save-supplier-btn" title="Добавить в мои организации" style="position: absolute; right: 12px; bottom: 10px; background: #FBBF24; color: #0f172a; border: none; border-radius: 0.75rem; height: 36px; min-width: 36px; padding: 0 12px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s, visibility 0.3s; cursor: pointer; box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3); z-index: 10; transform: translateX(calc(100% + 24px)); white-space: nowrap; font-weight: 900; font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" style="flex-shrink: 0; transition: transform 0.3s;">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span style="opacity: 0; width: 0; overflow: hidden; transition: opacity 0.3s, width 0.3s;">Добавить в мои организации</span>
                  </button>
                </div>
              </div>
              
              <!-- Bank Details -->
              <div class="mt-24 pt-16 border-top">
                <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Банковские реквизиты</label>
                <div class="row g-16">
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Банк <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="supplier_bank_name" placeholder="ПАО Сбербанк" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">БИК <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="supplier_bank_bik" placeholder="044525225" required maxlength="9">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Расчётный счёт <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="supplier_bank_account" placeholder="40702810000000000001" required maxlength="20">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Корр. счёт</label>
                    <input type="text" class="form-control" id="supplier_bank_corr" placeholder="30101810400000000225" maxlength="20">
                  </div>
                </div>
              </div>
              
              <!-- Signatures -->
              <div class="mt-24 pt-16 border-top">
                <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Подписанты</label>
                <div class="row g-16">
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Руководитель</label>
                    <input type="text" class="form-control" id="supplier_director" placeholder="Иванов И.И.">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Главный бухгалтер</label>
                    <input type="text" class="form-control" id="supplier_accountant" placeholder="Петрова П.П.">
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Client Info -->
          <div class="card radius-16 mb-24">
            <div class="card-header py-16 px-24 border-bottom d-flex align-items-center justify-content-between">
              <h4 class="mb-0">Покупатель (Плательщик)</h4>
              <button type="button" class="btn btn-sm btn-outline-primary-600" data-bs-toggle="modal" data-bs-target="#selectContractorModal">
                Выбрать из списка
              </button>
            </div>
            <div class="card-body p-24">
              <div class="row g-16">
                <div class="col-md-6">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Наименование <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="client_name" placeholder='ООО "Контрагент"' required>
                </div>
                <div class="col-md-3">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">ИНН <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="client_inn" placeholder="7707654321" required maxlength="12">
                </div>
                <div class="col-md-3">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">КПП</label>
                  <input type="text" class="form-control" id="client_kpp" placeholder="770701001" maxlength="9">
                </div>
                <div class="col-12" style="position: relative;">
                  <label class="form-label fw-bold text-xs text-slate-600 text-uppercase" style="letter-spacing: 0.05em; margin-top: 16px; margin-bottom: 8px;">Адрес</label>
                  <input type="text" class="form-control" id="client_address" placeholder="Адрес покупателя" style="padding-right: 50px;">
                  <!-- Кнопка добавить в клиенты внутри поля -->
                  <button type="button" id="save-client-btn" title="Добавить в мои контрагенты" style="position: absolute; right: 12px; bottom: 10px; background: #FBBF24; color: #0f172a; border: none; border-radius: 0.75rem; height: 36px; min-width: 36px; padding: 0 12px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s, visibility 0.3s; cursor: pointer; box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3); z-index: 10; transform: translateX(calc(100% + 24px)); white-space: nowrap; font-weight: 900; font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" style="flex-shrink: 0; transition: transform 0.3s;">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span style="opacity: 0; width: 0; overflow: hidden; transition: opacity 0.3s, width 0.3s;">Добавить в мои контрагенты</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Products/Services -->
          <div class="card radius-16 mb-24">
            <div class="card-header py-16 px-24 border-bottom">
              <h4 class="mb-0">Товары и услуги</h4>
            </div>
            <div class="card-body p-24">
              <!-- Products Header -->
              <div class="invoice-products-header-v12">
                <span>Наименование</span>
                <span>Кол-во</span>
                <span>Ед.</span>
                <span>Цена</span>
                <span>Сумма</span>
                <span></span>
              </div>
              
              <!-- Products Container -->
              <div id="products-container">
                <!-- Products will be added here dynamically -->
              </div>
              
              <!-- Add Product Button -->
              <button type="button" class="invoice-add-btn-v12" id="add-product-btn">
                <iconify-icon icon="mdi:plus" width="18"></iconify-icon>
                Добавить товар или услугу
              </button>
              
              <!-- Totals -->
              <div class="invoice-totals-v12">
                <div class="invoice-totals-row-v12">
                  <span>Сумма без НДС:</span>
                  <span id="total-without-vat">0.00 руб.</span>
                </div>
                <div class="invoice-totals-row-v12">
                  <span>
                    НДС 
                    <select id="vat-rate" class="invoice-vat-select-v12">
                      <option value="20">20%</option>
                      <option value="10">10%</option>
                      <option value="5">5%</option>
                      <option value="0">Без НДС</option>
                    </select>:
                  </span>
                  <span id="total-vat">0.00 руб.</span>
                </div>
                <div class="invoice-totals-row-v12 total">
                  <span>Итого к оплате:</span>
                  <span id="total-with-vat">0.00 руб.</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="d-flex flex-wrap gap-16 mb-24">
            <button type="submit" class="constructor-btn-primary-v12" id="generate-btn">
              <iconify-icon icon="mdi:file-document-check" width="20"></iconify-icon>
              Сформировать счёт
            </button>
            <button type="button" class="constructor-btn-secondary-v12" id="preview-btn">
              <iconify-icon icon="mdi:eye" width="20"></iconify-icon>
              Предпросмотр
            </button>
          </div>

        </div>

        <!-- Right Column - Preview -->
        <div class="col-xxl-5 col-xl-6 d-none d-xl-block">
          <div class="sticky-preview">
            <div class="card radius-16">
              <div class="card-header py-16 px-24 border-bottom d-flex align-items-center justify-content-between">
                <h4 class="mb-0">Предпросмотр счёта</h4>
                <div class="d-flex" style="gap: 8px;">
                  <button type="button" class="btn btn-sm btn-outline-primary-600" id="refresh-preview">
                    Обновить
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-primary-600" data-bs-toggle="modal" data-bs-target="#previewModal">
                    Предпросмотр
                  </button>
                </div>
              </div>
              <div class="card-body p-0 bg-white d-flex align-items-start justify-content-center position-relative" style="overflow: auto; background: #f8fafc;">
                <canvas id="sidebar-preview-canvas" style="width: 100%; height: auto;"></canvas>
                <!-- Лупа -->
                <div id="canvas-magnifier" style="display: none; position: absolute; width: 400px; height: 300px; border: 3px solid #3b82f6; border-radius: 12px; pointer-events: none; z-index: 1000; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3); background: white;">
                  <canvas id="magnifier-canvas" width="1200" height="900" style="width: 100%; height: 100%; display: block;"></canvas>
                </div>
              </div>
            </div>
            
            <!-- AI Analysis Block -->
            <div class="card radius-16 mt-24">
              <div class="card-header py-16 px-24 d-flex align-items-center justify-content-between" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);">
                <div class="d-flex align-items-center" style="gap: 24px;">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2">
                    <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/>
                    <circle cx="7.5" cy="14.5" r="1.5"/>
                    <circle cx="16.5" cy="14.5" r="1.5"/>
                  </svg>
                  <span class="fw-bold text-uppercase" style="font-size: 18px; letter-spacing: 0.3em; color: #fbbf24; font-weight: 900;">ИИ Анализ документа</span>
                </div>
                <div class="d-flex align-items-center gap-8">
                  <button type="button" class="btn btn-sm d-none align-items-center gap-8" id="clear-highlights-btn" style="background: transparent; color: #94a3b8; border: 1px solid #475569; font-weight: 600; font-size: 10px; text-transform: uppercase;">
                    Сбросить подсветку
                  </button>
                  <button type="button" class="btn btn-sm d-flex align-items-center gap-8" id="ai-analyze-btn" style="background: #fbbf24; color: #0f172a; font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="11" cy="11" r="8"/>
                      <path d="m21 21-4.3-4.3"/>
                    </svg>
                    Анализировать
                  </button>
                </div>
              </div>
              <div class="card-body" id="ai-analysis-result" style="min-height: 100px;">
                <div class="text-center py-24 text-secondary-light">
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mb-12 mx-auto d-block" style="opacity: 0.5;">
                    <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 1 1 7.072 0l-.548.547A3.374 3.374 0 0 0 11 18.469V19a2 2 0 1 1-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                  </svg>
                  <p class="mb-4 fw-semibold text-secondary-light">Нажмите "Анализировать" для проверки документа</p>
                  <small class="text-secondary-light">ИИ проверит документ на ошибки с точки зрения бухгалтера и юриста</small>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </form>
  </div>

  <!-- Footer -->
  {% include 'components/footer.html' %}
</main>

<!-- Select Organization Modal -->
<div class="modal fade modal-v12" id="selectOrganizationModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Выберите организацию</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="organizations-list">
        <div class="text-center py-4 text-secondary-light">Загрузка...</div>
      </div>
    </div>
  </div>
</div>

<!-- Select Contractor Modal -->
<div class="modal fade modal-v12" id="selectContractorModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Выберите контрагента</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="contractors-list">
        <div class="text-center py-4 text-secondary-light">Загрузка...</div>
      </div>
    </div>
  </div>
</div>

<!-- Preview Modal -->
<div class="modal fade modal-v12" id="previewModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Предпросмотр счёта</h5>
        <div class="d-flex gap-12 align-items-center">
          <button type="button" class="constructor-btn-primary-v12" id="modal-download-pdf" style="padding: 12px 20px;">
            Скачать PDF
          </button>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
      </div>
      <div class="modal-body p-0">
        <iframe id="modal-preview-iframe" style="width: 100%; height: 700px; border: none;"></iframe>
      </div>
    </div>
  </div>
</div>

<!-- jQuery -->
<script src="/static/js/lib/jquery-3.7.1.min.js"></script>
<!-- Bootstrap Bundle JS -->
<script src="/static/js/lib/bootstrap.bundle.min.js"></script>
<!-- Flatpickr -->
<script src="/static/js/flatpickr.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const token = localStorage.getItem('access_token') || getCookie('access_token');
  
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }
  
  // Initialize date picker
  flatpickr('.date-picker', {
    dateFormat: 'd.m.Y',
    defaultDate: new Date(),
    onChange: function() {
      debouncedPreview();
    }
  });
  
  // ========== Action Buttons Management ==========
  // Show "Add to organizations" button on manual supplier input
  $('#supplier_name, #supplier_inn').on('input', function() {
    const name = $('#supplier_name').val().trim();
    const inn = $('#supplier_inn').val().trim();
    if (name && inn && inn.length >= 10) {
      $('#save-supplier-btn').addClass('show');
    } else {
      $('#save-supplier-btn').removeClass('show');
    }
  });
  
  // Show "Add to clients" button on manual client input
  $('#client_name, #client_inn').on('input', function() {
    const name = $('#client_name').val().trim();
    const inn = $('#client_inn').val().trim();
    if (name && inn && inn.length >= 10) {
      $('#save-client-btn').addClass('show');
    } else {
      $('#save-client-btn').removeClass('show');
    }
  });
  
  // Save supplier to organizations
  $('#save-supplier-btn').on('click', async function() {
    const data = {
      org_type: $('#supplier_inn').val().length === 12 ? 'ip' : 'ooo',
      name: $('#supplier_name').val(),
      inn: $('#supplier_inn').val(),
      kpp: $('#supplier_kpp').val() || null,
      address: $('#supplier_address').val()
    };
    
    try {
      const response = await fetch('/api/v1/organizations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (!response.ok) throw new Error('API error');
    } catch (error) {
      // Fallback to localStorage
      const orgs = JSON.parse(localStorage.getItem('organizations') || '[]');
      data.id = 'org_' + Date.now();
      orgs.push(data);
      localStorage.setItem('organizations', JSON.stringify(orgs));
    }
    
    const toast = $('<div class=\"position-fixed top-0 end-0 m-24 p-16 bg-success-100 text-success-main shadow-lg\" style=\"z-index: 9999;\"><div class=\"d-flex align-items-center gap-8\"><iconify-icon icon=\"mdi:check-circle\" class=\"text-xl\"></iconify-icon><span>Организация добавлена!</span></div></div>');
    $('body').append(toast);
    setTimeout(() => toast.fadeOut(300, function() { $(this).remove(); }), 2000);
    $('#save-supplier-btn').removeClass('show');
  });
  
  // Save client to contractors
  $('#save-client-btn').on('click', async function() {
    const data = {
      org_type: $('#client_inn').val().length === 12 ? 'ip' : 'ooo',
      name: $('#client_name').val(),
      inn: $('#client_inn').val(),
      kpp: $('#client_kpp').val() || null,
      address: $('#client_address').val()
    };
    
    try {
      const response = await fetch('/api/v1/contractors', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (!response.ok) throw new Error('API error');
    } catch (error) {
      // Fallback to localStorage
      const contractors = JSON.parse(localStorage.getItem('contractors') || '[]');
      data.id = 'contractor_' + Date.now();
      contractors.push(data);
      localStorage.setItem('contractors', JSON.stringify(contractors));
    }
    
    const toast = $('<div class=\"position-fixed top-0 end-0 m-24 p-16 bg-success-100 text-success-main shadow-lg\" style=\"z-index: 9999;\"><div class=\"d-flex align-items-center gap-8\"><iconify-icon icon=\"mdi:check-circle\" class=\"text-xl\"></iconify-icon><span>Контрагент добавлен!</span></div></div>');
    $('body').append(toast);
    setTimeout(() => toast.fadeOut(300, function() { $(this).remove(); }), 2000);
    $('#save-client-btn').removeClass('show');
  });
  
  // Debounced preview function with optimization
  let previewTimeout = null;
  let isPreviewUpdating = false;
  
  function debouncedPreview() {
    if (previewTimeout) {
      clearTimeout(previewTimeout);
    }
    previewTimeout = setTimeout(loadPreview, 1500); // Increased from 500ms to 1.5s
  }
  
  // ========== Products Management ==========
  let products = [];
  let productIdCounter = 1;
  
  function addProduct(data = {}) {
    const id = productIdCounter++;
    products.push({
      id: id,
      name: data.name || '',
      quantity: data.quantity || 1,
      unit: data.unit || 'шт',
      price: data.price || 0
    });
    renderProducts();
  }
  
  function removeProduct(id) {
    products = products.filter(p => p.id !== id);
    renderProducts();
    debouncedPreview();
  }
  
  function updateProduct(id, field, value) {
    const product = products.find(p => p.id === id);
    if (product) {
      product[field] = value;
      if (field === 'quantity' || field === 'price') {
        updateTotals();
        // Update amount display
        const row = document.querySelector(`[data-product-id="${id}"]`);
        if (row) {
          const amount = (parseFloat(product.quantity) || 0) * (parseFloat(product.price) || 0);
          row.querySelector('.product-amount').textContent = amount.toFixed(2);
        }
      }
      debouncedPreview();
    }
  }
  
  function renderProducts() {
    const container = document.getElementById('products-container');
    container.innerHTML = '';
    
    products.forEach(product => {
      const amount = (parseFloat(product.quantity) || 0) * (parseFloat(product.price) || 0);
      const row = document.createElement('div');
      row.className = 'invoice-product-row-v12';
      row.setAttribute('data-product-id', product.id);
      row.innerHTML = `
        <div>
          <input type="text" class="form-control" placeholder="Наименование товара/услуги" 
                 value="${product.name}" onchange="window.updateProduct(${product.id}, 'name', this.value)">
        </div>
        <div>
          <input type="number" class="form-control text-center" value="${product.quantity}" min="1" step="1"
                 onchange="window.updateProduct(${product.id}, 'quantity', this.value)" 
                 oninput="window.updateProduct(${product.id}, 'quantity', this.value)">
        </div>
        <div>
          <input type="text" class="form-control text-center" value="${product.unit}" 
                 onchange="window.updateProduct(${product.id}, 'unit', this.value)">
        </div>
        <div>
          <input type="number" class="form-control text-right" value="${product.price}" min="0" step="0.01"
                 onchange="window.updateProduct(${product.id}, 'price', this.value)" 
                 oninput="window.updateProduct(${product.id}, 'price', this.value)">
        </div>
        <div class="product-amount">${amount.toFixed(2)}</div>
        <div>
          <button type="button" class="invoice-remove-btn-v12" onclick="window.removeProduct(${product.id})">
            <iconify-icon icon="mdi:close" width="18"></iconify-icon>
          </button>
        </div>
      `;
      container.appendChild(row);
    });
    
    updateTotals();
  }
  
  function updateTotals() {
    const vatRate = parseInt(document.getElementById('vat-rate').value) || 0;
    let totalWithoutVat = 0;
    
    products.forEach(product => {
      const amount = (parseFloat(product.quantity) || 0) * (parseFloat(product.price) || 0);
      totalWithoutVat += amount;
    });
    
    const vatAmount = vatRate > 0 ? totalWithoutVat * vatRate / 100 : 0;
    const totalWithVat = totalWithoutVat + vatAmount;
    
    document.getElementById('total-without-vat').textContent = totalWithoutVat.toFixed(2) + ' руб.';
    document.getElementById('total-vat').textContent = vatAmount.toFixed(2) + ' руб.';
    document.getElementById('total-with-vat').textContent = totalWithVat.toFixed(2) + ' руб.';
  }
  
  // Make functions global
  window.updateProduct = updateProduct;
  window.removeProduct = removeProduct;
  
  // Add product button
  document.getElementById('add-product-btn').addEventListener('click', () => {
    addProduct();
    debouncedPreview();
  });
  
  // VAT rate change
  document.getElementById('vat-rate').addEventListener('change', () => {
    updateTotals();
    debouncedPreview();
  });
  
  // Add initial empty product
  addProduct();
  
  // Auto-update preview when form fields change
  document.querySelectorAll('#invoice-form input:not([type="number"]), #invoice-form select').forEach(input => {
    input.addEventListener('change', debouncedPreview);
    input.addEventListener('input', debouncedPreview);
  });
  
  // ========== Organization Selection ==========
  document.getElementById('selectOrganizationModal').addEventListener('show.bs.modal', async () => {
    try {
      const response = await fetch('/api/v1/organizations', {
        headers: token ? { 'Authorization': 'Bearer ' + token } : {},
        credentials: 'include'
      });
      
      if (response.ok) {
        const organizations = await response.json();
        const container = document.getElementById('organizations-list');
        
        if (organizations.length === 0) {
          container.innerHTML = '<div class="text-center py-4 text-secondary-light">Нет сохранённых организаций</div>';
        } else {
          container.innerHTML = organizations.map(org => `
            <div class="constructor-entity-card-v12 mb-12" data-org='${JSON.stringify(org).replace(/'/g, "&#39;")}'>
              <div class="entity-name">${org.name}</div>
              <div class="entity-info">ИНН: ${org.inn}${org.kpp ? ', КПП: ' + org.kpp : ''}</div>
              <div class="entity-info mt-1">${org.address || ''}</div>
            </div>
          `).join('');
          
          container.querySelectorAll('.constructor-entity-card-v12').forEach(item => {
            item.addEventListener('click', () => {
              const org = JSON.parse(item.dataset.org.replace(/&#39;/g, "'"));
              document.getElementById('supplier_name').value = org.name || '';
              document.getElementById('supplier_inn').value = org.inn || '';
              document.getElementById('supplier_kpp').value = org.kpp || '';
              document.getElementById('supplier_address').value = org.address || '';
              document.getElementById('supplier_bank_name').value = org.bank_name || '';
              document.getElementById('supplier_bank_bik').value = org.bank_bik || '';
              document.getElementById('supplier_bank_account').value = org.bank_account || '';
              document.getElementById('supplier_bank_corr').value = org.bank_corr_account || '';
              document.getElementById('supplier_director').value = org.director_name || '';
              document.getElementById('supplier_accountant').value = org.accountant_name || '';
              bootstrap.Modal.getInstance(document.getElementById('selectOrganizationModal')).hide();
              debouncedPreview();
            });
          });
        }
      }
    } catch (error) {
      console.error('Error loading organizations:', error);
    }
  });
  
  // ========== Contractor Selection ==========
  document.getElementById('selectContractorModal').addEventListener('show.bs.modal', async () => {
    try {
      const response = await fetch('/api/v1/contractors', {
        headers: token ? { 'Authorization': 'Bearer ' + token } : {},
        credentials: 'include'
      });
      
      if (response.ok) {
        const contractors = await response.json();
        const container = document.getElementById('contractors-list');
        
        if (!contractors || contractors.length === 0) {
          container.innerHTML = '<div class="text-center py-4 text-secondary-light">Нет сохранённых контрагентов</div>';
        } else {
          container.innerHTML = contractors.map(c => `
            <div class="constructor-entity-card-v12 mb-12" data-contractor='${JSON.stringify(c).replace(/'/g, "&#39;")}'>
              <div class="entity-name">${c.name}</div>
              <div class="entity-info">ИНН: ${c.inn}${c.kpp ? ', КПП: ' + c.kpp : ''}</div>
              <div class="entity-info mt-1">${c.address || ''}</div>
            </div>
          `).join('');
          
          container.querySelectorAll('.constructor-entity-card-v12').forEach(item => {
            item.addEventListener('click', () => {
              const c = JSON.parse(item.dataset.contractor.replace(/&#39;/g, "'"));
              document.getElementById('client_name').value = c.name || '';
              document.getElementById('client_inn').value = c.inn || '';
              document.getElementById('client_kpp').value = c.kpp || '';
              document.getElementById('client_address').value = c.address || '';
              bootstrap.Modal.getInstance(document.getElementById('selectContractorModal')).hide();
              debouncedPreview();
            });
          });
        }
      }
    } catch (error) {
      console.error('Error loading contractors:', error);
    }
  });
  
  // ========== Form Collection ==========
  function collectFormData() {
    const vatRate = parseInt(document.getElementById('vat-rate').value) || 0;
    let totalWithoutVat = 0;
    
    const items = products.map(p => {
      const amount = (parseFloat(p.quantity) || 0) * (parseFloat(p.price) || 0);
      totalWithoutVat += amount;
      return {
        name: p.name,
        quantity: parseFloat(p.quantity) || 1,
        unit_name: p.unit,
        price: parseFloat(p.price) || 0,
        amount: amount
      };
    });
    
    const vatAmount = vatRate > 0 ? totalWithoutVat * vatRate / 100 : 0;
    const totalWithVat = totalWithoutVat + vatAmount;
    
    return {
      invoice_number: document.getElementById('invoice_number').value,
      invoice_date: document.getElementById('invoice_date').value,
      contract_info: document.getElementById('contract_info').value,
      supplier: {
        name: document.getElementById('supplier_name').value,
        inn: document.getElementById('supplier_inn').value,
        kpp: document.getElementById('supplier_kpp').value,
        address: document.getElementById('supplier_address').value,
        bank_name: document.getElementById('supplier_bank_name').value,
        bank_bik: document.getElementById('supplier_bank_bik').value,
        bank_account: document.getElementById('supplier_bank_account').value,
        bank_corr_account: document.getElementById('supplier_bank_corr').value,
        director_name: document.getElementById('supplier_director').value,
        accountant_name: document.getElementById('supplier_accountant').value
      },
      client: {
        name: document.getElementById('client_name').value,
        inn: document.getElementById('client_inn').value,
        kpp: document.getElementById('client_kpp').value,
        address: document.getElementById('client_address').value
      },
      items: items,
      vat_rate: vatRate > 0 ? vatRate + '%' : 'Без НДС',
      vat_amount: vatAmount,
      total_without_vat: totalWithoutVat,
      total_with_vat: totalWithVat
    };
  }
  
  // ========== Preview ==========
  async function loadPreview() {
    // Prevent concurrent preview updates
    if (isPreviewUpdating) {
      return;
    }
    
    const canvas = document.getElementById('sidebar-preview-canvas');
    if (!canvas) return;
    
    isPreviewUpdating = true;
    const formData = collectFormData();
    
    try {
      const response = await fetch('/api/v1/documents/invoice/preview', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(token ? { 'Authorization': 'Bearer ' + token } : {})
        },
        credentials: 'include',
        body: JSON.stringify(formData)
      });
      
      if (response.ok) {
        const html = await response.text();
        
        // Создаём временный контейнер для рендеринга
        const tempDiv = document.createElement('div');
        tempDiv.style.position = 'absolute';
        tempDiv.style.left = '-9999px';
        tempDiv.style.width = '1200px';
        tempDiv.innerHTML = html;
        document.body.appendChild(tempDiv);
        
        // Уменьшили задержку с 500мс до 100мс
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Рендерим в canvas с пониженным scale для ускорения
        const renderedCanvas = await html2canvas(tempDiv, {
          scale: 3, // Было 4, стало 3 для ускорения
          useCORS: true,
          logging: false,
          backgroundColor: '#ffffff'
        });
        
        // Удаляем временный контейнер
        document.body.removeChild(tempDiv);
        
        // Устанавливаем canvas в полное разрешение (без даунскейла)
        canvas.width = renderedCanvas.width;
        canvas.height = renderedCanvas.height;
        
        // Копируем изображение в полном разрешении
        const ctx = canvas.getContext('2d');
        ctx.drawImage(renderedCanvas, 0, 0);
        
        // Через CSS масштабируем только отображение
        canvas.style.width = '100%';
        canvas.style.height = 'auto';
        canvas.style.display = 'block';
      }
    } catch (error) {
      console.error('Preview error:', error);
    } finally {
      isPreviewUpdating = false;
    }
  }
  
  document.getElementById('refresh-preview').addEventListener('click', loadPreview);
  
  document.getElementById('preview-btn').addEventListener('click', async () => {
    const formData = collectFormData();
    
    try {
      const response = await fetch('/api/v1/documents/invoice/preview', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(token ? { 'Authorization': 'Bearer ' + token } : {})
        },
        credentials: 'include',
        body: JSON.stringify(formData)
      });
      
      if (response.ok) {
        const html = await response.text();
        document.getElementById('modal-preview-iframe').srcdoc = html;
        new bootstrap.Modal(document.getElementById('previewModal')).show();
      }
    } catch (error) {
      console.error('Preview error:', error);
    }
  });
  
  // ========== Form Submit ==========
  document.getElementById('invoice-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = collectFormData();
    const btn = document.getElementById('generate-btn');
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Формирование...';
    
    try {
      const response = await fetch('/api/v1/documents/invoice/generate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(token ? { 'Authorization': 'Bearer ' + token } : {})
        },
        credentials: 'include',
        body: JSON.stringify(formData)
      });
      
      if (response.ok) {
        const result = await response.json();
        if (result.document_id) {
          window.location.href = '/dashboard/invoice/' + result.document_id + '/';
        } else if (result.pdf_url) {
          window.open(result.pdf_url, '_blank');
        }
      } else {
        const error = await response.json();
        alert('Ошибка: ' + (error.detail || 'Не удалось сформировать счёт'));
      }
    } catch (error) {
      console.error('Generate error:', error);
      alert('Ошибка при формировании счёта');
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalHTML;
    }
  });
  
  // Load initial preview with reduced delay
  setTimeout(loadPreview, 100);
  
  // ============== CANVAS MAGNIFIER (лупа) ==============
  const magnifierEl = document.getElementById('canvas-magnifier');
  const magnifierCanvas = document.getElementById('magnifier-canvas');
  const previewCanvas = document.getElementById('sidebar-preview-canvas');
  const container = previewCanvas ? previewCanvas.parentElement : null;
  
  if (container && previewCanvas && magnifierCanvas) {
    const displayWidth = 400; // Визуальный размер лупы
    const displayHeight = 300;
    const canvasWidth = 1200; // Физическое разрешение canvas
    const canvasHeight = 900;
    const magnification = 1.1; // Увеличение в 1.1 раза
    const magnifierCtx = magnifierCanvas.getContext('2d');
    
    container.addEventListener('mouseenter', function() {
      if (previewCanvas.width > 0) { // Проверяем что canvas отрендерен
        magnifierEl.style.display = 'block';
      }
    });
    
    container.addEventListener('mouseleave', function() {
      magnifierEl.style.display = 'none';
    });
    
    container.addEventListener('mousemove', function(e) {
      if (previewCanvas.width === 0) return;
      
      const containerRect = container.getBoundingClientRect();
      const mouseX = e.clientX - containerRect.left;
      const mouseY = e.clientY - containerRect.top;
      
      // Позиционируем лупу (центр в курсоре) - используем визуальные размеры
      let left = mouseX - displayWidth / 2;
      let top = mouseY - displayHeight / 2;
      
      // Ограничиваем лупу границами контейнера
      const containerWidth = containerRect.width;
      const containerHeight = containerRect.height;
      
      if (left < 0) left = 0;
      if (top < 0) top = 0;
      if (left + displayWidth > containerWidth) left = containerWidth - displayWidth;
      if (top + displayHeight > containerHeight) top = containerHeight - displayHeight;
      
      magnifierEl.style.left = left + 'px';
      magnifierEl.style.top = top + 'px';
      
      // Вычисляем координаты на canvas с учётом масштабирования
      const canvasRect = previewCanvas.getBoundingClientRect();
      
      // Относительные координаты мыши на canvas
      const canvasMouseX = (mouseX - (canvasRect.left - containerRect.left)) * (previewCanvas.width / canvasRect.width);
      const canvasMouseY = (mouseY - (canvasRect.top - containerRect.top)) * (previewCanvas.height / canvasRect.height);
      
      // Размер области которую захватываем (в пикселях оригинального canvas)
      const sourceWidth = displayWidth / magnification;
      const sourceHeight = displayHeight / magnification;
      
      // Очищаем magnifier canvas
      magnifierCtx.clearRect(0, 0, canvasWidth, canvasHeight);
      
      // Рисуем увеличенную область
      magnifierCtx.drawImage(
        previewCanvas,
        canvasMouseX - sourceWidth / 2, // source x
        canvasMouseY - sourceHeight / 2, // source y
        sourceWidth, // source width
        sourceHeight, // source height
        0, // dest x
        0, // dest y
        canvasWidth, // dest width
        canvasHeight  // dest height
      );
    });
  }
  // ============== END CANVAS MAGNIFIER ==============
});
</script>

</body>
</html>
