# –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è: –≠–∫—Å–ø–æ—Ä—Ç –£–ü–î –≤ Excel

**–î–∞—Ç–∞**: 2026-01-29  
**–í–µ—Ä—Å–∏—è**: 1.0  
**–ê–≤—Ç–æ—Ä**: Architect Mode  
**–°—Ç–∞—Ç—É—Å**: –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## 1. –û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞

### 1.1 –¶–µ–ª—å
–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –£–ü–î (–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ü–µ—Ä–µ–¥–∞—Ç–æ—á–Ω—ã–π –î–æ–∫—É–º–µ–Ω—Ç) –≤ —Ñ–æ—Ä–º–∞—Ç Excel (.xls/.xlsx) –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.

### 1.2 –ö–æ–Ω—Ç–µ–∫—Å—Ç
- –î–æ–∫—É–º–µ–Ω—Ç—ã —É–∂–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `/documents/{document_id}/` —Å –≥–æ—Ç–æ–≤—ã–º HTML
- –®–∞–±–ª–æ–Ω `upd_template.html` —Å–æ–¥–µ—Ä–∂–∏—Ç Microsoft Office XML —Ç–µ–≥–∏
- –¢—Ä–µ–±—É–µ—Ç—Å—è backend API endpoint (—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∫–Ω–æ–ø–∫–∞ - —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø)
- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —á–µ—Ä–µ–∑ HTML, –Ω–µ —á–µ—Ä–µ–∑ PDF

### 1.3 –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
‚úÖ **–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ**:
- –≠–∫—Å–ø–æ—Ä—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –£–ü–î (—Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ = "upd")
- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –¥–æ–∫—É–º–µ–Ω—Ç–∞
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ: –≤—Å–µ –ø–æ–ª—è –¥–æ–ª–∂–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 14 –∫–æ–ª–æ–Ω–æ–∫ —Ç–æ–≤–∞—Ä–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–≥—Ä–∞–Ω–∏—Ü—ã, –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ, —Ä–∞–∑–º–µ—Ä—ã)
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–µ–π –∏ –ø–µ—á–∞—Ç–µ–π (base64 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)

‚ö†Ô∏è **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**:
- –¢–æ–ª—å–∫–æ backend —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª (–±–µ–∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞)
- –†–∞–±–æ—Ç–∞ —Ç–æ–ª—å–∫–æ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è Excel "–Ω–∞ –ª–µ—Ç—É" –∏–∑ —Ñ–æ—Ä–º—ã

---

## 2. –ê–Ω–∞–ª–∏–∑ –ø–æ–¥—Ö–æ–¥–æ–≤ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏

### 2.1 –í–∞—Ä–∏–∞–Ω—Ç 1: HTML —Å Content-Type "application/vnd.ms-excel" ‚Üí .xls

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã**:
- –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π HTML —Ñ–∞–π–ª —Å –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–º Content-Type
- Excel —Å–∞–º –ø–∞—Ä—Å–∏—Ç HTML –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∫–∞–∫ —Ç–∞–±–ª–∏—Ü—É

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (5-10 –º–∏–Ω—É—Ç)
- ‚úÖ –®–∞–±–ª–æ–Ω —É–∂–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω (xmlns:x, mso-–∞—Ç—Ä–∏–±—É—Ç—ã)
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä—Å–∏–Ω–≥ –∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (–£–ü–î, –ê–∫—Ç—ã, –°—á–µ—Ç–∞)

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏**:
- ‚ö†Ô∏è –§–æ—Ä–º–∞—Ç .xls (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç Excel 97-2003)
- ‚ö†Ô∏è –ú–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ (–ø–æ–¥–ø–∏—Å–∏/–ø–µ—á–∞—Ç–∏)
- ‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã –º–æ–≥—É—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

**–û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞**: 7/10

---

### 2.2 –í–∞—Ä–∏–∞–Ω—Ç 2: openpyxl –¥–ª—è .xlsx

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã**:
- –ü–∞—Ä—Å–∏–º `form_data.json` ‚Üí —Å–æ–∑–¥–∞–µ–º .xlsx —Ñ–∞–π–ª —á–µ—Ä–µ–∑ openpyxl
- –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã —Å —Ç–æ—á–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- ‚úÖ –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç .xlsx
- ‚úÖ –¢–æ—á–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- ‚úÖ –ù–∞–¥–µ–∂–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ (–ø–æ–¥–ø–∏—Å–∏/–ø–µ—á–∞—Ç–∏)
- ‚úÖ –ù–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏**:
- ‚ùå –í—ã—Å–æ–∫–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (2-3 –¥–Ω—è)
- ‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ—Å—Å–æ–∑–¥–∞—Ç—å —Ç–æ—á–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –£–ü–î (80+ –∫–æ–ª–æ–Ω–æ–∫, rowspan/colspan)
- ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—É–∂–µ –µ—Å—Ç—å –≤ HTML)
- ‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞

**–û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞**: 9/10

---

### 2.3 –í–∞—Ä–∏–∞–Ω—Ç 3: xlsxwriter

–ê–Ω–∞–ª–æ–≥–∏—á–µ–Ω openpyxl, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥—Ä—É–≥—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- –ü–æ—Ö–æ–∂–∏ –Ω–∞ openpyxl

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏**:
- –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ requirements.txt (—Ç—Ä–µ–±—É–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)
- –ù–µ—Ç –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤ –ø–µ—Ä–µ–¥ openpyxl

**–û—Ü–µ–Ω–∫–∞**: –ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è

---

## 3. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### 3.1 –í—ã–±–æ—Ä –ø–æ–¥—Ö–æ–¥–∞

**–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥** —Å –¥–≤—É–º—è —ç—Ç–∞–ø–∞–º–∏:

#### –≠—Ç–∞–ø 1 (MVP): HTML ‚Üí .xls —Å Content-Type
- –ë—ã—Å—Ç—Ä–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–∏–ø–æ—Ç–µ–∑—ã
- –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã

#### –≠—Ç–∞–ø 2 (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ): openpyxl ‚Üí .xlsx
- –†–µ–∞–ª–∏–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ–¥–æ–≤–æ–ª—å–Ω—ã –∫–∞—á–µ—Å—Ç–≤–æ–º
- –¢—Ä–µ–±—É–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ**:
1. –®–∞–±–ª–æ–Ω –£–ü–î —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ Office XML —Ç–µ–≥–∏
2. 80% –∑–∞–¥–∞—á–∏ —Ä–µ—à–∞–µ—Ç—Å—è –∑–∞ 10 –º–∏–Ω—É—Ç –≤–º–µ—Å—Ç–æ 3 –¥–Ω–µ–π
3. –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –±—ã—Å—Ç—Ä–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏
4. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –ø–æ–∑–∂–µ

---

## 4. –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API

### 4.1 Endpoint —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è

```
GET /api/v1/documents/{document_id}/export-excel
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `document_id` (path, required) - UUID –¥–æ–∫—É–º–µ–Ω—Ç–∞
- `format` (query, optional) - "xls" (default) –∏–ª–∏ "xlsx" (–¥–ª—è –±—É–¥—É—â–µ–≥–æ)

**–ó–∞–≥–æ–ª–æ–≤–∫–∏**:
- `Authorization: Bearer <token>` –∏–ª–∏ Cookie `access_token`

**–û—Ç–≤–µ—Ç—ã**:

**200 OK** - –£—Å–ø–µ—à–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è
```http
Content-Type: application/vnd.ms-excel
Content-Disposition: attachment; filename="UPD_125_20260118.xls"

<binary data>
```

**401 Unauthorized** - –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
```json
{
  "detail": "–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è"
}
```

**403 Forbidden** - –î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
```json
{
  "detail": "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω"
}
```

**404 Not Found** - –î–æ–∫—É–º–µ–Ω—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
```json
{
  "detail": "–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"
}
```

**422 Unprocessable Entity** - –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞
```json
{
  "detail": "–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –£–ü–î"
}
```

---

### 4.2 –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π)

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å query parameter –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ä–º–∞—Ç–∞:

```
GET /api/v1/documents/{document_id}/download?format=excel
GET /api/v1/documents/{document_id}/download?format=pdf
GET /api/v1/documents/{document_id}/download?format=html
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –≤—Å–µ—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
- –ü—Ä–æ—â–µ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å API

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏**:
- –ò–∑–º–µ–Ω—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
- –¢—Ä–µ–±—É–µ—Ç —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö endpoint'–æ–≤

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π endpoint `/export-excel`

---

## 5. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### 5.1 –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
backend/app/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îî‚îÄ‚îÄ documents.py              # –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª
‚îÇ       ‚îî‚îÄ‚îÄ [–î–û–ë–ê–í–ò–¢–¨] @router.get("/saved/{document_id}/export-excel")
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ excel_export.py           # [–ù–û–í–´–ô –§–ê–ô–õ] –°–µ—Ä–≤–∏—Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
‚îÇ       ‚îú‚îÄ‚îÄ export_document_to_excel()
‚îÇ       ‚îú‚îÄ‚îÄ _prepare_html_for_excel()
‚îÇ       ‚îú‚îÄ‚îÄ _get_excel_filename()
‚îÇ       ‚îî‚îÄ‚îÄ ExcelExportService (–∫–ª–∞—Å—Å)
‚îÇ
‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îî‚îÄ‚îÄ upd_template.html         # –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π —à–∞–±–ª–æ–Ω (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
‚îÇ
‚îî‚îÄ‚îÄ documents/                     # –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    ‚îî‚îÄ‚îÄ {document_id}/
        ‚îú‚îÄ‚îÄ metadata.json
        ‚îú‚îÄ‚îÄ form_data.json
        ‚îú‚îÄ‚îÄ document.html
        ‚îî‚îÄ‚îÄ document.pdf
```

---

### 5.2 –ü—Å–µ–≤–¥–æ–∫–æ–¥ –∫–ª—é—á–µ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π

#### 5.2.1 API Endpoint

```python
@router.get("/saved/{document_id}/export-excel")
async def export_document_to_excel(
    document_id: str,
    format: str = "xls",  # xls –∏–ª–∏ xlsx (–¥–ª—è –±—É–¥—É—â–µ–≥–æ)
    authorization: Optional[str] = Header(None),
    access_token: Optional[str] = Cookie(None),
    db: Session = Depends(get_db)
):
    """
    –≠–∫—Å–ø–æ—Ä—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ Excel
    
    Args:
        document_id: UUID –¥–æ–∫—É–º–µ–Ω—Ç–∞
        format: –§–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞ (xls/xlsx)
        authorization: Bearer token –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
        access_token: Token –∏–∑ cookie
        db: –°–µ—Å—Å–∏—è –ë–î
    
    Returns:
        StreamingResponse: Excel —Ñ–∞–π–ª
    
    Raises:
        HTTPException: 401/403/404/422
    """
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    user_id = get_user_id_from_token(authorization, access_token)
    if not user_id:
        raise HTTPException(401, "–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è")
    
    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞
    doc_folder = DOCUMENTS_DIR / document_id
    if not doc_folder.exists():
        raise HTTPException(404, "–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    # 3. –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
    metadata = load_metadata(doc_folder)
    
    # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞
    if metadata.get('user_id') != user_id:
        raise HTTPException(403, "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
    
    # 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (—Ç–æ–ª—å–∫–æ –£–ü–î)
    if metadata.get('type') != 'upd':
        raise HTTPException(422, "–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –£–ü–î")
    
    # 6. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ Excel
    excel_service = ExcelExportService()
    excel_buffer = excel_service.export_to_excel(
        doc_folder=doc_folder,
        metadata=metadata,
        format=format
    )
    
    # 7. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
    filename = get_excel_filename(metadata)
    
    # 8. –í–æ–∑–≤—Ä–∞—Ç —Ñ–∞–π–ª–∞
    return StreamingResponse(
        excel_buffer,
        media_type="application/vnd.ms-excel",
        headers={
            "Content-Disposition": f'attachment; filename="{filename}"'
        }
    )
```

---

#### 5.2.2 –°–µ—Ä–≤–∏—Å ExcelExportService (–≠—Ç–∞–ø 1 - MVP)

```python
# backend/app/services/excel_export.py

import io
from pathlib import Path
from typing import Dict, BinaryIO
from fastapi import HTTPException

class ExcelExportService:
    """–°–µ—Ä–≤–∏—Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ Excel"""
    
    def export_to_excel(
        self,
        doc_folder: Path,
        metadata: Dict,
        format: str = "xls"
    ) -> BinaryIO:
        """
        –≠–∫—Å–ø–æ—Ä—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ Excel
        
        Args:
            doc_folder: –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
            metadata: –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
            format: –§–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞ (xls/xlsx)
        
        Returns:
            BytesIO —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º Excel —Ñ–∞–π–ª–∞
        """
        if format == "xls":
            return self._export_html_as_xls(doc_folder)
        elif format == "xlsx":
            # –î–ª—è –±—É–¥—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ openpyxl
            raise HTTPException(501, "–§–æ—Ä–º–∞—Ç .xlsx –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è")
        else:
            raise HTTPException(400, f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: {format}")
    
    def _export_html_as_xls(self, doc_folder: Path) -> BinaryIO:
        """
        –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è HTML –≤ XLS (Excel 97-2003)
        
        –ü—Ä–∏–Ω—Ü–∏–ø: –ß–∏—Ç–∞–µ–º –≥–æ—Ç–æ–≤—ã–π HTML –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ –∫–∞–∫ .xls
        Excel –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∞—Ä—Å–∏—Ç HTML –±–ª–∞–≥–æ–¥–∞—Ä—è Office XML —Ç–µ–≥–∞–º
        """
        html_path = doc_folder / "document.html"
        
        if not html_path.exists():
            raise HTTPException(404, "HTML —Ñ–∞–π–ª –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω")
        
        # –ß–∏—Ç–∞–µ–º HTML
        html_content = html_path.read_text(encoding='utf-8')
        
        # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ Excel-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ç–µ–≥–∏
        html_content = self._enhance_html_for_excel(html_content)
        
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ BytesIO
        buffer = io.BytesIO()
        buffer.write(html_content.encode('utf-8'))
        buffer.seek(0)
        
        return buffer
    
    def _enhance_html_for_excel(self, html_content: str) -> str:
        """
        –£–ª—É—á—à–µ–Ω–∏–µ HTML –¥–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Excel
        
        –î–æ–±–∞–≤–ª—è–µ—Ç/–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç —Ç–µ–≥–∏ –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        """
        # –£–±–∏—Ä–∞–µ–º –Ω–µ–Ω—É–∂–Ω—ã–µ –¥–ª—è Excel —ç–ª–µ–º–µ–Ω—Ç—ã
        # (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ mso-—Ç–µ–≥–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        
        return html_content
    
    def get_excel_filename(self, metadata: Dict) -> str:
        """
        –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –¥–ª—è Excel
        
        Args:
            metadata: –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        
        Returns:
            –ò–º—è —Ñ–∞–π–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "UPD_125_20260118.xls")
        """
        doc_type = metadata.get('type', 'document').upper()
        doc_number = metadata.get('document_number', '0')
        doc_date = metadata.get('document_date', '').replace('-', '')
        
        return f"{doc_type}_{doc_number}_{doc_date}.xls"
```

---

#### 5.2.3 –°–µ—Ä–≤–∏—Å ExcelExportService (–≠—Ç–∞–ø 2 - openpyxl, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```python
# –î–ª—è –±—É–¥—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ openpyxl

def _export_as_xlsx(self, doc_folder: Path, metadata: Dict) -> BinaryIO:
    """
    –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ –Ω–∞—Å—Ç–æ—è—â–∏–π XLSX —á–µ—Ä–µ–∑ openpyxl
    
    –¢—Ä–µ–±—É–µ—Ç:
    1. –ü–∞—Ä—Å–∏–Ω–≥ form_data.json
    2. –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü—ã
    3. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —è—á–µ–µ–∫
    4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–ø–æ–¥–ø–∏—Å–∏, –ø–µ—á–∞—Ç–∏)
    """
    from openpyxl import Workbook
    from openpyxl.styles import Font, Border, Alignment, PatternFill
    from openpyxl.utils import get_column_letter
    
    # 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    form_data = load_form_data(doc_folder)
    
    # 2. –°–æ–∑–¥–∞–Ω–∏–µ workbook
    wb = Workbook()
    ws = wb.active
    ws.title = "–£–ü–î"
    
    # 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ –∫–æ–ª–æ–Ω–æ–∫ (80+ –∫–æ–ª–æ–Ω–æ–∫ –∏–∑ —à–∞–±–ª–æ–Ω–∞)
    column_widths = [5, 3, 40, 14, 5, ...]  # –ò–∑ upd_template.html
    for i, width in enumerate(column_widths, start=1):
        ws.column_dimensions[get_column_letter(i)].width = width / 7
    
    # 4. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
    # –°—Ç—Ä–æ–∫–∞ 1-2: "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–¥–∞—Ç–æ—á–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç"
    ws.merge_cells('B1:E3')
    ws['B1'] = '–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π\n–ø–µ—Ä–µ–¥–∞—Ç–æ—á–Ω—ã–π\n–¥–æ–∫—É–º–µ–Ω—Ç'
    ws['B1'].alignment = Alignment(wrap_text=True)
    
    # –°—Ç—Ä–æ–∫–∞ 1: –°—á–µ—Ç-—Ñ–∞–∫—Ç—É—Ä–∞ ‚Ññ
    ws.merge_cells('F1:P1')
    ws['F1'] = f'–°—á—ë—Ç-—Ñ–∞–∫—Ç—É—Ä–∞ ‚Ññ {form_data["document_number"]}'
    
    # ... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏
    
    # 5. –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤
    header_row = 11  # –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –Ω–∞—á–∞–ª–∞ —Ç–∞–±–ª–∏—Ü—ã
    
    # –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–ª–æ–Ω–æ–∫
    headers = ['‚Ññ\n–ø/–ø', '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞...', ...]
    for col, header in enumerate(headers, start=1):
        cell = ws.cell(header_row, col, header)
        cell.border = Border(...)
        cell.alignment = Alignment(...)
    
    # –î–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–æ–≤
    for idx, item in enumerate(form_data['items'], start=1):
        row = header_row + idx
        ws.cell(row, 1, idx)
        ws.cell(row, 2, item['name'])
        ws.cell(row, 3, item['quantity'])
        # ... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ
    
    # 6. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–ø–æ–¥–ø–∏—Å–∏, –ø–µ—á–∞—Ç–∏)
    if form_data.get('seller_stamp_image'):
        img_data = base64.b64decode(seller_stamp_image.split(',')[1])
        img = Image(io.BytesIO(img_data))
        ws.add_image(img, 'A50')  # –ü—Ä–∏–º–µ—Ä–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
    
    # 7. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ BytesIO
    buffer = io.BytesIO()
    wb.save(buffer)
    buffer.seek(0)
    
    return buffer
```

---

## 6. –ü–ª–∞–Ω —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

### 6.1 –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

```python
# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

class ExcelExportService:
    
    SUPPORTED_TYPES = ['upd', 'akt', 'invoice']
    
    def export_to_excel(self, doc_folder, metadata, format="xls"):
        doc_type = metadata.get('type')
        
        if doc_type not in self.SUPPORTED_TYPES:
            raise HTTPException(422, f"–≠–∫—Å–ø–æ—Ä—Ç —Ç–∏–ø–∞ {doc_type} –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è")
        
        # –ï–¥–∏–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ (HTML –ø–æ–¥—Ö–æ–¥)
        return self._export_html_as_xls(doc_folder)
```

### 6.2 –í—ã–±–æ—Ä —Ñ–æ—Ä–º–∞—Ç–∞ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ

–ë—É–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–∫–æ–≥–¥–∞ –±—É–¥–µ—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥):

```html
<!-- Dropdown –≤ —Ç–∞–±–ª–∏—Ü–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ -->
<div class="dropdown">
  <button>–°–∫–∞—á–∞—Ç—å</button>
  <ul>
    <li><a href="/api/v1/documents/{id}/saved/{id}/pdf">PDF</a></li>
    <li><a href="/api/v1/documents/saved/{id}/export-excel?format=xls">Excel (XLS)</a></li>
    <li><a href="/api/v1/documents/saved/{id}/export-excel?format=xlsx">Excel (XLSX)</a></li>
  </ul>
</div>
```

---

## 7. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è

### 7.1 –ü—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

```python
def validate_export_request(user_id: int, document_id: str, db: Session):
    """
    –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —ç–∫—Å–ø–æ—Ä—Ç
    
    –ü—Ä–æ–≤–µ—Ä–∫–∏:
    1. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
    2. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    3. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –≤–ª–∞–¥–µ–ª–µ—Ü –¥–æ–∫—É–º–µ–Ω—Ç–∞
    4. ‚úÖ –¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
    5. ‚úÖ HTML —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –¥–æ—Å—Ç—É–ø–µ–Ω
    """
    
    # 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (—É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ –≤ get_user_id_from_token)
    
    # 2. –°—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
    doc_folder = DOCUMENTS_DIR / document_id
    if not doc_folder.exists():
        raise HTTPException(404, "–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞
    metadata = load_metadata(doc_folder)
    if metadata.get('user_id') != user_id:
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–∫–∏ –¥–æ—Å—Ç—É–ø–∞
        logger.warning(f"User {user_id} tried to access document {document_id} (owner: {metadata.get('user_id')})")
        raise HTTPException(403, "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
    
    # 4. –¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞
    if metadata.get('type') not in SUPPORTED_TYPES:
        raise HTTPException(422, f"–≠–∫—Å–ø–æ—Ä—Ç —Ç–∏–ø–∞ {metadata.get('type')} –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è")
    
    # 5. –ù–∞–ª–∏—á–∏–µ HTML —Ñ–∞–π–ª–∞
    html_path = doc_folder / "document.html"
    if not html_path.exists():
        logger.error(f"HTML file missing for document {document_id}")
        raise HTTPException(500, "HTML —Ñ–∞–π–ª –¥–æ–∫—É–º–µ–Ω—Ç–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
    
    return metadata
```

### 7.2 –õ–∏–º–∏—Ç—ã –∏ –∫–≤–æ—Ç—ã

```python
# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ

async def check_download_limits(user: User, db: Session):
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
    (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–∫—Å–ø–æ—Ä—Ç–æ–≤)
    """
    
    # –ù–∞–ø—Ä–∏–º–µ—Ä: –Ω–µ –±–æ–ª–µ–µ 100 —ç–∫—Å–ø–æ—Ä—Ç–æ–≤ –≤ –¥–µ–Ω—å –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞
    if user.subscription_plan == 'free':
        today_exports = count_exports_today(user.id, db)
        if today_exports >= 100:
            raise HTTPException(429, "–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —Å–∫–∞—á–∏–≤–∞–Ω–∏–π")
```

---

## 8. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 8.1 Unit-—Ç–µ—Å—Ç—ã

```python
# tests/test_excel_export.py

import pytest
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

class TestExcelExport:
    
    def test_export_success(self, auth_token, sample_upd_id):
        """–£—Å–ø–µ—à–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç –£–ü–î –≤ Excel"""
        response = client.get(
            f"/api/v1/documents/saved/{sample_upd_id}/export-excel",
            headers={"Authorization": f"Bearer {auth_token}"}
        )
        
        assert response.status_code == 200
        assert response.headers['content-type'] == 'application/vnd.ms-excel'
        assert 'UPD_' in response.headers['content-disposition']
    
    def test_export_unauthorized(self, sample_upd_id):
        """–≠–∫—Å–ø–æ—Ä—Ç –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401"""
        response = client.get(
            f"/api/v1/documents/saved/{sample_upd_id}/export-excel"
        )
        
        assert response.status_code == 401
    
    def test_export_wrong_owner(self, auth_token, other_user_upd_id):
        """–≠–∫—Å–ø–æ—Ä—Ç —á—É–∂–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 403"""
        response = client.get(
            f"/api/v1/documents/saved/{other_user_upd_id}/export-excel",
            headers={"Authorization": f"Bearer {auth_token}"}
        )
        
        assert response.status_code == 403
    
    def test_export_not_found(self, auth_token):
        """–≠–∫—Å–ø–æ—Ä—Ç –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 404"""
        response = client.get(
            "/api/v1/documents/saved/nonexistent-id/export-excel",
            headers={"Authorization": f"Bearer {auth_token}"}
        )
        
        assert response.status_code == 404
    
    def test_export_wrong_type(self, auth_token, sample_invoice_id):
        """–≠–∫—Å–ø–æ—Ä—Ç –Ω–µ-–£–ü–î –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 422"""
        response = client.get(
            f"/api/v1/documents/saved/{sample_invoice_id}/export-excel",
            headers={"Authorization": f"Bearer {auth_token}"}
        )
        
        assert response.status_code == 422
    
    def test_exported_file_structure(self, auth_token, sample_upd_id):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞"""
        response = client.get(
            f"/api/v1/documents/saved/{sample_upd_id}/export-excel",
            headers={"Authorization": f"Bearer {auth_token}"}
        )
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ Excel
        temp_file = "test_output.xls"
        with open(temp_file, 'wb') as f:
            f.write(response.content)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å
        # (—Ç—Ä–µ–±—É–µ—Ç Excel –∏–ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫—É xlrd)
```

### 8.2 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

```python
class TestExcelExportIntegration:
    
    def test_full_workflow(self, client, test_user):
        """–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª: —Å–æ–∑–¥–∞–Ω–∏–µ –£–ü–î ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Üí —ç–∫—Å–ø–æ—Ä—Ç –≤ Excel"""
        
        # 1. –°–æ–∑–¥–∞–µ–º –£–ü–î
        upd_data = {...}  # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        create_response = client.post(
            "/api/v1/documents/upd/save",
            json=upd_data,
            headers={"Authorization": f"Bearer {test_user.token}"}
        )
        
        document_id = create_response.json()['document_id']
        
        # 2. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ Excel
        export_response = client.get(
            f"/api/v1/documents/saved/{document_id}/export-excel",
            headers={"Authorization": f"Bearer {test_user.token}"}
        )
        
        assert export_response.status_code == 200
        
        # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        content = export_response.content.decode('utf-8')
        assert upd_data['seller']['name'] in content
        assert upd_data['buyer']['name'] in content
        assert str(upd_data['document_number']) in content
```

### 8.3 –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ß–µ–∫-–ª–∏—Å—Ç —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**:

- [ ] –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ Excel –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] –í—Å–µ –∫–æ–ª–æ–Ω–∫–∏ –∏–º–µ—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
- [ ] –ì—Ä–∞–Ω–∏—Ü—ã —Ç–∞–±–ª–∏—Ü –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- [ ] –¢–µ–∫—Å—Ç –Ω–µ –æ–±—Ä–µ–∑–∞–µ—Ç—Å—è –≤ —è—á–µ–π–∫–∞—Ö
- [ ] –ß–∏—Å–ª–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É—é—Ç—Å—è –∫–∞–∫ —á–∏—Å–ª–∞ (–Ω–µ –∫–∞–∫ —Ç–µ–∫—Å—Ç)
- [ ] –ü–æ–¥–ø–∏—Å–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è)
- [ ] –ü–µ—á–∞—Ç–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è)
- [ ] –†—É—Å—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (UTF-8)
- [ ] –§–∞–π–ª –º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ Excel
- [ ] –§–∞–π–ª –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ .xlsx –∏–∑ Excel

---

## 9. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### 9.1 –¢–∏–ø—ã –æ—à–∏–±–æ–∫

```python
class ExcelExportError(Exception):
    """–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –æ—à–∏–±–æ–∫ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel"""
    pass

class DocumentHTMLNotFoundError(ExcelExportError):
    """HTML —Ñ–∞–π–ª –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω"""
    pass

class UnsupportedDocumentTypeError(ExcelExportError):
    """–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞"""
    pass
```

### 9.2 –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
from loguru import logger

@router.get("/saved/{document_id}/export-excel")
async def export_document_to_excel(...):
    logger.info(f"Excel export requested: document_id={document_id}, user_id={user_id}")
    
    try:
        # ... –ª–æ–≥–∏–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞
        
        logger.success(f"Excel export completed: document_id={document_id}")
        return response
        
    except HTTPException as e:
        logger.warning(f"Excel export failed: {e.detail}, document_id={document_id}")
        raise
        
    except Exception as e:
        logger.error(f"Unexpected error in Excel export: {str(e)}, document_id={document_id}")
        raise HTTPException(500, "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞")
```

---

## 10. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### 10.1 –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
```python
# –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö Excel —Ñ–∞–π–ª–æ–≤
@lru_cache(maxsize=100)
def get_cached_excel(document_id: str, version: int):
    """
    –ö—ç—à –¥–ª—è —á–∞—Å—Ç–æ —Å–∫–∞—á–∏–≤–∞–µ–º—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    version = timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    """
    pass
```

2. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è** (–¥–ª—è openpyxl):
```python
import asyncio

async def generate_excel_async(doc_folder, metadata):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–ª—è —Ç—è–∂–µ–ª—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π"""
    loop = asyncio.get_event_loop()
    return await loop.run_in_executor(
        None,
        generate_excel_sync,
        doc_folder,
        metadata
    )
```

3. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤**:
```python
MAX_ITEMS_FOR_EXCEL = 1000  # –ú–∞–∫—Å–∏–º—É–º —Ç–æ–≤–∞—Ä–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ

if len(items) > MAX_ITEMS_FOR_EXCEL:
    raise HTTPException(422, f"–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç {len(items)} —Ç–æ–≤–∞—Ä–æ–≤. –ú–∞–∫—Å–∏–º—É–º: {MAX_ITEMS_FOR_EXCEL}")
```

### 10.2 –ú–µ—Ç—Ä–∏–∫–∏

```python
import time

@router.get("/saved/{document_id}/export-excel")
async def export_document_to_excel(...):
    start_time = time.time()
    
    # ... —ç–∫—Å–ø–æ—Ä—Ç
    
    duration = time.time() - start_time
    logger.info(f"Excel export duration: {duration:.2f}s, document_id={document_id}")
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ—Ç—Ä–∏–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å —Å–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞)
    # metrics.record('excel_export_duration', duration)
```

---

## 11. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API

### 11.1 OpenAPI/Swagger

```python
@router.get(
    "/saved/{document_id}/export-excel",
    summary="–≠–∫—Å–ø–æ—Ä—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ Excel",
    description="""
    –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –≤ —Ñ–æ—Ä–º–∞—Ç Excel (.xls –∏–ª–∏ .xlsx).
    
    **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:**
    - –£–ü–î (–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ü–µ—Ä–µ–¥–∞—Ç–æ—á–Ω—ã–π –î–æ–∫—É–º–µ–Ω—Ç)
    
    **–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
    - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
    - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞
    
    **–§–æ—Ä–º–∞—Ç—ã:**
    - `xls` - Excel 97-2003 (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, —á–µ—Ä–µ–∑ HTML)
    - `xlsx` - Excel 2007+ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —á–µ—Ä–µ–∑ openpyxl)
    """,
    responses={
        200: {
            "description": "–£—Å–ø–µ—à–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç",
            "content": {
                "application/vnd.ms-excel": {
                    "schema": {"type": "string", "format": "binary"}
                }
            }
        },
        401: {"description": "–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω"},
        403: {"description": "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω"},
        404: {"description": "–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"},
        422: {"description": "–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞"}
    },
    tags=["Documents"]
)
async def export_document_to_excel(...):
    pass
```

---

## 12. –ú–∏–≥—Ä–∞—Ü–∏—è –∏ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

### 12.1 –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ API

–ï—Å–ª–∏ –≤ –±—É–¥—É—â–µ–º –∏–∑–º–µ–Ω–∏—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç:

```python
# v1: HTML ‚Üí XLS
GET /api/v1/documents/saved/{id}/export-excel

# v2: openpyxl ‚Üí XLSX (–≤ –±—É–¥—É—â–µ–º)
GET /api/v2/documents/saved/{id}/export-excel
```

### 12.2 Feature Flags

```python
# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

FEATURES = {
    'excel_export_enabled': True,
    'xlsx_format_enabled': False,  # –í–∫–ª—é—á–∏–º –∫–æ–≥–¥–∞ —Ä–µ–∞–ª–∏–∑—É–µ–º openpyxl
}

@router.get("/saved/{document_id}/export-excel")
async def export_document_to_excel(...):
    if not FEATURES['excel_export_enabled']:
        raise HTTPException(503, "–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
    
    if format == 'xlsx' and not FEATURES['xlsx_format_enabled']:
        raise HTTPException(501, "–§–æ—Ä–º–∞—Ç XLSX –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è")
```

---

## 13. –û—Ü–µ–Ω–∫–∞ —Ç—Ä—É–¥–æ–µ–º–∫–æ—Å—Ç–∏

### 13.1 –≠—Ç–∞–ø 1 (MVP - HTML ‚Üí XLS)

| –ó–∞–¥–∞—á–∞ | –û—Ü–µ–Ω–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|--------|----------|
| –°–æ–∑–¥–∞–Ω–∏–µ endpoint | 30 –º–∏–Ω | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ route –≤ `documents.py` |
| –°–æ–∑–¥–∞–Ω–∏–µ ExcelExportService | 30 –º–∏–Ω | –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å —Å –º–µ—Ç–æ–¥–æ–º `_export_html_as_xls` |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è | 30 –º–∏–Ω | –ü—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, —Ç–∏–ø–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ |
| –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä—É—á–Ω—É—é | 30 –º–∏–Ω | –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ Excel, –æ—Ç–ª–∞–¥–∫–∞ |
| Unit-—Ç–µ—Å—Ç—ã | 1 —á–∞—Å | –ë–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã |
| –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è | 30 –º–∏–Ω | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, docstrings |
| **–ò–¢–û–ì–û** | **3-4 —á–∞—Å–∞** | –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∏–π MVP |

### 13.2 –≠—Ç–∞–ø 2 (openpyxl ‚Üí XLSX, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

| –ó–∞–¥–∞—á–∞ | –û—Ü–µ–Ω–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|--------|----------|
| –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –£–ü–î | 2 —á–∞—Å–∞ | –î–µ—Ç–∞–ª—å–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ 80+ –∫–æ–ª–æ–Ω–æ–∫, rowspan/colspan |
| –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ XLSX | 1-2 –¥–Ω—è | –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ |
| –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π | 4 —á–∞—Å–∞ | –ü–æ–¥–ø–∏—Å–∏, –ø–µ—á–∞—Ç–∏ –∏–∑ base64 |
| –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | 4 —á–∞—Å–∞ | –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ |
| **–ò–¢–û–ì–û** | **2-3 –¥–Ω—è** | –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π XLSX —ç–∫—Å–ø–æ—Ä—Ç |

### 13.3 –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –Ω–∞ –¥—Ä—É–≥–∏–µ —Ç–∏–ø—ã (–ê–∫—Ç—ã, –°—á–µ—Ç–∞)

| –ó–∞–¥–∞—á–∞ | –û—Ü–µ–Ω–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|--------|----------|
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ê–∫—Ç–æ–≤ | 1 —á–∞—Å | –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –£–ü–î (HTML –ø–æ–¥—Ö–æ–¥) |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –°—á–µ—Ç–æ–≤ | 1 —á–∞—Å | –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –£–ü–î (HTML –ø–æ–¥—Ö–æ–¥) |
| –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | 2 —á–∞—Å–∞ | –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ |
| **–ò–¢–û–ì–û** | **4 —á–∞—Å–∞** | –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ |

---

## 14. –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è

| –†–∏—Å–∫ | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å | –í–ª–∏—è–Ω–∏–µ | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|-------------|---------|-----------|
| Excel –Ω–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–∞—Ä—Å–∏—Ç HTML | –°—Ä–µ–¥–Ω—è—è | –í—ã—Å–æ–∫–æ–µ | –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö; fallback –Ω–∞ openpyxl |
| –ü—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π (UTF-8) | –ù–∏–∑–∫–∞—è | –°—Ä–µ–¥–Ω–µ–µ | –Ø–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ encoding='utf-8' |
| –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è | –í—ã—Å–æ–∫–∞—è | –°—Ä–µ–¥–Ω–µ–µ | –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ –∏–∑–≤–µ—Å—Ç–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ XLS —Ñ–æ—Ä–º–∞—Ç–∞ |
| –ë–æ–ª—å—à–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã (1000+ —Ç–æ–≤–∞—Ä–æ–≤) | –ù–∏–∑–∫–∞—è | –°—Ä–µ–¥–Ω–µ–µ | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ —Ä–∞–∑–º–µ—Ä; –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é |
| Excel –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ | –í—ã—Å–æ–∫–∞—è | –ù–∏–∑–∫–æ–µ | –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å; –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å XLSX –≤ –±—É–¥—É—â–µ–º |

---

## 15. –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### 15.1 –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ (1-2 –Ω–µ–¥–µ–ª–∏)

1. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≠—Ç–∞–ø 1 (MVP - HTML ‚Üí XLS)
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å unit-—Ç–µ—Å—Ç—ã
3. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –£–ü–î
4. ‚úÖ –°–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### 15.2 –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–µ (1-2 –º–µ—Å—è—Ü–∞)

1. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –ê–∫—Ç–æ–≤ –∏ –°—á–µ—Ç–æ–≤
2. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∫–Ω–æ–ø–∫—É "–°–∫–∞—á–∞—Ç—å Excel"
3. ‚è≥ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
4. ‚è≥ –†–µ—à–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ XLSX —Ñ–æ—Ä–º–∞—Ç–∞

### 15.3 –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ (3+ –º–µ—Å—è—Ü–∞)

1. üîÆ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è openpyxl ‚Üí XLSX (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
2. üîÆ –ü–∞–∫–µ—Ç–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç (–Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –æ–¥–∏–Ω Excel)
3. üîÆ –≠–∫—Å–ø–æ—Ä—Ç –≤ Google Sheets
4. üîÆ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤ Excel –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

---

## 16. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

### 16.1 –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

**–ù–∞—á–∞—Ç—å —Å –≠—Ç–∞–ø–∞ 1** (HTML ‚Üí XLS):
- ‚úÖ –ë—ã—Å—Ç—Ä–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (3-4 —á–∞—Å–∞)
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏
- ‚úÖ –®–∞–±–ª–æ–Ω —É–∂–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω

**–ü–µ—Ä–µ–π—Ç–∏ –∫ –≠—Ç–∞–ø—É 2** (openpyxl ‚Üí XLSX) —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∂–∞–ª—É—é—Ç—Å—è –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ XLS
- ‚ùå –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã
- ‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç XLSX

### 16.2 –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

–ü—Ä–æ–µ–∫—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω—ã–º, –µ—Å–ª–∏:

1. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —Å–∫–∞—á–∞—Ç—å –£–ü–î –≤ Excel –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º
2. ‚úÖ –§–∞–π–ª –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ Excel –±–µ–∑ –æ—à–∏–±–æ–∫
3. ‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ (–ø—Ä–æ–¥–∞–≤–µ—Ü, –ø–æ–∫—É–ø–∞—Ç–µ–ª—å, —Ç–æ–≤–∞—Ä—ã, –∏—Ç–æ–≥–∏) –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
4. ‚úÖ –§–∞–π–ª –º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ Excel
5. ‚úÖ –ù–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∂–∞–ª–æ–± –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ

### 16.3 –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: > 30% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É—é—Ç —ç–∫—Å–ø–æ—Ä—Ç –≤ Excel
- **–ö–∞—á–µ—Å—Ç–≤–æ**: < 5% –∂–∞–ª–æ–± –Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è < 2 —Å–µ–∫—É–Ω–¥ –¥–ª—è —Ç–∏–ø–∏—á–Ω–æ–≥–æ –£–ü–î
- **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: 99.9% —É—Å–ø–µ—à–Ω—ã—Ö —ç–∫—Å–ø–æ—Ä—Ç–æ–≤

---

## –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ A: –ü—Ä–∏–º–µ—Ä HTTP –∑–∞–ø—Ä–æ—Å–∞

```bash
# –≠–∫—Å–ø–æ—Ä—Ç –£–ü–î –≤ Excel
curl -X GET \
  'https://documatica.ru/api/v1/documents/saved/550e8400-e29b-41d4-a716-446655440000/export-excel' \
  -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIs...' \
  --output upd.xls

# –≠–∫—Å–ø–æ—Ä—Ç —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ñ–æ—Ä–º–∞—Ç–∞
curl -X GET \
  'https://documatica.ru/api/v1/documents/saved/550e8400-e29b-41d4-a716-446655440000/export-excel?format=xls' \
  -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIs...' \
  --output upd.xls
```

### –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ B: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "type": "upd",
  "user_id": 42,
  "document_number": "125",
  "document_date": "2026-01-18",
  "created_at": "2026-01-18T10:30:00",
  "seller_name": "–û–û–û \"–†–æ–º–∞—à–∫–∞\"",
  "buyer_name": "–û–û–û \"–í–∞—Å–∏–ª–µ–∫\"",
  "total_amount": 80000.00,
  "status": "1"
}
```

### –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ C: –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**Backend**:
- [ ] –°–æ–∑–¥–∞—Ç—å `backend/app/services/excel_export.py`
- [ ] –î–æ–±–∞–≤–∏—Ç—å endpoint –≤ `backend/app/api/documents.py`
- [ ] –î–æ–±–∞–≤–∏—Ç—å unit-—Ç–µ—Å—Ç—ã –≤ `tests/test_excel_export.py`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é API
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**:
- [ ] Unit-—Ç–µ—Å—Ç—ã (100% –ø–æ–∫—Ä—ã—Ç–∏–µ)
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
- [ ] –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Excel
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –≤–µ—Ä—Å–∏—è—Ö Excel (2016, 2019, 2021, 365)
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ LibreOffice Calc

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**:
- [ ] Swagger/OpenAPI –æ–ø–∏—Å–∞–Ω–∏–µ
- [ ] README —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

**–ö–æ–Ω–µ—Ü —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏**

**–í–µ—Ä—Å–∏—è**: 1.0  
**–î–∞—Ç–∞**: 2026-01-29  
**–°—Ç–∞—Ç—É—Å**: –ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ ‚úÖ
