"""
{{PROJECT_TITLE}} Backend - FastAPI Application
"""

from pathlib import Path
from fastapi import FastAPI, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles
from fastapi.responses import HTMLResponse
from fastapi.templating import Jinja2Templates
from starlette.exceptions import HTTPException as StarletteHTTPException
from starlette.middleware.base import BaseHTTPMiddleware

from app.api import auth, payment, billing
from app.pages import router as pages_router
from app.dashboard import router as dashboard_router
from app.admin import router as admin_router
from app.database import init_db

# Paths
STATIC_DIR = Path(__file__).parent / "static"
TEMPLATES_DIR = Path(__file__).parent / "templates"
error_templates = Jinja2Templates(directory=str(TEMPLATES_DIR))

app = FastAPI(
    title="{{PROJECT_TITLE}} API",
    description="{{DESCRIPTION}}",
    version="1.0.0",
    docs_url="/docs",
    redoc_url="/redoc"
)

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


# Cache Control Middleware
class CacheControlMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request, call_next):
        response = await call_next(request)
        path = request.url.path
        
        if path.startswith("/static/") and "?v=" in str(request.url):
            response.headers["Cache-Control"] = "public, max-age=31536000, immutable"
        elif path.startswith("/static/"):
            response.headers["Cache-Control"] = "public, max-age=3600"
        elif not path.startswith("/api/"):
            response.headers["Cache-Control"] = "no-cache, no-store, must-revalidate"
        
        return response


app.add_middleware(CacheControlMiddleware)

# Static files
app.mount("/static", StaticFiles(directory=str(STATIC_DIR)), name="static")


# 404 Handler
@app.exception_handler(StarletteHTTPException)
async def custom_http_exception_handler(request: Request, exc: StarletteHTTPException):
    if exc.status_code == 404:
        return error_templates.TemplateResponse(
            "errors/404.html",
            {"request": request},
            status_code=404
        )
    return HTMLResponse(
        content=f"<h1>Error {exc.status_code}</h1><p>{exc.detail}</p>",
        status_code=exc.status_code
    )


# API Routers
app.include_router(auth.router, prefix="/api/v1", tags=["auth"])
app.include_router(payment.router, prefix="/api/v1", tags=["payment"])
app.include_router(billing.router, prefix="/api/v1", tags=["billing"])

# Page Routers
app.include_router(pages_router)
app.include_router(dashboard_router, prefix="/dashboard")
app.include_router(admin_router, prefix="/admin")


@app.on_event("startup")
async def startup():
    init_db()


@app.get("/health")
async def health_check():
    return {"status": "ok", "service": "{{PROJECT_NAME}}"}
